<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Phần mềm Quản lý Sửa chữa - PHIÊN BẢN CŨ (ĐÃ THÊM TÍNH NĂNG XUẤT FILE)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- BIỂU TƯỢNG (ICONS) ---
        const PlusIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" /></svg>;
        const RepairIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>;
        const CustomerIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>;
        const InventoryIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" /></svg>;
        const ReportIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>;
        const CloseIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>;
        const SearchIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clipRule="evenodd" /></svg>;
        const HistoryIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>;
        const EditIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.536l12.232-12.232z" /></svg>;
        const DeleteIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>;
        const WarningIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 text-yellow-500" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.21 3.03-1.742 3.03H4.42c-1.532 0-2.492-1.696-1.742-3.03l5.58-9.92zM10 13a1 1 0 110-2 1 1 0 010 2zm-1-8a1 1 0 00-1 1v3a1 1 0 102 0V6a1 1 0 00-1-1z" clipRule="evenodd" /></svg>;
        const ServiceIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>;
        const InvoiceIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>;
        const WarrantyIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 20.417l4.5-1.5a8.023 8.023 0 011.14-5.571 8.023 8.023 0 015.571-1.14l1.5-4.5z" /></svg>;
        const PrintIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H7a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm7-8V5a2 2 0 00-2-2H5a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-2" /></svg>;
        const DownloadIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>;
        const MenuIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h16" /></svg>;
        const LogoutIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>;
        const AuditLogIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg>;
        const UsersIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M15 21a6 6 0 00-9-5.197M15 12a4 4 0 110-8 4 4 0 010 8z" /></svg>;
        const TableIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>;
        const SuccessIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>;
        const ErrorIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>;

        // --- CẤU HÌNH FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyDhulXkeejEKhmdFYgEeXDGmhyb5tZYrwI",
            authDomain: "dien-tu-hung-ngoc.firebaseapp.com",
            projectId: "dien-tu-hung-ngoc",
            storageBucket: "dien-tu-hung-ngoc.appspot.com",
            messagingSenderId: "803794710284",
            appId: "1:803794710284:web:f2ecd59b4ce23e72a46329"
        };

        let app; let db; let auth;
        let isFirebaseInitialized = false;
        try { 
            if (firebaseConfig && firebaseConfig.apiKey && firebaseConfig.apiKey.startsWith("AIza")) {
                app = firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                auth = firebase.auth();
                isFirebaseInitialized = true;
            }
        } catch (e) { 
            console.error("Lỗi khởi tạo Firebase:", e); 
        }

        // --- CÁC HÀM HỖ TRỢ ---
        const capitalizeWords = (str) => {
            if (!str) return '';
            return str.toLowerCase().replace(/(^\w{1})|(\s+\w{1})/g, letter => letter.toUpperCase());
        };
        
        const formatNumber = (value) => {
            if (value === null || value === undefined || value === '') return '';
            const numberValue = parseInt(String(value).replace(/[^0-9]/g, ''), 10);
            if (isNaN(numberValue)) return '';
            return numberValue.toLocaleString('vi-VN');
        };

        const parseFormattedNumber = (value) => {
            if (typeof value === 'number') return value;
            if (!value) return 0;
            return parseFloat(String(value).replace(/\./g, '')) || 0;
        };
        
        const logAction = async (user, action, entity, details, entityId = '') => {
            if (!db || !user) {
                console.warn("logAction: DB hoặc User không tồn tại.");
                return;
            }
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            try {
                await db.collection(`artifacts/${appId}/public/data/audit_logs`).add({
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    userEmail: user.email,
                    action: action,
                    entity: entity,
                    entityId: entityId,
                    details: details
                });
            } catch (error) {
                console.error("Lỗi ghi nhật ký:", error);
            }
        };

        const printWithIframe = (elementToPrint) => {
            if (!elementToPrint) {
                console.error("Phần tử để in không tồn tại.");
                return;
            }
            let allStyles = "";
            const styleSheets = document.head.querySelectorAll('style, link[rel="stylesheet"]');
            styleSheets.forEach(sheet => {
                allStyles += sheet.outerHTML;
            });
            const iframe = document.createElement('iframe');
            iframe.style.position = 'absolute';
            iframe.style.width = '0';
            iframe.style.height = '0';
            iframe.style.border = 'none';
            iframe.style.top = '-9999px';
            iframe.style.left = '-9999px';
            document.body.appendChild(iframe);
            const iframeDoc = iframe.contentWindow.document;
            iframeDoc.open();
            iframeDoc.write('<!DOCTYPE html><html lang="vi"><head><title>In tài liệu</title>');
            iframeDoc.write(allStyles);
            iframeDoc.write(`
                <style>
                    body { margin: 1.5rem; }
                    @media print {
                        body { -webkit-print-color-adjust: exact !important; color-adjust: exact !important; }
                        .no-print { display: none !important; }
                        tr, .printable-item { page-break-inside: avoid; }
                    }
                </style>
            `);
            iframeDoc.write('</head><body>');
            iframeDoc.write(elementToPrint.innerHTML);
            iframeDoc.write('</body></html>');
            iframeDoc.close();
            iframe.onload = function() {
                setTimeout(function() {
                    iframe.contentWindow.focus(); 
                    iframe.contentWindow.print(); 
                    document.body.removeChild(iframe);
                }, 100); 
            };
        };

        // ** MỚI: HÀM XUẤT CSV ĐA NĂNG **
        function exportToCSV(data, filename) {
            if (data.length === 0) {
                alert("Không có dữ liệu để xuất.");
                return;
            }
            
            const headers = Object.keys(data[0]);
            const csvRows = [headers.join(',')]; // Dòng tiêu đề

            for (const row of data) {
                const values = headers.map(header => {
                    let cell = row[header] === null || row[header] === undefined ? '' : row[header];
                    if (typeof cell === 'object' && cell instanceof firebase.firestore.Timestamp) {
                        cell = cell.toDate().toLocaleString('vi-VN');
                    }
                    const cellString = String(cell);
                    // Bọc giá trị trong dấu ngoặc kép và thoát các dấu ngoặc kép bên trong
                    const escaped = cellString.replace(/"/g, '""');
                    return `"${escaped}"`;
                });
                csvRows.push(values.join(','));
            }

            const blob = new Blob(["\uFEFF" + csvRows.join('\n')], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- CÁC THÀNH PHẦN GIAO DIỆN (UI COMPONENTS) ---
        const Toast = ({ message, type, onClose }) => {
            const [exiting, setExiting] = React.useState(false);
            React.useEffect(() => {
                const timer = setTimeout(() => {
                    setExiting(true);
                    setTimeout(onClose, 300);
                }, 4000);
                return () => clearTimeout(timer);
            }, [onClose]);

            const handleClose = () => {
                setExiting(true);
                setTimeout(onClose, 300);
            };

            const typeClasses = { success: 'bg-green-500 text-white', error: 'bg-red-500 text-white' };
            const icon = { success: <SuccessIcon />, error: <ErrorIcon /> };

            return (
                <div className={`flex items-center p-4 rounded-lg shadow-lg max-w-sm transition-all duration-300 ease-in-out transform ${typeClasses[type]} ${exiting ? 'opacity-0 translate-x-full' : 'opacity-100 translate-x-0'}`}>
                    <div className="mr-3">{icon[type]}</div>
                    <div className="flex-1 font-medium">{message}</div>
                    <button onClick={handleClose} className="ml-4 -mr-2 p-1 rounded-md hover:bg-white/20 focus:outline-none focus:ring-2 focus:ring-white"><CloseIcon /></button>
                </div>
            );
        };

        const NotificationContainer = ({ notifications, removeNotification }) => (
            <div className="fixed top-5 right-5 z-[100] space-y-3">
                {notifications.map(notif => <Toast key={notif.id} {...notif} onClose={() => removeNotification(notif.id)} />)}
            </div>
        );

        const inputStyle = "mt-1 block w-full rounded-md border-slate-300 bg-white py-2 px-3 shadow-sm placeholder:text-slate-400 focus:border-sky-500 focus:outline-none focus:ring-1 focus:ring-sky-500 sm:text-sm";
        const formInputStyle = "mt-1 block w-full rounded-md border-2 border-sky-300 bg-white py-2 px-3 shadow-sm placeholder:text-slate-400 focus:border-sky-500 focus:outline-none focus:ring-1 focus:ring-sky-500 sm:text-sm";
        
        // ... (Các component còn lại như ConfirmModal, NewOrderModal, v.v. giữ nguyên từ code gốc) ...

        const ConfirmModal = ({ isOpen, onClose, onConfirm, title, message }) => {
            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center z-50 p-4">
                    <div className="bg-white rounded-lg shadow-xl w-full max-w-md">
                        <div className="p-6">
                            <h3 className="text-lg font-bold text-gray-900">{title}</h3>
                            <div className="mt-2">
                                <p className="text-sm text-gray-600">{message}</p>
                            </div>
                        </div>
                        <div className="bg-gray-50 px-6 py-3 flex justify-end gap-3">
                            <button type="button" onClick={onClose} className="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Hủy</button>
                            <button type="button" onClick={onConfirm} className="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Xác nhận</button>
                        </div>
                    </div>
                </div>
            );
        };

        const NewOrderModal = ({ isOpen, onClose, onSave, orderToEdit, userRole }) => {
            const initialFormState = { customerName: '', customerPhone: '', customerAddress: '', deviceType: 'Điện thoại', deviceModel: '', deviceSerial: '', devicePassword: '', initialCondition: '', reportedProblem: '', isWarranty: false, originalInvoiceId: '', otherDeviceType: '', completionTime: '', diagnosis: '', repairPlan: '', estimatedCost: '' };
            const [formData, setFormData] = React.useState(initialFormState);
            const canEditTechnicalDetails = ['admin', 'manager', 'technician'].includes(userRole);
            const canEditCustomerDetails = ['admin', 'manager', 'receptionist'].includes(userRole);

            React.useEffect(() => {
                if (isOpen) {
                    if (orderToEdit) {
                        setFormData({ ...initialFormState, ...orderToEdit, estimatedCost: formatNumber(orderToEdit.estimatedCost) });
                    } else {
                        const now = new Date();
                        const day = String(now.getDate()).padStart(2, '0');
                        const month = String(now.getMonth() + 1).padStart(2, '0');
                        const year = now.getFullYear();
                        const hours = String(now.getHours()).padStart(2, '0');
                        const minutes = String(now.getMinutes()).padStart(2, '0');
                        const defaultCompletionTime = `${hours}:${minutes} Ngày ${day}/${month}/${year}`;
                        setFormData({ ...initialFormState, completionTime: defaultCompletionTime });
                    }
                }
            }, [isOpen, orderToEdit]);

            if (!isOpen) return null;
            const handleChange = (e) => { 
                const { name, value, type, checked } = e.target; 
                let processedValue = type === 'checkbox' ? checked : value;
                if (['customerName', 'customerAddress', 'deviceModel', 'initialCondition', 'reportedProblem', 'otherDeviceType', 'partName', 'serviceName', 'location', 'diagnosis', 'repairPlan'].includes(name)) {
                    processedValue = capitalizeWords(processedValue);
                }
                if (name === 'estimatedCost') {
                    setFormData(prev => ({ ...prev, [name]: formatNumber(value) }));
                } else {
                    setFormData(prev => ({ ...prev, [name]: processedValue })); 
                }
            };
            const handleSubmit = (e) => { 
                e.preventDefault(); 
                onSave({ ...formData, estimatedCost: parseFormattedNumber(formData.estimatedCost) }); 
                onClose(); 
            };
            return ( <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4"><div className="bg-white rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto"><div className="flex justify-between items-center p-4 border-b"><h2 className="text-xl font-bold text-gray-800">{orderToEdit ? 'Chỉnh sửa Phiếu Sửa chữa' : 'Tạo Phiếu Sửa Chữa Mới'}</h2><button onClick={onClose} className="text-gray-500 hover:text-gray-800"><CloseIcon /></button></div><form onSubmit={handleSubmit} className="p-6 space-y-4"><fieldset className="border rounded-md p-4" disabled={!canEditCustomerDetails}><legend className="text-lg font-semibold px-2 text-gray-700">Thông Tin Khách Hàng</legend><div className="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label className="block text-sm font-medium text-gray-600">Họ và Tên</label><input type="text" name="customerName" value={formData.customerName} onChange={handleChange} className={formInputStyle} required /></div><div><label className="block text-sm font-medium text-gray-600">Số Điện Thoại</label><input type="tel" name="customerPhone" value={formData.customerPhone} onChange={handleChange} className={formInputStyle} required /></div><div className="md:col-span-2"><label className="block text-sm font-medium text-gray-600">Địa chỉ</label><input type="text" name="customerAddress" value={formData.customerAddress} onChange={handleChange} className={formInputStyle} /></div></div></fieldset><fieldset className="border rounded-md p-4" disabled={!canEditCustomerDetails}><legend className="text-lg font-semibold px-2 text-gray-700">Thông Tin Thiết Bị</legend><div className="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label className="block text-sm font-medium text-gray-600">Loại Thiết Bị</label><select name="deviceType" value={formData.deviceType} onChange={handleChange} className={formInputStyle}><option>Điện thoại</option><option>Laptop</option><option>Máy tính bảng</option><option>Đồng hồ thông minh</option><option>Khác</option></select></div>{formData.deviceType === 'Khác' && (<div><label className="block text-sm font-medium text-gray-600">Vui lòng nhập loại thiết bị</label><input type="text" name="otherDeviceType" value={formData.otherDeviceType} onChange={handleChange} className={formInputStyle} placeholder="VD: Loa Bluetooth, Tai nghe..." required /></div>)}<div><label className="block text-sm font-medium text-gray-600">Model Máy</label><input type="text" name="deviceModel" value={formData.deviceModel} onChange={handleChange} className={formInputStyle} required /></div><div><label className="block text-sm font-medium text-gray-600">IMEI / Serial</label><input type="text" name="deviceSerial" value={formData.deviceSerial} onChange={handleChange} className={formInputStyle} required /></div><div><label className="block text-sm font-medium text-gray-600">Mật khẩu màn hình</label><input type="text" name="devicePassword" value={formData.devicePassword} onChange={handleChange} className={formInputStyle} /></div></div></fieldset><fieldset className="border rounded-md p-4" disabled={!canEditCustomerDetails}><legend className="text-lg font-semibold px-2 text-gray-700">Tình Trạng & Vấn Đề</legend><div className="grid grid-cols-1 gap-4"><div><label className="block text-sm font-medium text-gray-600">Tình trạng máy khi nhận</label><textarea name="initialCondition" value={formData.initialCondition} onChange={handleChange} rows="3" className={formInputStyle} placeholder="Ví dụ: Trầy xước nhẹ ở góc, màn hình bị nứt..."></textarea></div><div><label className="block text-sm font-medium text-gray-600">Vấn đề khách báo</label><textarea name="reportedProblem" value={formData.reportedProblem} onChange={handleChange} rows="3" className={formInputStyle} placeholder="Ví dụ: Không lên nguồn, màn hình cảm ứng không nhạy..." required></textarea></div><div><label className="block text-sm font-medium text-gray-600">Thời gian hẹn trả</label><input type="text" name="completionTime" value={formData.completionTime} onChange={handleChange} className={formInputStyle} placeholder="VD: 3-5 ngày, 17h ngày 25/12..." /></div></div></fieldset><fieldset className="border rounded-md p-4" disabled={!canEditTechnicalDetails}><legend className="text-lg font-semibold px-2 text-gray-700">Chuẩn đoán & Phương án</legend><div className="grid grid-cols-1 gap-4"><div><label className="block text-sm font-medium text-gray-600">Chuẩn đoán sơ bộ</label><textarea name="diagnosis" value={formData.diagnosis || ''} onChange={handleChange} rows="2" className={formInputStyle} placeholder="VD: Lỗi IC nguồn, hỏng màn hình..."></textarea></div><div><label className="block text-sm font-medium text-gray-600">Phương án sửa chữa</label><textarea name="repairPlan" value={formData.repairPlan || ''} onChange={handleChange} rows="2" className={formInputStyle} placeholder="VD: Thay IC nguồn, ép lại cổ cáp màn hình..."></textarea></div><div><label className="block text-sm font-medium text-gray-600">Giá dự kiến</label><input type="text" name="estimatedCost" value={formData.estimatedCost} onChange={handleChange} className={formInputStyle} placeholder="0" /></div></div></fieldset><fieldset className="border rounded-md p-4" disabled={!canEditCustomerDetails}><legend className="text-lg font-semibold px-2 text-gray-700">Bảo hành</legend><div className="space-y-2"><div className="flex items-center"><input id="isWarranty" name="isWarranty" type="checkbox" checked={formData.isWarranty} onChange={handleChange} className="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" /><label htmlFor="isWarranty" className="ml-2 block text-sm text-gray-900">Đây là phiếu bảo hành</label></div>{formData.isWarranty && (<div><label className="block text-sm font-medium text-gray-600">Mã hóa đơn/phiếu gốc</label><input type="text" name="originalInvoiceId" value={formData.originalInvoiceId} onChange={handleChange} className={formInputStyle} placeholder="Nhập mã hóa đơn gốc..." required /></div>)}</div></fieldset><div className="flex justify-end pt-4 space-x-2"><button type="button" onClick={onClose} className="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Hủy</button><button type="submit" className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Lưu</button></div></form></div></div>);
        };
        
        // --- TRANG SỬA CHỮA (ĐÃ THÊM NÚT XUẤT FILE) ---
        const RepairOrdersPage = ({ user, userRole, addNotification }) => {
            const [orders, setOrders] = React.useState([]);
            const [isModalOpen, setIsModalOpen] = React.useState(false);
            const [editingOrder, setEditingOrder] = React.useState(null);
            const [loading, setLoading] = React.useState(true);
            const [error, setError] = React.useState(null);
            const [filterStatus, setFilterStatus] = React.useState('Tất cả');
            const repairStatuses = ["Mới nhận", "Đang kiểm tra", "Chờ báo giá", "Chờ linh kiện", "Đang sửa", "Sửa xong, chờ QC", "Sẵn sàng trả khách", "Đã trả khách", "Báo giá không sửa"];
            const appId = React.useMemo(() => typeof __app_id !== 'undefined' ? __app_id : 'default-app-id', []);

            React.useEffect(() => {
                if (!user || !db) { setLoading(false); return; }
                setLoading(true);
                const q = db.collection(`artifacts/${appId}/public/data/repairOrders`).orderBy("createdAt", "desc");
                const unsubscribe = q.onSnapshot(
                    (snapshot) => { setOrders(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))); setLoading(false); },
                    (err) => { console.error("Lỗi: ", err); setError("Lỗi tải dữ liệu."); setLoading(false); }
                );
                return () => unsubscribe();
            }, [user, appId]);

            const handleExport = () => {
                const dataToExport = orders.map(o => ({
                    customerName: o.customerName || '',
                    customerPhone: o.customerPhone || '',
                    customerAddress: o.customerAddress || '',
                    deviceType: o.deviceType || '',
                    deviceModel: o.deviceModel || '',
                    deviceSerial: o.deviceSerial || '',
                    devicePassword: o.devicePassword || '',
                    initialCondition: o.initialCondition || '',
                    reportedProblem: o.reportedProblem || '',
                    isWarranty: o.isWarranty || false,
                    originalInvoiceId: o.originalInvoiceId || '',
                    completionTime: o.completionTime || '',
                    diagnosis: o.diagnosis || '',
                    repairPlan: o.repairPlan || '',
                    estimatedCost: o.estimatedCost || 0,
                }));
                exportToCSV(dataToExport, 'repairOrders.csv');
            };

            const filteredOrders = React.useMemo(() => filterStatus === 'Tất cả' ? orders : orders.filter(order => order.status === filterStatus), [orders, filterStatus]);
            
            // ... (Phần còn lại của component giữ nguyên, chỉ thêm nút export)
            return (
                <div className="p-4 md:p-6 lg:p-8 bg-slate-100 min-h-full">
                    <div className="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                        <h1 className="text-2xl md:text-3xl font-bold text-gray-800">Quản lý Sửa chữa</h1>
                        <div className="flex gap-2">
                            <button onClick={handleExport} className="flex items-center gap-2 px-4 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700">
                                <DownloadIcon />Xuất File CSV
                            </button>
                            <button onClick={() => { setEditingOrder(null); setIsModalOpen(true); }} className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700">
                                <PlusIcon />Tạo Phiếu Mới
                            </button>
                        </div>
                    </div>
                    {/* Phần còn lại của UI trang sửa chữa giữ nguyên */}
                    <div className="mb-4"><label htmlFor="statusFilter" className="block text-sm font-medium text-gray-700 mb-1">Lọc theo trạng thái:</label><select id="statusFilter" value={filterStatus} onChange={(e) => setFilterStatus(e.target.value)} className={inputStyle + ' max-w-xs'}><option>Tất cả</option>{repairStatuses.map(status => <option key={status} value={status}>{status}</option>)}</select></div>
                    {loading ? <p className="text-center py-10">Đang tải...</p> : error ? <p className="text-center py-10 text-red-500">{error}</p> : (<div className="bg-white rounded-lg shadow overflow-x-auto"><table className="min-w-full divide-y divide-gray-200"><thead className="bg-gray-50"><tr><th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mã Phiếu</th><th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Khách Hàng</th><th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Thiết Bị</th><th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ngày Nhận</th><th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Trạng Thái</th><th scope="col" className="relative px-6 py-3"></th></tr></thead><tbody className="bg-white divide-y divide-gray-200">{filteredOrders.length > 0 ? filteredOrders.map(order => (<tr key={order.id} className="hover:bg-gray-50"><td className="px-6 py-4 whitespace-nowrap text-sm font-mono text-slate-600">#{order.id.slice(0,6)}</td><td className="px-6 py-4 whitespace-nowrap"><div className="text-sm font-medium text-gray-900">{order.customerName}</div><div className="text-sm text-gray-500">{order.customerPhone}</div></td><td className="px-6 py-4 whitespace-nowrap"><div className="text-sm text-gray-900">{order.deviceModel}</div><div className="text-sm text-gray-500">{order.deviceType}</div></td><td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{order.createdAt?.toDate ? order.createdAt.toDate().toLocaleDateString('vi-VN') : 'N/A'}</td><td className="px-6 py-4 whitespace-nowrap"><span className={`text-xs font-semibold rounded-full px-3 py-1`}>{order.status}</span></td><td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2"><button onClick={() => { setEditingOrder(order); setIsModalOpen(true); }} className="text-indigo-600 hover:text-indigo-900"><EditIcon /></button></td></tr>)) : (<tr><td colSpan="6" className="px-6 py-4 text-center text-gray-500">Không có phiếu sửa chữa nào.</td></tr>)}</tbody></table></div>)}
                    <NewOrderModal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} onSave={() => {}} orderToEdit={editingOrder} userRole={userRole} />
                </div>
            );
        };

        // --- TRANG KHÁCH HÀNG (ĐÃ THÊM NÚT XUẤT FILE) ---
        const CustomersPage = ({ user, userRole }) => {
            const [customers, setCustomers] = React.useState([]);
            const [loading, setLoading] = React.useState(true);
            const [error, setError] = React.useState(null);
            const [searchTerm, setSearchTerm] = React.useState("");
            const appId = React.useMemo(() => typeof __app_id !== 'undefined' ? __app_id : 'default-app-id', []);
            
            React.useEffect(() => {
                if (!user || !db) { setLoading(false); return; }
                setLoading(true);
                const q = db.collection(`artifacts/${appId}/public/data/customers`).orderBy("lastSeen", "desc");
                const unsubscribe = q.onSnapshot(
                    (snapshot) => { setCustomers(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))); setLoading(false); },
                    (err) => { console.error("Lỗi:", err); setError("Lỗi tải dữ liệu."); setLoading(false); }
                );
                return () => unsubscribe();
            }, [user, appId]);

            const handleExport = () => {
                const dataToExport = customers.map(c => ({
                    customerName: c.customerName || '',
                    customerPhone: c.customerPhone || '',
                    customerAddress: c.customerAddress || ''
                }));
                exportToCSV(dataToExport, 'customers.csv');
            };

            const filteredCustomers = customers.filter(c => c.customerName?.toLowerCase().includes(searchTerm.toLowerCase()) || c.customerPhone?.includes(searchTerm));
            
            return (
                <div className="p-4 md:p-6 lg:p-8 bg-slate-100 min-h-full">
                    <div className="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                        <h1 className="text-2xl md:text-3xl font-bold text-gray-800">Quản lý Khách hàng</h1>
                        <button onClick={handleExport} className="flex items-center gap-2 px-4 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700">
                            <DownloadIcon />Xuất File CSV
                        </button>
                    </div>
                    {/* Phần còn lại của UI trang khách hàng giữ nguyên */}
                    <div className="mb-4"><div className="relative"><span className="absolute inset-y-0 left-0 flex items-center pl-3 text-slate-400"><SearchIcon /></span><input type="text" placeholder="Tìm kiếm khách hàng..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className={inputStyle + " pl-10 max-w-sm"}/></div></div>{loading ? <p className="text-center py-10">Đang tải...</p> : error ? <p className="text-center py-10 text-red-500">{error}</p> : (<div className="bg-white rounded-lg shadow overflow-x-auto"><table className="min-w-full divide-y divide-gray-200"><thead className="bg-gray-50"><tr><th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tên</th><th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">SĐT</th><th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Địa Chỉ</th><th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lần cuối ghé</th></tr></thead><tbody className="bg-white divide-y divide-gray-200">{filteredCustomers.length > 0 ? filteredCustomers.map(customer => (<tr key={customer.id} className="hover:bg-gray-50"><td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{customer.customerName}</td><td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{customer.customerPhone}</td><td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{customer.customerAddress || 'N/A'}</td><td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{customer.lastSeen?.toDate ? customer.lastSeen.toDate().toLocaleDateString('vi-VN') : 'N/A'}</td></tr>)) : (<tr><td colSpan="4" className="px-6 py-4 text-center text-gray-500">Không tìm thấy khách hàng.</td></tr>)}</tbody></table></div>)}
                </div>
            );
        };

        // --- TRANG KHO LINH KIỆN (ĐÃ THÊM NÚT XUẤT FILE) ---
        const InventoryPage = ({ user, userRole, addNotification }) => {
            const [parts, setParts] = React.useState([]);
            const [loading, setLoading] = React.useState(true);
            const [error, setError] = React.useState(null);
            const appId = React.useMemo(() => typeof __app_id !== 'undefined' ? __app_id : 'default-app-id', []);
            
            React.useEffect(() => {
                if (!user || !db) { setLoading(false); return; }
                setLoading(true);
                const q = db.collection(`artifacts/${appId}/public/data/inventoryParts`).orderBy("partName");
                const unsubscribe = q.onSnapshot(
                    (snapshot) => { setParts(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))); setLoading(false); },
                    (err) => { console.error("Lỗi:", err); setError("Lỗi tải dữ liệu."); setLoading(false); }
                );
                return () => unsubscribe();
            }, [user, appId]);

            const handleExport = () => {
                const dataToExport = parts.map(p => ({
                    partName: p.partName || '',
                    location: p.location || '',
                    stockQuantity: p.stockQuantity || 0,
                    importPrice: p.importPrice || 0,
                    salePrice: p.salePrice || 0,
                    lowStockThreshold: p.lowStockThreshold || 5
                }));
                exportToCSV(dataToExport, 'inventoryParts.csv');
            };

            // ... (Phần còn lại của component giữ nguyên, chỉ thêm nút export)
            return (
                <div className="p-4 md:p-6 lg:p-8 bg-slate-100 min-h-full">
                    <div className="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                        <h1 className="text-2xl md:text-3xl font-bold text-gray-800">Quản lý Kho Linh kiện</h1>
                        <div className="flex gap-2">
                             <button onClick={handleExport} className="flex items-center gap-2 px-4 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700">
                                <DownloadIcon />Xuất File CSV
                            </button>
                            <button className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700">
                                <PlusIcon />Thêm Linh kiện
                            </button>
                        </div>
                    </div>
                     {loading ? <p className="text-center py-10">Đang tải...</p> : error ? <p className="text-center py-10 text-red-500">{error}</p> : (<div className="bg-white rounded-lg shadow overflow-x-auto"><table className="min-w-full divide-y divide-gray-200"><thead className="bg-gray-50"><tr><th className="px-6 py-3 text-left text-xs font-medium uppercase">Tên Linh kiện</th><th className="px-6 py-3 text-left text-xs font-medium uppercase">Tồn kho</th><th className="px-6 py-3 text-left text-xs font-medium uppercase">Giá Bán</th><th className="relative px-6 py-3"></th></tr></thead><tbody className="bg-white divide-y divide-gray-200">{parts.length > 0 ? parts.map(part => (<tr key={part.id}><td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{part.partName}</td><td className="px-6 py-4 whitespace-nowrap text-sm">{formatNumber(part.stockQuantity)}</td><td className="px-6 py-4 whitespace-nowrap text-sm">{formatNumber(part.salePrice)} đ</td><td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-4"><button className="text-indigo-600 hover:text-indigo-900"><EditIcon/></button></td></tr>)) : (<tr><td colSpan="4" className="px-6 py-4 text-center text-gray-500">Chưa có linh kiện nào.</td></tr>)}</tbody></table></div>)}
                </div>
            );
        };

        // --- TRANG DỊCH VỤ (ĐÃ THÊM NÚT XUẤT FILE) ---
        const ServicesPage = ({ user, userRole, addNotification }) => {
            const [services, setServices] = React.useState([]);
            const [loading, setLoading] = React.useState(true);
            const [error, setError] = React.useState(null);
            const appId = React.useMemo(() => typeof __app_id !== 'undefined' ? __app_id : 'default-app-id', []);
            
            React.useEffect(() => {
                if (!user || !db) { setLoading(false); return; }
                setLoading(true);
                const q = db.collection(`artifacts/${appId}/public/data/services`).orderBy("serviceName");
                const unsubscribe = q.onSnapshot(
                    (snapshot) => { setServices(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))); setLoading(false); },
                    (err) => { console.error("Lỗi:", err); setError("Lỗi tải dữ liệu."); setLoading(false); }
                );
                return () => unsubscribe();
            }, [user, appId]);
            
            const handleExport = () => {
                const dataToExport = services.map(s => ({
                    serviceName: s.serviceName || '',
                    laborCost: s.laborCost || 0
                }));
                exportToCSV(dataToExport, 'services.csv');
            };

            // ... (Phần còn lại của component giữ nguyên, chỉ thêm nút export)
             return (
                <div className="p-4 md:p-6 lg:p-8 bg-slate-100 min-h-full">
                    <div className="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                        <h1 className="text-2xl md:text-3xl font-bold text-gray-800">Quản lý Dịch vụ</h1>
                        <div className="flex gap-2">
                             <button onClick={handleExport} className="flex items-center gap-2 px-4 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700">
                                <DownloadIcon />Xuất File CSV
                            </button>
                            <button className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700">
                                <PlusIcon />Thêm Dịch vụ
                            </button>
                        </div>
                    </div>
                     {loading ? <p className="text-center py-10">Đang tải...</p> : error ? <p className="text-center py-10 text-red-500">{error}</p> : (<div className="bg-white rounded-lg shadow overflow-x-auto"><table className="min-w-full divide-y divide-gray-200"><thead className="bg-gray-50"><tr><th className="px-6 py-3 text-left text-xs font-medium uppercase">Tên Dịch vụ</th><th className="px-6 py-3 text-left text-xs font-medium uppercase">Tiền công</th><th className="relative px-6 py-3"></th></tr></thead><tbody className="bg-white divide-y divide-gray-200">{services.length > 0 ? services.map(service => (<tr key={service.id}><td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{service.serviceName}</td><td className="px-6 py-4 whitespace-nowrap text-sm">{formatNumber(service.laborCost)} đ</td><td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-4"><button className="text-indigo-600 hover:text-indigo-900"><EditIcon/></button></td></tr>)) : (<tr><td colSpan="3" className="px-6 py-4 text-center text-gray-500">Chưa có dịch vụ nào.</td></tr>)}</tbody></table></div>)}
                </div>
            );
        };

        // --- TRANG CÔNG CỤ QUẢN TRỊ (ADMIN TOOLS) ---
        const AdminToolsPage = ({ user, userRole, addNotification }) => {
            const [loading, setLoading] = React.useState(false);
            const [deleteType, setDeleteType] = React.useState('all'); // 'all' | 'byDate'
            const [selectedDate, setSelectedDate] = React.useState('');
            const [isConfirmOpen, setIsConfirmOpen] = React.useState(false);

            const appId = React.useMemo(() => typeof __app_id !== 'undefined' ? __app_id : 'default-app-id', []);

            const staticCollections = ['customers', 'inventoryParts', 'services'];
            const transactionalCollections = {
                'repairOrders': 'createdAt',
                'audit_logs': 'timestamp',
                'invoices': 'createdAt'
            };

            const handleOpenConfirm = () => {
                if (deleteType === 'byDate' && !selectedDate) {
                    addNotification('Vui lòng chọn ngày để xóa theo ngày.', 'error');
                    return;
                }
                setIsConfirmOpen(true);
            };

            const performDeleteAll = async () => {
                const dataPathPrefix = `artifacts/${appId}/public/data`;
                let totalDeleted = 0;
                // Xóa tất cả tài liệu trong các bộ sưu tập được chỉ định
                for (const collectionName of [...staticCollections, ...Object.keys(transactionalCollections)]) {
                    const colRef = db.collection(`${dataPathPrefix}/${collectionName}`);
                    const snapshot = await colRef.get();
                    if (snapshot.empty) continue;
                    let batch = db.batch();
                    let counter = 0;
                    snapshot.docs.forEach((doc) => {
                        batch.delete(doc.ref);
                        counter++;
                        totalDeleted++;
                        if (counter === 400) {
                            batch.commit();
                            batch = db.batch();
                            counter = 0;
                        }
                    });
                    await batch.commit();
                }
                await logAction(user, 'admin_delete_all', 'AdminTools', `Admin ${user.email} xóa toàn bộ dữ liệu`, '');
                addNotification(`Đã xóa ${totalDeleted} mục từ tất cả bộ sưu tập.`, 'success');
            };

            const performDeleteByDate = async () => {
                const dataPathPrefix = `artifacts/${appId}/public/data`;
                const start = new Date(selectedDate);
                start.setHours(0, 0, 0, 0);
                const end = new Date(selectedDate);
                end.setHours(23, 59, 59, 999);

                let totalDeleted = 0;
                for (const collectionName of Object.keys(transactionalCollections)) {
                    const timestampField = transactionalCollections[collectionName];
                    const colRef = db.collection(`${dataPathPrefix}/${collectionName}`);
                    const q = colRef
                        .where(timestampField, '>=', start)
                        .where(timestampField, '<=', end);
                    const snapshot = await q.get();
                    if (snapshot.empty) continue;
                    let batch = db.batch();
                    let counter = 0;
                    snapshot.docs.forEach((doc) => {
                        batch.delete(doc.ref);
                        counter++;
                        totalDeleted++;
                        if (counter === 400) {
                            batch.commit();
                            batch = db.batch();
                            counter = 0;
                        }
                    });
                    await batch.commit();
                }
                await logAction(user, 'admin_delete_by_date', 'AdminTools', `Admin ${user.email} xóa dữ liệu theo ngày ${selectedDate}`, '');
                addNotification(`Đã xóa ${totalDeleted} mục theo ngày đã chọn.`, 'success');
            };

            const handleConfirm = async () => {
                setIsConfirmOpen(false);
                setLoading(true);
                try {
                    if (deleteType === 'all') {
                        await performDeleteAll();
                    } else {
                        await performDeleteByDate();
                    }
                } catch (err) {
                    console.error(err);
                    addNotification('Có lỗi xảy ra khi xóa dữ liệu.', 'error');
                } finally {
                    setLoading(false);
                }
            };

            if (userRole !== 'admin') {
                return (
                    <div className="p-4 md:p-6 lg:p-8 bg-slate-100 min-h-full">
                        <div className="bg-white rounded-md p-6 shadow">
                            <p className="text-red-600">Bạn không có quyền truy cập trang này.</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="p-4 md:p-6 lg:p-8 bg-slate-100 min-h-full">
                    <div className="max-w-3xl mx-auto bg-white rounded-lg shadow p-6 space-y-6">
                        <h1 className="text-2xl md:text-3xl font-bold text-gray-800">Công cụ Quản trị</h1>
                        <div className="rounded-md border border-yellow-300 bg-yellow-50 p-4 text-yellow-800">
                            <div className="flex items-start">
                                <WarningIcon />
                                <div className="ml-3">
                                    <p className="font-semibold">Cảnh báo quan trọng</p>
                                    <p>Hành động này sẽ xóa dữ liệu KHÔNG THỂ KHÔI PHỤC. Hãy chắc chắn đã sao lưu trước khi thực hiện.</p>
                                </div>
                            </div>
                        </div>

                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Chế độ xóa</label>
                                <div className="mt-2 flex flex-col sm:flex-row gap-3">
                                    <label className="inline-flex items-center gap-2">
                                        <input
                                            type="radio"
                                            name="deleteType"
                                            value="all"
                                            checked={deleteType === 'all'}
                                            onChange={(e) => setDeleteType(e.target.value)}
                                        />
                                        <span>Xóa toàn bộ dữ liệu</span>
                                    </label>
                                    <label className="inline-flex items-center gap-2">
                                        <input
                                            type="radio"
                                            name="deleteType"
                                            value="byDate"
                                            checked={deleteType === 'byDate'}
                                            onChange={(e) => setDeleteType(e.target.value)}
                                        />
                                        <span>Xóa theo ngày</span>
                                    </label>
                                </div>
                            </div>

                            {deleteType === 'byDate' && (
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">Chọn ngày</label>
                                    <input
                                        type="date"
                                        value={selectedDate}
                                        onChange={(e) => setSelectedDate(e.target.value)}
                                        className={inputStyle + ' max-w-xs'}
                                    />
                                </div>
                            )}

                            <div className="pt-2">
                                <button
                                    disabled={loading}
                                    onClick={handleOpenConfirm}
                                    className={`px-4 py-2 rounded-md text-white ${loading ? 'bg-gray-400' : 'bg-red-600 hover:bg-red-700'} flex items-center gap-2`}
                                >
                                    <DeleteIcon /> {loading ? 'Đang xử lý...' : 'Thực hiện xóa'}
                                </button>
                            </div>
                        </div>
                    </div>

                    <ConfirmModal
                        isOpen={isConfirmOpen}
                        onClose={() => setIsConfirmOpen(false)}
                        onConfirm={handleConfirm}
                        title={deleteType === 'all' ? 'Xác nhận xóa toàn bộ dữ liệu' : 'Xác nhận xóa dữ liệu theo ngày'}
                        message={deleteType === 'all' ? 'Bạn có chắc chắn muốn xóa toàn bộ dữ liệu? Hành động này không thể hoàn tác.' : `Bạn có chắc chắn muốn xóa dữ liệu trong ngày ${selectedDate}? Hành động này không thể hoàn tác.`}
                    />
                </div>
            );
        };
        
        // --- KHUNG ỨNG DỤNG & ĐỊNH TUYẾN ---
        function App() {
            const [activePage, setActivePage] = React.useState('repairs');
            // ... (Phần còn lại của App component giữ nguyên)
            const [user, setUser] = React.useState(null);
            const [userRole, setUserRole] = React.useState(null);
            const [authReady, setAuthReady] = React.useState(false);
            const [isSidebarOpen, setSidebarOpen] = React.useState(false);
            const [notifications, setNotifications] = React.useState([]);
            const addNotification = React.useCallback((message, type = 'success') => {
                const id = Date.now() + Math.random();
                setNotifications(prev => [...prev, { id, message, type }]);
            }, []);
            const removeNotification = React.useCallback((id) => {
                setNotifications(prev => prev.filter(notif => notif.id !== id));
            }, []);
            React.useEffect(() => {
                if (!auth) { setAuthReady(true); return; }
                const unsubscribe = auth.onAuthStateChanged(user => {
                    setUser(user);
                    // Giả định vai trò cho đơn giản, bạn có thể mở rộng logic này
                    setUserRole('admin'); 
                    if (!authReady) setAuthReady(true);
                });
                return () => unsubscribe();
            }, [authReady]);

            const handleLogout = () => auth.signOut();
            const renderPage = () => {
                const props = { user, userRole, addNotification };
                switch (activePage) {
                    case 'repairs': return <RepairOrdersPage {...props} />;
                    case 'customers': return <CustomersPage {...props} />;
                    case 'inventory': return <InventoryPage {...props} />;
                    case 'services': return <ServicesPage {...props} />;
                    case 'admin': return <AdminToolsPage {...props} />;
                    default: return <RepairOrdersPage {...props} />;
                }
            };
            if (!isFirebaseInitialized) return <div className="p-4 text-center text-red-600">Lỗi cấu hình Firebase.</div>;
            if (!authReady) return <div className="p-4 text-center">Đang khởi tạo...</div>;
            if (!user) return <LoginPage />;
            
            return (
                <div className="min-h-screen bg-slate-100">
                    <NotificationContainer notifications={notifications} removeNotification={removeNotification} />
                    <Sidebar activePage={activePage} setActivePage={setActivePage} isOpen={isSidebarOpen} setOpen={setSidebarOpen} user={user} onLogout={handleLogout} userRole={userRole} />
                    <main className="lg:ml-64">
                        <div className="lg:hidden p-4 bg-white border-b flex justify-between items-center sticky top-0 z-20">
                           <h2 className="font-bold text-lg">RepairShop Pro</h2>
                           <button onClick={() => setSidebarOpen(true)}><MenuIcon /></button>
                        </div>
                        {renderPage()}
                    </main>
                </div>
            );
        }

        // ... (Các component LoginPage, Sidebar giữ nguyên từ code gốc)
        const Sidebar = ({ activePage, setActivePage, isOpen, setOpen, user, onLogout, userRole }) => {
            const navItems = [
                { id: 'repairs', label: 'Sửa chữa', icon: <RepairIcon /> }, 
                { id: 'customers', label: 'Khách hàng', icon: <CustomerIcon /> }, 
                { id: 'inventory', label: 'Kho Linh kiện', icon: <InventoryIcon /> }, 
                { id: 'services', label: 'Dịch vụ', icon: <ServiceIcon /> },
                ...(userRole === 'admin' ? [{ id: 'admin', label: 'Quản trị', icon: <AuditLogIcon /> }] : [])
            ];
            return ( <> <div className={`fixed inset-0 bg-black bg-opacity-50 z-30 lg:hidden transition-opacity ${isOpen ? 'opacity-100' : 'opacity-0 pointer-events-none'}`} onClick={() => setOpen(false)}></div> <div className={`fixed top-0 left-0 h-full w-64 bg-gray-800 text-white flex flex-col shadow-lg z-40 transform transition-transform lg:translate-x-0 ${isOpen ? 'translate-x-0' : '-translate-x-full'}`}><div className="px-6 py-4 flex items-center gap-3 border-b border-gray-700"><RepairIcon /><h2 className="text-lg font-semibold">RepairShop Pro</h2></div><nav className="flex-1 px-4 py-4 space-y-2">{navItems.map(item => (<a key={item.id} href="#" onClick={(e) => { e.preventDefault(); setActivePage(item.id); setOpen(false); }} className={`flex items-center gap-3 px-4 py-2 rounded-md text-sm font-medium transition-colors ${activePage === item.id ? 'bg-gray-900 text-white' : 'text-gray-300 hover:bg-gray-700 hover:text-white'}`}>{item.icon}<span>{item.label}</span></a>))}</nav><div className="px-4 py-4 border-t border-gray-700 space-y-2"><div className="px-4 py-2 text-sm text-gray-400"><p>Đăng nhập với:</p><p className="font-medium text-white truncate">{user?.email}</p></div><a href="#" onClick={onLogout} className="flex items-center gap-3 px-4 py-2 rounded-md text-sm font-medium text-gray-300 hover:bg-gray-700 hover:text-white"><LogoutIcon /><span>Đăng xuất</span></a></div></div> </> );
        };

        const LoginPage = () => {
            const [email, setEmail] = React.useState('');
            const [password, setPassword] = React.useState('');
            const [error, setError] = React.useState('');
            const [loading, setLoading] = React.useState(false);
            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                try {
                    await auth.signInWithEmailAndPassword(email, password);
                } catch (err) {
                    setError('Sai email hoặc mật khẩu. Vui lòng thử lại.');
                    console.error(err);
                } finally {
                    setLoading(false);
                }
            };
            return ( <div className="min-h-screen bg-gray-100 flex flex-col justify-center items-center p-4"><div className="max-w-md w-full bg-white rounded-lg shadow-md p-8"><div className="text-center mb-8"><div className="flex justify-center items-center gap-3 mb-2"><RepairIcon /><h1 className="text-2xl font-bold text-gray-800">RepairShop Pro</h1></div><p className="text-gray-500">Đăng nhập vào tài khoản của bạn</p></div><form onSubmit={handleSubmit} className="space-y-6"><div><label htmlFor="email" className="text-sm font-medium text-gray-700">Email</label><input id="email" name="email" type="email" required value={email} onChange={e => setEmail(e.target.value)} className={inputStyle} /></div><div><label htmlFor="password" className="text-sm font-medium text-gray-700">Mật khẩu</label><input id="password" name="password" type="password" required value={password} onChange={e => setPassword(e.target.value)} className={inputStyle} /></div>{error && <p className="text-red-500 text-sm">{error}</p>}<div><button type="submit" disabled={loading} className="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:bg-blue-300">{loading ? 'Đang xử lý...' : 'Đăng nhập'}</button></div></form></div></div> );
        };

        const container = document.getElementById('root');
        if (container) {
            const root = ReactDOM.createRoot(container);
            root.render(<App />);
        } else {
            console.error("Root element not found.");
        }
    </script>
</body>
</html>
