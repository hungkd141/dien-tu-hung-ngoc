<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Phần mềm Quản lý Sửa chữa - Nâng cấp</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
}
        ::-webkit-scrollbar { width: 8px;
}
        ::-webkit-scrollbar-track { background: #f1f5f9;
}
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px;
}
        ::-webkit-scrollbar-thumb:hover { background: #64748b;
}
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- BIỂU TƯỢNG (ICONS) ---
        const PlusIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" /></svg>;
const RepairIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>;
const CustomerIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>;
const InventoryIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" /></svg>;
const ReportIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>;
const CloseIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>;
const SearchIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clipRule="evenodd" /></svg>;
const HistoryIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>;
const EditIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.536l12.232-12.232z" /></svg>;
const DeleteIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>;
const WarningIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 text-yellow-500" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.21 3.03-1.742 3.03H4.42c-1.532 0-2.492-1.696-1.742-3.03l5.58-9.92zM10 13a1 1 0 110-2 1 1 0 010 2zm-1-8a1 1 0 00-1 1v3a1 1 0 102 0V6a1 1 0 00-1-1z" clipRule="evenodd" /></svg>;
const ServiceIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924-1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>;
const InvoiceIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>;
const WarrantyIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 20.417l4.5-1.5a8.023 8.023 0 011.14-5.571 8.023 8.023 0 015.571-1.14l1.5-4.5z" /></svg>;
const PrintIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H7a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm7-8V5a2 2 0 00-2-2H5a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-2" /></svg>;
const DownloadIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>;
const MenuIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h16" /></svg>;
const LogoutIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>;
const AuditLogIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg>;
const UsersIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M15 21a6 6 0 00-9-5.197M15 12a4 4 0 110-8 4 4 0 010 8z" /></svg>;
const TableIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>;
const SuccessIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>;
const ErrorIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>;
// --- CẤU HÌNH FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyDhulXkeejEKhmdFYgEeXDGmhyb5tZYrwI",
            authDomain: "dien-tu-hung-ngoc.firebaseapp.com",
            projectId: "dien-tu-hung-ngoc",
            storageBucket: "dien-tu-hung-ngoc.appspot.com",
            messagingSenderId: "803794710284",
            appId: "1:803794710284:web:f2ecd59b4ce23e72a46329"
      
  };

        let app; let db; let auth;
        let isFirebaseInitialized = false;
try { 
            if (firebaseConfig && firebaseConfig.apiKey && !firebaseConfig.apiKey.includes("YOUR_API")) {
                app = firebase.initializeApp(firebaseConfig);
db = firebase.firestore();
                db.enablePersistence().catch((err) => {
                    if (err.code == 'failed-precondition') {
                        console.warn("Firebase: Multiple tabs open, persistence can only be enabled in one tab at a a time.");
                    } else if (err.code == 'unimplemented') {
      
                  console.warn("Firebase: The current browser does not support all of the features required to enable persistence.");
                    }
                });
auth = firebase.auth();
                isFirebaseInitialized = true;
            } else {
                 console.error("Firebase config is not set. Please replace placeholder values.");
}
        } catch (e) { 
            console.error("Lỗi khởi tạo Firebase:", e);
}

        // --- CÁC HÀM HỖ TRỢ ---
        const capitalizeWords = (str) => {
            if (!str) return '';
return str.toLowerCase().replace(/(^\w{1})|(\s+\w{1})/g, letter => letter.toUpperCase());
        };
        
        const formatNumber = (value) => {
            if (value === null || value === undefined || value === '') return '';
const numberValue = parseInt(String(value).replace(/[^0-9]/g, ''), 10);
            if (isNaN(numberValue)) return '';
            return numberValue.toLocaleString('vi-VN');
        };
const parseFormattedNumber = (value) => {
            if (typeof value === 'number') return value;
if (!value) return 0;
            return parseFloat(String(value).replace(/\./g, '')) || 0;
        };
const logAction = async (user, action, entity, details, entityId = '') => {
            if (!db || !user) {
                console.warn("logAction: DB hoặc User không tồn tại.");
return;
            }
            const appId = typeof __app_id !== 'undefined' ?
__app_id : 'default-app-id';
            const logPath = `artifacts/${appId}/users/${user.uid}/audit_logs`;
            try {
                await db.collection(logPath).add({
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    userEmail: user.email,
                    action: action,
            
        entity: entity,
                    entityId: entityId,
                    details: details
                });
} catch (error) {
                console.error("Lỗi ghi nhật ký:", error);
}
        };

        const printWithIframe = (elementToPrint) => {
            if (!elementToPrint) {
                console.error("Phần tử để in không tồn tại.");
return;
            }

            let allStyles = "";
const styleSheets = document.head.querySelectorAll('style, link[rel="stylesheet"]');
            styleSheets.forEach(sheet => {
                allStyles += sheet.outerHTML;
            });
const iframe = document.createElement('iframe');
            iframe.style.position = 'absolute';
            iframe.style.width = '0';
            iframe.style.height = '0';
            iframe.style.border = 'none';
            iframe.style.top = '-9999px';
iframe.style.left = '-9999px';
            document.body.appendChild(iframe);
            
            const iframeDoc = iframe.contentWindow.document;

            iframeDoc.open();
            iframeDoc.write('<!DOCTYPE html><html lang="vi"><head><title>In tài liệu</title>');
            iframeDoc.write(allStyles);
iframeDoc.write(`
                <style>
                    body { 
                        margin: 1.5rem;
                    }
                 
   @media print {
                        body {
                            -webkit-print-color-adjust: exact !important;
                            color-adjust: exact !important;
          
              }
                        .no-print {
                            display: none !important;
                        }
       
                 tr, .printable-item {
                           page-break-inside: avoid;
                        }
                    }
         
       </style>
            `);
iframeDoc.write('</head><body>');
            iframeDoc.write(elementToPrint.innerHTML);
            iframeDoc.write('</body></html>');
            iframeDoc.close();

            iframe.onload = function() {
                setTimeout(function() {
                    iframe.contentWindow.focus(); 
                    iframe.contentWindow.print(); 
                    document.body.removeChild(iframe);
              
  }, 100); 
            };
        };


        function exportToCSV(data, filename) {
            if (data.length === 0) {
                console.warn("Không có dữ liệu để xuất.");
return;
            }
            
            const headers = Object.keys(data[0]);
const csvRows = [headers.join(',')];

            for (const row of data) {
                const values = headers.map(header => {
                    let cell = row[header] === null || row[header] === undefined ? '' : row[header];
                    if (typeof cell === 'object' && cell instanceof firebase.firestore.Timestamp) {
        
                cell = cell.toDate().toLocaleDateString('vi-VN');
                    }
                    const cellString = String(cell);
                    const escaped = cellString.replace(/"/g, '""');
               
     return `"${escaped}"`;
                });
                csvRows.push(values.join(','));
            }

            const blob = new Blob(["\uFEFF" + csvRows.join('\n')], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const 
url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
link.click();
            document.body.removeChild(link);
        }

        // --- CÁC THÀNH PHẦN GIAO DIỆN (UI COMPONENTS) ---

        const Toast = ({ message, type, onClose }) => {
            const [exiting, setExiting] = React.useState(false);
React.useEffect(() => {
                const timer = setTimeout(() => {
                    setExiting(true);
                    setTimeout(onClose, 300);
                }, 4000);

                return () => 
clearTimeout(timer);
            }, [onClose]);
const handleClose = () => {
                setExiting(true);
setTimeout(onClose, 300);
            };

            const typeClasses = {
                success: 'bg-green-500 text-white',
                error: 'bg-red-500 text-white',
            };
const icon = {
                success: <SuccessIcon />,
                error: <ErrorIcon />,
            }

            return (
                <div 
                   
 className={`flex items-center p-4 rounded-lg shadow-lg max-w-sm transition-all duration-300 ease-in-out transform ${typeClasses[type]} ${exiting ? 'opacity-0 translate-x-full' : 'opacity-100 translate-x-0'}`}
                >
                    <div className="mr-3">{icon[type]}</div>
                    <div className="flex-1 font-medium">{message}</div>
                    <button onClick={handleClose} className="ml-4 
-mr-2 p-1 rounded-md hover:bg-white/20 focus:outline-none focus:ring-2 focus:ring-white">
                        <CloseIcon />
                    </button>
                </div>
            );
};

        const NotificationContainer = ({ notifications, removeNotification }) => {
            return (
                <div className="fixed top-5 right-5 z-[100] space-y-3">
                    {notifications.map(notif => (
                        <Toast
           
                 key={notif.id}
                            message={notif.message}
                            type={notif.type}
                           
 onClose={() => removeNotification(notif.id)}
                        />
                    ))}
                </div>
            );
};

        const inputStyle = "mt-1 block w-full rounded-md border-slate-300 bg-white py-2 px-3 shadow-sm placeholder:text-slate-400 focus:border-sky-500 focus:outline-none focus:ring-1 focus:ring-sky-500 sm:text-sm";
const formInputStyle = "mt-1 block w-full rounded-md border-2 border-sky-300 bg-white py-2 px-3 shadow-sm placeholder:text-slate-400 focus:border-sky-500 focus:outline-none focus:ring-1 focus:ring-sky-500 sm:text-sm";
        
        {/* ----- BẮT ĐẦU NÂNG CẤP YÊU CẦU 3 (ConfirmModal) ----- */}
const ConfirmModal = ({ isOpen, onClose, onConfirm, title, message, confirmationText = null }) => {
            if (!isOpen) return null;
            
            const [inputText, setInputText] = React.useState('');
            const isConfirmationRequired = confirmationText !== null;
            const isConfirmed = !isConfirmationRequired || inputText === confirmationText;

            const handleConfirmClick = () => {
                if (isConfirmed) {
                    onConfirm();
                    setInputText(''); // Reset
                }
            };
            
            const handleClose = () => {
                onClose();
                setInputText(''); // Reset
            };

return (
                <div className="fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center z-50 p-4">
                    <div className="bg-white rounded-lg shadow-xl w-full max-w-md">
                        <div className="p-6">
                        
    <h3 className="text-lg font-bold text-gray-900">{title}</h3>
                            <div className="mt-2">
                                <p className="text-sm text-gray-600">{message}</p>
                            </div>
                            
                            {/* Nâng cấp: Thêm ô nhập xác nhận */}
                            {isConfirmationRequired && (
                                <div className="mt-4">
                                    <p className="text-sm text-gray-700">
                                        Vui lòng gõ "<strong className="text-red-600">{confirmationText}</strong>" vào ô bên dưới để xác nhận:
                                    </p>
                                    <input 
                                        type="text"
                                        value={inputText}
                                        onChange={(e) => setInputText(e.target.value)}
                                        className={formInputStyle + " mt-2"}
                                    />
                                </div>
                            )}
  
                      </div>
                        <div className="bg-gray-50 px-6 py-3 flex justify-end gap-3">
                            <button type="button" onClick={handleClose} className="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Hủy</button>
            
                <button 
                                type="button" 
                                onClick={handleConfirmClick} 
                                className={`px-4 py-2 bg-red-600 text-white rounded-md ${!isConfirmed ? 'opacity-50 cursor-not-allowed' : 'hover:bg-red-700'}`}
                                disabled={!isConfirmed}
                            >
                                Xác nhận
                            </button>
                        </div>
                    </div>
                </div>
            );
};
        {/* ----- KẾT THÚC NÂNG CẤP YÊU CẦU 3 (ConfirmModal) ----- */}


        {/* ----- BẮT ĐẦU NÂNG CẤP YÊU CẦU 2 (NewOrderModal) ----- */}
        const NewOrderModal = ({ isOpen, onClose, onSave, orderToEdit, userRole }) => {
            const initialFormState = { customerName: '', customerPhone: '', customerAddress: '', deviceType: 'Điện thoại', deviceModel: '', deviceSerial: '', devicePassword: '', initialCondition: '', reportedProblem: '', isWarranty: false, originalInvoiceId: '', otherDeviceType: '', completionTime: '', diagnosis: '', repairPlan: '', estimatedCost: '' };
const [formData, setFormData] = React.useState(initialFormState);
            
            const canEditTechnicalDetails = ['admin', 'manager', 'technician'].includes(userRole);
            const canEditCustomerDetails = ['admin', 'manager', 'receptionist'].includes(userRole);
React.useEffect(() => {
                if (isOpen) {
                    if (orderToEdit) {
                        setFormData({ ...initialFormState, ...orderToEdit, estimatedCost: formatNumber(orderToEdit.estimatedCost) });
                    } else {
       
                 const now = new Date();
                        const day = String(now.getDate()).padStart(2, '0');
                        const month = String(now.getMonth() + 1).padStart(2, '0');
                     
   const year = now.getFullYear();
                        const hours = String(now.getHours()).padStart(2, '0');
                        const minutes = String(now.getMinutes()).padStart(2, '0');
                        const defaultCompletionTime = `${hours}:${minutes} Ngày ${day}/${month}/${year}`;
         
               setFormData({ ...initialFormState, completionTime: defaultCompletionTime });
                    }
                }
            }, [isOpen, orderToEdit]);
if (!isOpen) return null;
            const handleChange = (e) => { 
                const { name, value, type, checked } = e.target;
let processedValue = type === 'checkbox' ? checked : value;
if (['customerName', 'customerAddress', 'deviceModel', 'initialCondition', 'reportedProblem', 'otherDeviceType', 'partName', 'serviceName', 'location', 'diagnosis', 'repairPlan'].includes(name)) {
                    processedValue = capitalizeWords(processedValue);
}
                if (name === 'estimatedCost') {
                    setFormData(prev => ({ ...prev, [name]: formatNumber(value) }));
} else {
                    setFormData(prev => ({ ...prev, [name]: processedValue }));
}
            };
const handleSubmit = (e) => { 
                e.preventDefault();
onSave({
                    ...formData,
                    estimatedCost: parseFormattedNumber(formData.estimatedCost)
                });
onClose(); 
            };
            return ( <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4"><div className="bg-white rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto"><div className="flex justify-between items-center p-4 border-b"><h2 className="text-xl font-bold text-gray-800">{orderToEdit ? 'Chỉnh sửa Phiếu Sửa chữa' : 'Tạo Phiếu Sửa Chữa Mới'}</h2><button onClick={onClose} className="text-gray-500 hover:text-gray-800"><CloseIcon /></button></div><form onSubmit={handleSubmit} className="p-6 space-y-4"><fieldset className="border rounded-md p-4" disabled={!canEditCustomerDetails}><legend className="text-lg font-semibold px-2 text-gray-700">Thông Tin Khách Hàng</legend><div className="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label className="block text-sm font-medium text-gray-600">Họ và Tên</label><input type="text" name="customerName" value={formData.customerName} onChange={handleChange} className={formInputStyle} required /></div><div><label className="block text-sm font-medium text-gray-600">Số Điện Thoại</label><input type="tel" name="customerPhone" value={formData.customerPhone} onChange={handleChange} className={formInputStyle} required /></div><div className="md:col-span-2"><label className="block text-sm font-medium text-gray-600">Địa chỉ</label><input type="text" name="customerAddress" value={formData.customerAddress} onChange={handleChange} className={formInputStyle} 
/></div></div></fieldset><fieldset className="border rounded-md p-4" disabled={!canEditCustomerDetails}><legend className="text-lg font-semibold px-2 text-gray-700">Thông Tin Thiết Bị</legend><div className="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label className="block text-sm font-medium text-gray-600">Loại Thiết Bị</label>
            
            {/* ----- BẮT ĐẦU NÂNG CẤP YÊU CẦU 2 ----- */}
            <select name="deviceType" value={formData.deviceType} onChange={handleChange} className={formInputStyle}>
                <option>Điện thoại</option>
                <option>Laptop</option>
                <option>Máy tính bảng</option>
                <option>Tivi</option>
                <option>Bếp từ</option>
                <option>Lò vi sóng</option>
                <option>Quạt</option>
                <option>Nồi cơm điện</option>
                <option>Amply</option>
                <option>Loa</option>
                <option>Loa kéo</option>
                <option>Đồng hồ thông minh</option>
                <option>Tai nghe</option>
                <option>Máy in</option>
                <option>Khác</option>
            </select>
            {/* ----- KẾT THÚC NÂNG CẤP YÊU CẦU 2 ----- */}
            
            </div>{formData.deviceType === 'Khác' && (<div><label className="block text-sm font-medium text-gray-600">Vui lòng nhập loại thiết bị</label><input type="text" name="otherDeviceType" value={formData.otherDeviceType} onChange={handleChange} className={formInputStyle} placeholder="VD: Loa Bluetooth, Tai nghe..." required /></div>)}<div><label className="block text-sm font-medium text-gray-600">Model Máy</label><input type="text" name="deviceModel" value={formData.deviceModel} onChange={handleChange} className={formInputStyle} required /></div><div><label className="block text-sm font-medium text-gray-600">IMEI / Serial</label><input type="text" name="deviceSerial" value={formData.deviceSerial} onChange={handleChange} className={formInputStyle} required /></div><div><label className="block text-sm font-medium text-gray-600">Mật khẩu màn hình</label><input type="text" name="devicePassword" value={formData.devicePassword} onChange={handleChange} className={formInputStyle} /></div></div></fieldset><fieldset className="border rounded-md p-4" disabled={!canEditCustomerDetails}><legend className="text-lg 
font-semibold px-2 text-gray-700">Tình Trạng & Vấn Đề</legend><div className="grid grid-cols-1 gap-4"><div><label className="block text-sm font-medium text-gray-600">Tình trạng máy khi nhận</label><textarea name="initialCondition" value={formData.initialCondition} onChange={handleChange} rows="3" className={formInputStyle} placeholder="Ví dụ: Trầy xước nhẹ ở góc, màn hình bị nứt..."></textarea></div><div><label className="block text-sm font-medium text-gray-600">Vấn đề khách báo</label><textarea name="reportedProblem" value={formData.reportedProblem} onChange={handleChange} rows="3" className={formInputStyle} placeholder="Ví dụ: Không lên nguồn, màn hình cảm ứng không nhạy..." required></textarea></div><div><label className="block text-sm font-medium text-gray-600">Thời gian hẹn trả</label><input type="text" name="completionTime" value={formData.completionTime} onChange={handleChange} className={formInputStyle} placeholder="VD: 3-5 ngày, 17h ngày 25/12..." /></div></div></fieldset><fieldset className="border rounded-md p-4" disabled={!canEditTechnicalDetails}><legend className="text-lg font-semibold px-2 text-gray-700">Chuẩn đoán & Phương án</legend><div className="grid grid-cols-1 gap-4"><div><label className="block text-sm font-medium text-gray-600">Chuẩn đoán sơ bộ</label><textarea name="diagnosis" 
value={formData.diagnosis || ''} onChange={handleChange} rows="2" className={formInputStyle} placeholder="VD: Lỗi IC nguồn, hỏng màn hình..."></textarea></div><div><label className="block text-sm font-medium text-gray-600">Phương án sửa chữa</label><textarea name="repairPlan" value={formData.repairPlan ||
''} onChange={handleChange} rows="2" className={formInputStyle} placeholder="VD: Thay IC nguồn, ép lại cổ cáp màn hình..."></textarea></div><div><label className="block text-sm font-medium text-gray-600">Giá dự kiến</label><input type="text" name="estimatedCost" value={formData.estimatedCost} onChange={handleChange} className={formInputStyle} placeholder="0" /></div></div></fieldset><fieldset className="border rounded-md p-4" disabled={!canEditCustomerDetails}><legend className="text-lg font-semibold px-2 text-gray-700">Bảo hành</legend><div className="space-y-2"><div className="flex items-center"><input id="isWarranty" name="isWarranty" type="checkbox" checked={formData.isWarranty} onChange={handleChange} className="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" /><label htmlFor="isWarranty" className="ml-2 block text-sm text-gray-900">Đây là phiếu bảo hành</label></div>{formData.isWarranty && (<div><label className="block text-sm font-medium text-gray-600">Mã hóa đơn/phiếu gốc</label><input type="text" name="originalInvoiceId" value={formData.originalInvoiceId} onChange={handleChange} className={formInputStyle} placeholder="Nhập mã hóa đơn gốc..." required /></div>)}</div></fieldset><div className="flex justify-end pt-4 space-x-2"><button type="button" onClick={onClose} className="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Hủy</button><button type="submit" className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Lưu</button></div></form></div></div>);
};
        {/* ----- KẾT THÚC NÂNG CẤP YÊU CẦU 2 (NewOrderModal) ----- */}
        
        const PrintableReceiptModal = ({ isOpen, onClose, order }) => {
            if (!isOpen) return null;
const printableRef = React.useRef(null);

            const handlePrint = () => {
                if (printableRef.current) {
                    printWithIframe(printableRef.current);
}
            };
const getFormattedDate = (date) => {
                if (!date) return 'N/A';
const d = date.toDate ? date.toDate() : new Date(date);
                return d.toLocaleString('vi-VN');
            };
return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
                    <div className="bg-white rounded-lg shadow-2xl w-full max-w-2xl max-h-[95vh] flex flex-col">
                        <div ref={printableRef} className="printable-area p-8 text-gray-800 text-sm overflow-y-auto">
                
            <div className="text-center mb-8">
                                <h1 className="text-2xl font-bold">TRUNG TÂM DỊCH VỤ VÀ PHÁT TRIỂN CÔNG NGHỆ ĐIỆN TỬ HÙNG NGỌC</h1>
                                <p className="text-sm">Địa chỉ: Đối diện Trường Mầm Non 
Phương Canh, Tổ 8 Tu Hoàng, Xuân Phương, Hà Nội </p>
                                <p className="text-sm">Điện thoại: 094.632.8386</p>
                            </div>
                           
 <h2 className="text-xl font-bold text-center mb-6">PHIẾU NHẬN MÁY</h2>
                            <div className="grid grid-cols-2 gap-4 mb-4">
                                <div><p><strong>Khách hàng:</strong> {order.customerName}</p><p><strong>Điện thoại:</strong> {order.customerPhone}</p></div>
                         
       <div className="text-right"><p><strong>Mã Phiếu:</strong> #{order.id.slice(0, 8).toUpperCase()}</p><p><strong>Ngày giờ nhận:</strong> {getFormattedDate(order.createdAt)}</p></div>
                            </div>
                            <div className="border-t border-b py-4 my-4">
                          
      <h3 className="font-bold mb-2">THÔNG TIN THIẾT BỊ</h3>
                                <p><strong>Loại máy:</strong> {order.deviceType}</p>
                                <p><strong>Model:</strong> {order.deviceModel}</p>
                      
          <p><strong>Số Serial/IMEI:</strong> {order.deviceSerial}</p>
                            </div>
                            <div className="border-b py-4 my-4">
                             
   <h3 className="font-bold mb-2">TÌNH TRẠNG & YÊU CẦU</h3>
                                <p><strong>Tình trạng khi nhận:</strong> {order.initialCondition ||
'Không có ghi chú'}</p>
                                <p><strong>Vấn đề khách báo:</strong> {order.reportedProblem}</p>
                                <p><strong>Thời gian hẹn trả:</strong> {order.completionTime ||
'Sẽ báo sau'}</p>
                            </div>
                             <div className="border-b py-4 my-4">
                                <h3 className="font-bold mb-2">CHUẨN ĐOÁN & PHƯƠNG 
ÁN</h3>
                                <p><strong>Chuẩn đoán:</strong> {order.diagnosis ||
'Chưa có'}</p>
                                <p><strong>Phương án sửa chữa:</strong> {order.repairPlan ||
'Chưa có'}</p>
                                <p><strong>Giá dự kiến:</strong> {order.estimatedCost ?
order.estimatedCost.toLocaleString('vi-VN') + ' đ' : 'Chưa có'}</p>
                            </div>
                            <div className="mt-6 text-xs text-gray-600">
                                <p className="font-bold">Điều khoản:</p>
 
                               <ul className="list-disc list-inside space-y-1">
                                    <li>Cửa hàng không chịu trách nhiệm về dữ liệu cá nhân của khách hàng.</li>
                 
                   <li>Quý khách vui lòng nhận lại máy trong vòng 30 ngày kể từ ngày hẹn.</li>
                                    <li>Phiếu này có giá trị thay cho giấy biên nhận.</li>
                      
          </ul>
                            </div>
                            <div className="flex justify-between mt-16">
                               
 <div>
                                    <p className="font-bold">Chữ ký khách hàng</p>
                                    <p className="mt-12">(Ký và ghi rõ họ tên)</p>
                 
               </div>
                                <div>
                                    <p className="font-bold">Chữ ký nhân viên</p>
             
                       <p className="mt-12">(Ký và ghi rõ họ tên)</p>
                                </div>
                            </div>
           
             </div>
                        <div className="p-4 border-t mt-auto flex justify-end items-center gap-4 no-print">
                            <button onClick={onClose} className="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Đóng</button>
                    
        <button onClick={handlePrint} className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700"><PrintIcon /> In Phiếu</button>
                        </div>
                    </div>
                </div>
            );
};

        const PrintableWarrantyModal = ({ isOpen, onClose, invoiceData, orderDetails }) => {
            if (!isOpen) return null;
const printableRef = React.useRef(null);
        
            const handlePrint = () => {
                 if (printableRef.current) {
                    printWithIframe(printableRef.current);
}
            };
const getFormattedDate = (date) => {
                if (!date) return 'N/A';
const d = date.toDate ? date.toDate() : new Date(date);
                return d.toLocaleDateString('vi-VN');
            };
const warrantyEndDate = (startDate) => {
                if (!startDate) return 'N/A';
const d = startDate.toDate ? startDate.toDate() : new Date(startDate);
                d.setMonth(d.getMonth() + 1);
                return d.toLocaleDateString('vi-VN');
}
        
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
                    <div className="bg-white rounded-lg shadow-2xl w-full max-w-2xl max-h-[95vh] flex flex-col">
                        <div ref={printableRef} 
className="printable-area p-8 text-gray-800 text-sm overflow-y-auto">
                            <div className="text-center mb-8">
                                <h1 className="text-2xl font-bold">TRUNG TÂM DỊCH VỤ VÀ PHÁT TRIỂN CÔNG NGHỆ ĐIỆN TỬ HÙNG NGỌC</h1>
                    
            <p className="text-sm">Địa chỉ: Đối diện Trường Mầm Non Phương Canh, Tổ 8 Tu Hoàng, Xuân Phương, Hà Nội </p>
                                <p className="text-sm">Điện thoại: 094.632.8386</p>
                            </div>
       
                     <h2 className="text-xl font-bold text-center mb-6">PHIẾU BẢO HÀNH</h2>
                            <div className="grid grid-cols-2 gap-4 mb-4">
                                <div>
         
                           <p><strong>Khách hàng:</strong> {invoiceData.customerName}</p>
                                    <p><strong>Điện thoại:</strong> {invoiceData.customerPhone}</p>
                                </div>
 
                               <div className="text-right">
                                    <p><strong>Số HĐ:</strong> #{invoiceData.id.slice(0, 8).toUpperCase()}</p>
                             
       <p><strong>Ngày sửa:</strong> {getFormattedDate(invoiceData.createdAt)}</p>
                                    <p><strong>Bảo hành đến:</strong> {warrantyEndDate(invoiceData.createdAt)}</p>
                                </div>
                    
        </div>
                             <div className="border-t border-b py-4 my-4">
                                <h3 className="font-bold mb-2">THÔNG TIN SẢN PHẨM/DỊCH VỤ</h3>
                     
           <p><strong>Thiết bị:</strong> {orderDetails.deviceType} - {orderDetails.deviceModel}</p>
                                <p><strong>Serial/IMEI:</strong> {orderDetails.deviceSerial}</p>
                                <p><strong>Nội dung sửa chữa:</strong></p>
                 
               <ul className="list-disc list-inside ml-4">
                                    {invoiceData.items.map(item => <li key={item.id}>{item.name}</li>)}
                                </ul>
           
                 </div>
                            <div className="mt-6 text-xs text-gray-600">
                                <p className="font-bold">Điều kiện bảo hành:</p>
                
                <ul className="list-disc list-inside space-y-1">
                                    <li>Sản phẩm được bảo hành miễn phí trong thời hạn 01 tháng kể từ ngày sửa.</li>
                              
      <li>Bảo hành cho các lỗi đã nhận sửa và toàn bộ linh kiện đã thay thế theo quy định của nhà cung cấp.</li>
                                    <li>Không bảo hành các trường hợp: rơi, vỡ, vào nước, thiên tai, hỏa hoạn, bị sốc điện hoặc do người dùng sử dụng sai cách.</li>
            
                        <li>Tem bảo hành phải còn nguyên vẹn.</li>
                                </ul>
                            </div>
          
              </div>
                        <div className="p-4 border-t mt-auto flex justify-end items-center gap-4 no-print">
                            <button onClick={onClose} className="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Đóng</button>
                   
         <button onClick={handlePrint} className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700"><PrintIcon /> In Phiếu</button>
                        </div>
                    </div>
                </div>
            );
};

        const InvoiceModal = ({ isOpen, onClose, order, onInvoiceSaved, user, addNotification, currentUserId }) => {
            const [items, setItems] = React.useState([]);
const [parts, setParts] = React.useState([]);
            const [services, setServices] = React.useState([]);
            const [paymentMethod, setPaymentMethod] = React.useState('Tiền mặt');
const appId = React.useMemo(() => typeof __app_id !== 'undefined' ? __app_id : 'default-app-id', []);
React.useEffect(() => {
                if (isOpen) {
                    const dataPath = `artifacts/${appId}/users/${currentUserId}`;
                    const fetchPartsAndServices = async () => {
                        try {
      
                      const partsSnapshot = await db.collection(`${dataPath}/inventoryParts`).get();
                            setParts(partsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));

                            const servicesSnapshot = await db.collection(`${dataPath}/services`).get();
        
                    setServices(servicesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                        } catch(e) {
                            console.error("Lỗi tải linh kiện/dịch vụ cho hóa đơn:", e);
            
                addNotification('Lỗi tải dữ liệu linh kiện.', 'error');
                        }
                    };
                    fetchPartsAndServices();
              
      if(order.repairPlan) {
                        setItems([{ id: 'initial-item', name: order.repairPlan, quantity: 1, price: order.estimatedCost ||
0 }]);
                    } else {
                        setItems([]);
}
                }
            }, [isOpen, order, appId, currentUserId]);
const handleAddItem = () => {
                setItems([...items, { id: `item-${Date.now()}`, name: '', quantity: 1, price: 0 }]);
};

            const handleItemChange = (index, field, value) => {
                const newItems = [...items];
newItems[index][field] = value;
                if (field === 'name') {
                     const selectedPart = parts.find(p => p.partName === value);
const selectedService = services.find(s => s.serviceName === value);
                     if (selectedPart) {
                         newItems[index]['price'] = selectedPart.salePrice ||
0;
                     } else if (selectedService) {
                         newItems[index]['price'] = selectedService.laborCost ||
0;
                     }
                }
                setItems(newItems);
};

            const handleRemoveItem = (index) => {
                const newItems = items.filter((_, i) => i !== index);
setItems(newItems);
            };

            const total = React.useMemo(() => {
                return items.reduce((sum, item) => sum + (parseFormattedNumber(item.price) * item.quantity), 0);
            }, [items]);
const handleSave = async () => {
                if (!user || !db) return;
const dataPath = `artifacts/${appId}/users/${order.ownerId || currentUserId}`;

                const invoiceData = {
                    orderId: order.id,
                    customerName: order.customerName,
                    customerPhone: order.customerPhone,
                    items: items.map(item => ({...item, price: parseFormattedNumber(item.price)})),
   
                 total: total,
                    paymentMethod: paymentMethod,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                };
try {
                    const batch = db.batch();
const invoiceRef = db.collection(`${dataPath}/invoices`).doc();
                    batch.set(invoiceRef, invoiceData);

                    const orderRef = db.collection(`${dataPath}/repairOrders`).doc(order.id);
                    batch.update(orderRef, { status: 'Đã trả khách' });

                    await batch.commit();
await logAction(user, 'create', 'Hóa đơn', `Tạo hóa đơn #${invoiceRef.id.slice(0,6)} cho phiếu #${order.id.slice(0,6)}.`, invoiceRef.id);
                    addNotification('Tạo hóa đơn thành công!', 'success');
onInvoiceSaved({ ...invoiceData, id: invoiceRef.id, createdAt: new Date() }, order);
                } catch (e) {
                    console.error("Lỗi khi lưu hóa đơn (batch):", e);
addNotification('Lỗi khi lưu hóa đơn.', 'error');
                }
            };
if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
                    <div className="bg-white rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col">
                        <div className="flex justify-between items-center p-4 border-b">
             
               <h2 className="text-xl font-bold text-gray-800">Tạo Hóa đơn cho Phiếu #{order.id.slice(0,6)}</h2>
                            <button onClick={onClose} className="text-gray-500 hover:text-gray-800"><CloseIcon /></button>
                        </div>
                     
   <div className="p-6 space-y-4 overflow-y-auto">
                            {items.map((item, index) => (
                                <div key={item.id} className="grid grid-cols-12 gap-2 items-center">
                          
          <input
                                        list="item-suggestions"
                                        type="text"
          
                              placeholder="Tên mục (linh kiện/dịch vụ)"
                                        value={item.name}
                          
              onChange={(e) => handleItemChange(index, 'name', e.target.value)}
                                        className={formInputStyle + " col-span-6"}
                                    />
   
                                 <input
                                        type="number"
                           
             placeholder="SL"
                                        value={item.quantity}
                                        onChange={(e) => handleItemChange(index, 'quantity', parseInt(e.target.value, 10))}
  
                                      className={formInputStyle + " col-span-2"}
                                        min="1"
                   
                 />
                                    <input
                                        type="text"
       
                                 placeholder="Đơn giá"
                                        value={formatNumber(item.price)}
                          
              onChange={(e) => handleItemChange(index, 'price', e.target.value)}
                                        className={formInputStyle + " col-span-3"}
                                    />
   
                                 <button onClick={() => handleRemoveItem(index)} className="text-red-500 hover:text-red-700 col-span-1"><DeleteIcon /></button>
                                </div>
                            
))}
                             <datalist id="item-suggestions">
                                 {services.map(s => <option key={s.id} value={s.serviceName} />)}
                                
 {parts.map(p => <option key={p.id} value={p.partName} />)}
                             </datalist>
                            <button onClick={handleAddItem} className="text-sm text-blue-600 hover:underline">+ Thêm mục</button>
                            <div className="border-t pt-4 
mt-4 space-y-2">
                                <div className="flex justify-between">
                                    <span className="font-semibold">Tổng cộng:</span>
                           
         <span className="font-bold text-lg">{formatNumber(total)} đ</span>
                                </div>
                                <div>
                        
            <label className="block text-sm font-medium text-gray-600">Phương thức thanh toán</label>
                                    <select value={paymentMethod} onChange={(e) => setPaymentMethod(e.target.value)} className={formInputStyle}>
                                        
<option>Tiền mặt</option>
                                        <option>Chuyển khoản</option>
                                    </select>
                      
          </div>
                            </div>
                        </div>
                        <div className="flex justify-end p-4 border-t space-x-2">
         
                   <button type="button" onClick={onClose} className="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Hủy</button>
                            <button type="button" onClick={handleSave} className="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">Lưu & In Hóa đơn</button>
                        </div>
         
           </div>
                </div>
            );
};

        // --- CÁC TRANG CHỨC NĂNG (PAGES) ---
        const RepairOrdersPage = ({ user, userRole, addNotification, viewingAs, allUsers, currentUserId }) => {
            const [orders, setOrders] = React.useState([]);
const [isModalOpen, setIsModalOpen] = React.useState(false);
            const [editingOrder, setEditingOrder] = React.useState(null);
            const [isInvoiceModalOpen, setIsInvoiceModalOpen] = React.useState(false);
            const [selectedOrderForInvoice, setSelectedOrderForInvoice] = React.useState(null);
const [receiptToPrint, setReceiptToPrint] = React.useState(null);
            const [warrantyData, setWarrantyData] = React.useState(null);
            const [loading, setLoading] = React.useState(true);
            const [error, setError] = React.useState(null);
const [filterStatus, setFilterStatus] = React.useState('Tất cả');
            const repairStatuses = React.useMemo(() => ["Mới nhận", "Đang kiểm tra", "Chờ báo giá", "Chờ linh kiện", "Đang sửa", "Sửa xong, chờ QC", "Sẵn sàng trả khách", "Đã trả khách", "Báo giá không sửa"], []);
const appId = React.useMemo(() => typeof __app_id !== 'undefined' ? __app_id : 'default-app-id', []);
const isViewingAll = userRole === 'admin' && viewingAs === 'all';
            
            const canCreateOrder = ['admin', 'manager', 'receptionist'].includes(userRole);
const canEditOrder = ['admin', 'manager', 'receptionist', 'technician'].includes(userRole);
            const canCreateInvoice = ['admin', 'manager', 'receptionist'].includes(userRole);
            const canExport = ['admin', 'manager'].includes(userRole);
React.useEffect(() => {
                if (!user || !db || !viewingAs) {
                    setLoading(false);
                    return;
                }
                setLoading(true);

    
            if (isViewingAll) {
                    const fetchAllOrders = async () => {
                        try {
                            const promises = allUsers.map(u => 
  
                              db.collection(`artifacts/${appId}/users/${u.id}/repairOrders`).get()
                            );
                            const snapshots = await Promise.all(promises);
          
                  const allOrdersData = [];
                            snapshots.forEach((snapshot, index) => {
                                snapshot.docs.forEach(doc => {
              
                      allOrdersData.push({ 
                                        id: doc.id, 
                                   
     ...doc.data(), 
                                        ownerEmail: allUsers[index].email,
                                        ownerId: allUsers[index].id
            
                        });
});
                            });
                            allOrdersData.sort((a,b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));
                            setOrders(allOrdersData);
} catch (err) {
                            console.error("Lỗi tải tất cả đơn hàng:", err);
setError("Lỗi tải dữ liệu từ các cửa hàng.");
                        } finally {
                            setLoading(false);
}
                    };
fetchAllOrders();
                } else {
                    const targetUserId = userRole === 'admin' ?
viewingAs : currentUserId;
                    const q = db.collection(`artifacts/${appId}/users/${targetUserId}/repairOrders`).orderBy("createdAt", "desc");
                    const unsubscribe = q.onSnapshot((snapshot) => { 
                        setOrders(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data(), ownerId: targetUserId }))); 
                        setLoading(false); 
                    }, (err) => { 
    
                    console.error("Lỗi: ", err); 
                        setError("Lỗi tải dữ liệu."); 
                        setLoading(false); 
                    });
return () => unsubscribe();
                }
            }, [user, db, viewingAs, userRole, allUsers, currentUserId, appId, isViewingAll]);
const handleSaveOrder = React.useCallback(async (orderData) => {
                const targetUserId = (userRole === 'admin' && viewingAs !== 'all') ? viewingAs : currentUserId;
                if (!user || !db || !targetUserId) {
                    addNotification("Không thể xác định cửa hàng để lưu dữ liệu.", "error");
             
       return;
                }
                
                const dataPath = `artifacts/${appId}/users/${targetUserId}`;
                const { id, ...dataToSave } = orderData;
                
    
            if (dataToSave.deviceType === 'Khác') {
                    dataToSave.deviceType = dataToSave.otherDeviceType || 'Khác (không rõ)';
                }
                delete dataToSave.otherDeviceType;

                try {
        
            if (id) {
                        await db.collection(`${dataPath}/repairOrders`).doc(id).update(dataToSave);
                        await logAction(user, 'update', 'Phiếu Sửa Chữa', `Cập nhật phiếu #${id.slice(0,6)} cho KH ${dataToSave.customerName}.`, id);
addNotification('Cập nhật phiếu thành công!', 'success');
                    } else {
                        const orderRef = await db.collection(`${dataPath}/repairOrders`).add({ ...dataToSave, status: 'Mới nhận', createdAt: firebase.firestore.FieldValue.serverTimestamp(), createdBy: user.uid });
await orderRef.update({ orderId: orderRef.id });
                        setReceiptToPrint({ ...dataToSave, id: orderRef.id, createdAt: new Date() });
await logAction(user, 'create', 'Phiếu Sửa Chữa', `Tạo mới phiếu cho KH ${dataToSave.customerName}.`, orderRef.id);
                        addNotification('Tạo phiếu mới thành công!', 'success');
}
                    const customerDocRef = db.collection(`${dataPath}/customers`).doc(dataToSave.customerPhone);
await customerDocRef.set({ customerName: dataToSave.customerName, customerPhone: dataToSave.customerPhone, customerAddress: dataToSave.customerAddress, lastSeen: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });
} catch (e) { 
                    console.error("Lỗi: ", e);
addNotification('Lỗi khi lưu phiếu.', 'error');
                }
            }, [user, appId, addNotification, userRole, viewingAs, currentUserId]);
const handleStatusChange = React.useCallback(async (orderId, newStatus, ownerId) => {
                const targetUserId = ownerId || currentUserId;
                if (!user || !db || !targetUserId) return;
                
                const docRef = db.collection(`artifacts/${appId}/users/${targetUserId}/repairOrders`).doc(orderId);
              
  try {
                    const oldDoc = await docRef.get();
                    if (oldDoc.exists) {
                        const oldStatus = oldDoc.data().status;
                        
await docRef.update({ status: newStatus });
                        await logAction(user, 'status_change', 'Phiếu Sửa Chữa', `Đổi TT phiếu #${orderId.slice(0,6)} từ '${oldStatus}' sang '${newStatus}'.`, orderId);
                        addNotification('Cập nhật trạng thái thành công!', 'success');
                    }
        
        } catch(e) { 
                    console.error("Lỗi:", e); 
                    addNotification('Lỗi cập nhật trạng thái.', 'error');
}
            }, [user, appId, addNotification, currentUserId]);
const handleOpenInvoiceModal = (order) => { setSelectedOrderForInvoice(order); setIsInvoiceModalOpen(true); }
            const handleOpenEditModal = (order) => { setEditingOrder(order);
setIsModalOpen(true); }
            const handleOpenCreateModal = () => { 
                if (isViewingAll) {
                    addNotification("Vui lòng chọn một cửa hàng cụ thể để tạo phiếu.", "error");
return;
                }
                setEditingOrder(null); 
                setIsModalOpen(true);
}

            const handleInvoiceSaved = (invoice, orderDetails) => {
                setIsInvoiceModalOpen(false);
setWarrantyData({ ...invoice, orderDetails });
            };

            const getStatusColor = React.useCallback((status) => {
                const colors = { 'Mới nhận': 'bg-blue-100 text-blue-800', 'Đang kiểm tra': 'bg-yellow-100 text-yellow-800', 'Chờ báo giá': 'bg-orange-100 text-orange-800', 'Chờ linh kiện': 'bg-purple-100 text-purple-800', 'Đang sửa': 'bg-indigo-100 text-indigo-800', 'Sửa xong, chờ QC': 'bg-teal-100 text-teal-800', 'Sẵn sàng trả khách': 'bg-green-100 text-green-800', 'Đã trả khách': 'bg-gray-100 text-gray-800', 'Báo giá không sửa': 'bg-red-100 text-red-800' };
                return colors[status] || 'bg-gray-100 text-gray-500';
    
        }, []);
const filteredOrders = React.useMemo(() => filterStatus === 'Tất cả' ? orders : orders.filter(order => order.status === filterStatus), [orders, filterStatus]);
return (
                <div className="p-4 md:p-6 lg:p-8 bg-slate-100 min-h-full">
                    <div className="flex flex-col md:flex-row justify-between items-center mb-6 gap-4"><h1 className="text-2xl md:text-3xl font-bold text-gray-800">Quản lý Sửa chữa</h1>
                        <div className="flex gap-2">
                  
          {canExport && <button onClick={() => exportToCSV(orders.map(o => ({'MaPhieu': o.id, 'CuaHang': o.ownerEmail || user.email, 'TenKhachHang': o.customerName, 'SoDienThoai': o.customerPhone, 'LoaiThietBi': o.deviceType, 'Model': o.deviceModel, 'TrangThai': o.status, 'NgayNhan': o.createdAt?.toDate().toLocaleDateString('vi-VN')})), 'danh-sach-sua-chua.csv')} className="flex items-center gap-2 px-4 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700"><DownloadIcon />Xuất File</button>}
                            {canCreateOrder && <button onClick={handleOpenCreateModal} className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 disabled:bg-blue-300" disabled={isViewingAll}><PlusIcon />Tạo Phiếu Mới</button>}
     
                   </div>
                    </div>
                    <div className="mb-4"><label htmlFor="statusFilter" className="block text-sm font-medium text-gray-700 mb-1">Lọc theo trạng thái:</label><select id="statusFilter" value={filterStatus} onChange={(e) => setFilterStatus(e.target.value)} className={inputStyle + ' max-w-xs'}><option>Tất cả</option>{repairStatuses.map(status => <option key={status} value={status}>{status}</option>)}</select></div>
                 
   {loading ? <p className="text-center py-10">Đang tải...</p> : error ?
<p className="text-center py-10 text-red-500">{error}</p> : (<div className="bg-white rounded-lg shadow overflow-x-auto"><table className="min-w-full divide-y divide-gray-200"><thead className="bg-gray-50"><tr>{isViewingAll && <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cửa hàng</th>}<th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mã Phiếu</th><th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Khách Hàng</th><th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Thiết Bị</th><th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vấn Đề</th><th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ngày Nhận</th><th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Giá Dự Kiến</th><th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Trạng Thái</th><th scope="col" className="relative px-6 
py-3"></th></tr></thead><tbody className="bg-white divide-y divide-gray-200">{filteredOrders.length > 0 ? filteredOrders.map(order => (<tr key={order.id} className="hover:bg-gray-50">{isViewingAll && <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{order.ownerEmail}</td>}<td className="px-6 py-4 whitespace-nowrap text-sm font-mono text-slate-600">#{order.id.slice(0,6)}</td><td className="px-6 py-4 whitespace-nowrap"><div className="text-sm font-medium text-gray-900">{order.customerName}</div><div className="text-sm text-gray-500">{order.customerPhone}</div></td><td className="px-6 py-4 whitespace-nowrap"><div className="text-sm text-gray-900">{order.deviceModel}</div><div className="text-sm text-gray-500">{order.deviceType}</div></td><td className="px-6 py-4 max-w-xs whitespace-normal"><p className="text-sm text-gray-900 truncate">{order.reportedProblem}</p></td><td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{order.createdAt?.toDate ? order.createdAt.toDate().toLocaleDateString('vi-VN') : 'N/A'}</td><td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{(order.estimatedCost ||
0).toLocaleString('vi-VN')} đ</td><td className="px-6 py-4 whitespace-nowrap"><div className="flex items-center gap-2"><select value={order.status} onChange={(e) => handleStatusChange(order.id, e.target.value, order.ownerId)} className={`text-xs font-semibold rounded-full px-3 py-1 border-0 focus:ring-2 focus:ring-offset-1 ${getStatusColor(order.status)}`} style={{appearance: 'none', WebkitAppearance: 'none'}} disabled={isViewingAll}>{repairStatuses.map(status => <option key={status} value={status}>{status}</option>)}</select>{order.isWarranty && <span title="Phiếu bảo hành" className="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-pink-100 text-pink-800"><WarrantyIcon/></span>}</div></td><td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2"><button onClick={() => setReceiptToPrint(order)} className="text-gray-500 hover:text-gray-800" title="In Phiếu hẹn"><PrintIcon /></button>
                                       
  {!isViewingAll && canEditOrder && <button onClick={() => handleOpenEditModal(order)} className="text-indigo-600 hover:text-indigo-900"><EditIcon /></button>}
                                         {!isViewingAll && canCreateInvoice && order.status === 'Sẵn sàng trả khách' && (<button onClick={() => handleOpenInvoiceModal(order)} className="text-green-600 hover:text-green-900">Tạo Hóa đơn</button>)}
                             
        </td></tr>)) : (<tr><td colSpan={isViewingAll ?
9 : 8} className="px-6 py-4 text-center text-gray-500">Không có phiếu sửa chữa nào.</td></tr>)}</tbody></table></div>)}
                    <NewOrderModal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} onSave={handleSaveOrder} orderToEdit={editingOrder} userRole={userRole} />
                    {selectedOrderForInvoice && <InvoiceModal isOpen={isInvoiceModalOpen} onClose={() => setIsInvoiceModalOpen(false)} order={selectedOrderForInvoice} onInvoiceSaved={handleInvoiceSaved} user={user} addNotification={addNotification} currentUserId={currentUserId} />}
                    {receiptToPrint && <PrintableReceiptModal isOpen={!!receiptToPrint} onClose={() => setReceiptToPrint(null)} order={{...receiptToPrint, createdAt: 
receiptToPrint.createdAt?.toDate ? receiptToPrint.createdAt.toDate() : new Date()}} />}
                    {warrantyData && <PrintableWarrantyModal isOpen={!!warrantyData} onClose={() => setWarrantyData(null)} invoiceData={warrantyData} orderDetails={orders.find(o => o.id === warrantyData.orderId)} />}
                </div>
            );
};

        const CustomersPage = ({ user, userRole, viewingAs, currentUserId, allUsers }) => {
          const [customers, setCustomers] = React.useState([]);
const [loading, setLoading] = React.useState(true); const [error, setError] = React.useState(null); const [searchTerm, setSearchTerm] = React.useState(""); const [selectedCustomer, setSelectedCustomer] = React.useState(null);
const [isHistoryModalOpen, setIsHistoryModalOpen] = React.useState(false);
          const appId = React.useMemo(() => typeof __app_id !== 'undefined' ? __app_id : 'default-app-id', []);
const isViewingAll = userRole === 'admin' && viewingAs === 'all';
React.useEffect(() => {
              if (!user || !db || !viewingAs) { setLoading(false); return; }
              setLoading(true);

              if (isViewingAll) {
                  const fetchAllCustomers = async () => {
                     
 try {
                          const promises = allUsers.map(u => 
                              db.collection(`artifacts/${appId}/users/${u.id}/customers`).get()
                          );
           
               const snapshots = await Promise.all(promises);
                          const allCustomersData = {}; // Use object to deduplicate by phone number
                          snapshots.forEach((snapshot, index) => {
               
               snapshot.docs.forEach(doc => {
                                  const customerData = { id: doc.id, ...doc.data(), ownerEmail: allUsers[index].email, ownerId: allUsers[index].id };
                                  if (!allCustomersData[customerData.customerPhone] || allCustomersData[customerData.customerPhone].lastSeen 
< customerData.lastSeen) {
                                      allCustomersData[customerData.customerPhone] = customerData;
}
                              });
});
                          const mergedCustomers = Object.values(allCustomersData).sort((a,b) => (b.lastSeen?.toMillis() || 0) - (a.lastSeen?.toMillis() || 0));
                          setCustomers(mergedCustomers);
} catch (err) {
                          console.error("Lỗi tải tất cả khách hàng:", err);
setError("Lỗi tải dữ liệu khách hàng.");
                      } finally {
                          setLoading(false);
}
                  };
                  fetchAllCustomers();
} else {
                  const targetUserId = userRole === 'admin' ?
viewingAs : currentUserId;
                  const q = db.collection(`artifacts/${appId}/users/${targetUserId}/customers`).orderBy("lastSeen", "desc");
                  const unsubscribe = q.onSnapshot((snapshot) => { setCustomers(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data(), ownerId: targetUserId }))); setLoading(false); }, (err) => { console.error("Lỗi:", err); setError("Lỗi tải dữ liệu."); setLoading(false); });
return () => unsubscribe();
              }
          }, [user, db, viewingAs, userRole, allUsers, currentUserId, appId, isViewingAll]);
const handleViewHistory = (customer) => { setSelectedCustomer(customer); setIsHistoryModalOpen(true); };
          const filteredCustomers = React.useMemo(() => customers.filter(c => c.customerName?.toLowerCase().includes(searchTerm.toLowerCase()) || c.customerPhone?.includes(searchTerm)), [customers, searchTerm]);
return ( <div className="p-4 md:p-6 lg:p-8 bg-slate-100 min-h-full"><div className="flex flex-col md:flex-row justify-between items-center mb-6 gap-4"><h1 className="text-2xl md:text-3xl font-bold text-gray-800">Quản lý Khách hàng</h1>
          {['admin', 'manager'].includes(userRole) && (
              <button onClick={() => exportToCSV(customers.map(c => ({'CuaHang': c.ownerEmail || user.email, 'TenKhachHang': c.customerName, 'SoDienThoai': c.customerPhone, 'DiaChi': c.customerAddress})), 'danh-sach-khach-hang.csv')} className="flex items-center gap-2 px-4 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700"><DownloadIcon />Xuất File</button>
          )}
          </div><div className="mb-4"><div className="relative"><span className="absolute 
inset-y-0 left-0 flex items-center pl-3 text-slate-400"><SearchIcon /></span><input type="text" placeholder="Tìm kiếm khách hàng..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className={inputStyle + " pl-10 max-w-sm"}/></div></div>{loading ?
<p className="text-center py-10">Đang tải...</p> : error ? <p className="text-center py-10 text-red-500">{error}</p> : (<div className="bg-white rounded-lg shadow overflow-x-auto"><table className="min-w-full divide-y divide-gray-200"><thead className="bg-gray-50"><tr>{isViewingAll && <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cửa hàng</th>}<th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tên</th><th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">SĐT</th><th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Địa Chỉ</th><th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lần cuối ghé</th><th scope="col" className="relative px-6 py-3"><span className="sr-only">Hành động</span></th></tr></thead><tbody className="bg-white divide-y divide-gray-200">{filteredCustomers.length > 0 ?
filteredCustomers.map(customer => (<tr key={customer.id} className="hover:bg-gray-50">{isViewingAll && <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{customer.ownerEmail}</td>}<td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{customer.customerName}</td><td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{customer.customerPhone}</td><td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{customer.customerAddress || 'N/A'}</td><td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{customer.lastSeen?.toDate ? customer.lastSeen.toDate().toLocaleDateString('vi-VN') : 'N/A'}</td><td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium"><button onClick={() => handleViewHistory(customer)} className="text-indigo-600 hover:text-indigo-900 inline-flex items-center gap-1"><HistoryIcon /> Xem Lịch sử</button></td></tr>)) : (<tr><td colSpan={isViewingAll ? 6 : 5} className="px-6 py-4 text-center text-gray-500">Không tìm thấy khách hàng.</td></tr>)}</tbody></table></div>)}<CustomerHistoryModal isOpen={isHistoryModalOpen} onClose={() => setIsHistoryModalOpen(false)} customer={selectedCustomer} currentUserId={currentUserId} /></div> );
};

        const CustomerHistoryModal = ({ isOpen, onClose, customer, currentUserId }) => {
            const [orders, setOrders] = React.useState([]);
const [loading, setLoading] = React.useState(false);
            const appId = React.useMemo(() => typeof __app_id !== 'undefined' ? __app_id : 'default-app-id', []);
React.useEffect(() => {
                const historyOwnerId = customer?.ownerId || currentUserId;

                if (!isOpen || !customer || !db || !historyOwnerId) { 
                    setOrders([]); 
                    return; 
          
      }

                setLoading(true);
                const q = db.collection(`artifacts/${appId}/users/${historyOwnerId}/repairOrders`).where("customerPhone", "==", customer.customerPhone);
                
                const getHistory = async () => { 
                  
  try { 
                        const querySnapshot = await q.get(); 
                        const ordersData = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        ordersData.sort((a,b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));
  
                      setOrders(ordersData);
                    } catch (err) { 
                        console.error("Lỗi khi lấy lịch sử sửa chữa:", err); 
                    } finally 
{ 
                        setLoading(false);
} 
                };
                getHistory();
}, [isOpen, customer, currentUserId, appId]);

            if (!isOpen) return null;
            return ( <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4"><div className="bg-white rounded-lg shadow-2xl w-full max-w-3xl max-h-[90vh] flex flex-col"><div className="flex justify-between items-center p-4 border-b"><h2 className="text-xl font-bold text-gray-800">Lịch sử sửa chữa: {customer.customerName}</h2><button onClick={onClose} className="text-gray-500 hover:text-gray-800"><CloseIcon /></button></div><div className="p-6 overflow-y-auto">{loading ? <p>Đang tải...</p> : ( orders.length > 0 ? ( <ul className="space-y-4">{orders.map(order => ( <li key={order.id} className="p-4 border rounded-md bg-gray-50"><p><strong>Ngày nhận:</strong> {order.createdAt?.toDate ? order.createdAt.toDate().toLocaleDateString('vi-VN') : 'N/A'}</p><p><strong>Thiết bị:</strong> {order.deviceType} - {order.deviceModel} ({order.deviceSerial})</p><p><strong>Vấn đề:</strong> {order.reportedProblem}</p><p><strong>Trạng thái:</strong> {order.status}</p></li> ))}</ul> ) : <p>Không có lịch sử.</p> )}</div></div></div> );
};

        const PartFormModal = ({ isOpen, onClose, onSave, part }) => {
            const [formData, setFormData] = React.useState({ partName: '', location: '', stockQuantity: '', importPrice: '', salePrice: '', lowStockThreshold: '5' });
React.useEffect(() => { 
                if(part) {
                    setFormData({ 
                        ...part,
                        stockQuantity: formatNumber(part.stockQuantity),
          
              importPrice: formatNumber(part.importPrice),
                        salePrice: formatNumber(part.salePrice),
                        lowStockThreshold: formatNumber(part.lowStockThreshold),
                    });
               
 } else {
                    setFormData({ partName: '', location: '', stockQuantity: '', importPrice: '', salePrice: '', lowStockThreshold: '5' });
                }
            }, [part, isOpen]);
if (!isOpen) return null;
            const handleChange = (e) => {
                const { name, value } = e.target;
if (['stockQuantity', 'importPrice', 'salePrice', 'lowStockThreshold'].includes(name)) {
                    setFormData(prev => ({ ...prev, [name]: formatNumber(value) }));
} else {
                    setFormData(prev => ({ ...prev, [name]: capitalizeWords(value) }));
}
            };
const handleSubmit = (e) => { 
                e.preventDefault();
const dataToSave = {
                    ...formData,
                    stockQuantity: parseFormattedNumber(formData.stockQuantity),
                    importPrice: parseFormattedNumber(formData.importPrice),
                    salePrice: parseFormattedNumber(formData.salePrice),
              
      lowStockThreshold: parseFormattedNumber(formData.lowStockThreshold),
                };
onSave(dataToSave); 
                onClose(); 
            };
            return ( <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4"><div className="bg-white rounded-lg shadow-2xl w-full max-w-lg"><div className="flex justify-between items-center p-4 border-b"><h2 className="text-xl font-bold text-gray-800">{part ? 'Chỉnh sửa Linh kiện' : 'Thêm Linh kiện mới'}</h2><button onClick={onClose} className="text-gray-500 hover:text-gray-800"><CloseIcon /></button></div><form onSubmit={handleSubmit} className="p-6 space-y-4"><div><label className="block text-sm font-medium text-gray-600">Tên Linh kiện</label><input type="text" name="partName" value={formData.partName} onChange={handleChange} className={formInputStyle} required /></div><div><label className="block text-sm font-medium text-gray-600">Vị trí</label><input type="text" name="location" value={formData.location || ''} onChange={handleChange} className={formInputStyle} placeholder="VD: Kệ A, Ngăn 2"/></div><div className="grid grid-cols-2 gap-4"><div><label className="block text-sm font-medium text-gray-600">Số lượng tồn</label><input type="text" name="stockQuantity" value={formData.stockQuantity} onChange={handleChange} className={formInputStyle} placeholder="0" required /></div><div><label className="block text-sm font-medium text-gray-600">Ngưỡng báo hết hàng</label><input type="text" 
name="lowStockThreshold" value={formData.lowStockThreshold} onChange={handleChange} className={formInputStyle} placeholder="5" required /></div></div><div className="grid grid-cols-2 gap-4"><div><label className="block text-sm font-medium text-gray-600">Giá nhập</label><input type="text" name="importPrice" value={formData.importPrice} onChange={handleChange} className={formInputStyle} placeholder="0" required /></div><div><label className="block text-sm font-medium text-gray-600">Giá bán</label><input type="text" name="salePrice" value={formData.salePrice} onChange={handleChange} className={formInputStyle} placeholder="0" required /></div></div><div className="flex justify-end pt-4 space-x-2"><button type="button" onClick={onClose} className="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Hủy</button><button type="submit" className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Lưu</button></div></form></div></div> );
};

        const PrintableInventoryModal = ({ isOpen, onClose, parts }) => {
            if (!isOpen) return null;
const printableRef = React.useRef(null);

            const handlePrint = () => {
                if (printableRef.current) {
                    printWithIframe(printableRef.current);
}
            };
return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
                    <div className="bg-white rounded-lg shadow-2xl w-full max-w-4xl max-h-[95vh] flex flex-col">
                        <div ref={printableRef} className="printable-area p-8 text-gray-800 text-sm overflow-y-auto">
                
            <div className="text-center mb-8">
                                <h1 className="text-2xl font-bold">TRUNG TÂM DỊCH VỤ VÀ PHÁT TRIỂN CÔNG NGHỆ ĐIỆN TỬ HÙNG NGỌC</h1>
                                <p className="text-sm">Ngày in: {new Date().toLocaleDateString('vi-VN')}</p>
    
                        </div>
                            <h2 className="text-xl font-bold text-center mb-6">BÁO CÁO TỒN KHO LINH KIỆN</h2>
                            <table className="min-w-full divide-y divide-gray-300 mb-4">
       
                         <thead className="bg-gray-100">
                                    <tr>
                                      
  <th className="px-4 py-2 text-left text-sm font-semibold">STT</th>
                                        <th className="px-4 py-2 text-left text-sm font-semibold">Tên Linh kiện</th>
                                        <th className="px-4 py-2 text-left text-sm font-semibold">Vị 
trí</th>
                                        <th className="px-4 py-2 text-right text-sm font-semibold">Số lượng Tồn</th>
                                        <th className="px-4 py-2 text-right text-sm font-semibold">Giá Nhập</th>
       
                                 <th className="px-4 py-2 text-right text-sm font-semibold">Giá Bán</th>
                                    </tr>
                         
       </thead>
                                <tbody>
                                    {parts.map((part, index) => (
                      
                  <tr key={part.id} className="border-b">
                                            <td className="px-4 py-2">{index + 1}</td>
                                
            <td className="px-4 py-2">{part.partName}</td>
                                            <td className="px-4 py-2">{part.location ||
''}</td>
                                            <td className="px-4 py-2 text-right">{(part.stockQuantity || 0).toLocaleString('vi-VN')}</td>
                                            <td className="px-4 py-2 text-right">{(part.importPrice || 0).toLocaleString('vi-VN')} đ</td>
 
                                           <td className="px-4 py-2 text-right">{(part.salePrice || 0).toLocaleString('vi-VN')} đ</td>
                                        </tr>
           
                         ))}
                                </tbody>
                            </table>
               
         </div>
                        <div className="p-4 border-t mt-auto flex justify-end items-center gap-4 no-print">
                             <button onClick={onClose} className="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Đóng</button>
                       
      <button onClick={handlePrint} className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700"><PrintIcon /> In Danh sách</button>
                        </div>
                    </div>
                </div>
            );
};

        const InventoryPage = ({ user, userRole, addNotification, viewingAs, currentUserId }) => {
            const [parts, setParts] = React.useState([]);
const [loading, setLoading] = React.useState(true); const [error, setError] = React.useState(null); const [searchTerm, setSearchTerm] = React.useState(""); const [isModalOpen, setIsModalOpen] = React.useState(false);
const [editingPart, setEditingPart] = React.useState(null);
            const [isPrintModalOpen, setIsPrintModalOpen] = React.useState(false);
            const [confirmDelete, setConfirmDelete] = React.useState(null);
const appId = React.useMemo(() => typeof __app_id !== 'undefined' ? __app_id : 'default-app-id', []);
const isViewingAll = userRole === 'admin' && viewingAs === 'all';
            
            const canManageInventory = ['admin', 'manager'].includes(userRole) && !isViewingAll;
React.useEffect(() => {
                const targetUserId = (userRole === 'admin' && !isViewingAll) ? viewingAs : currentUserId;
                if (!user || !db || !targetUserId) { setLoading(false); return; } 
                setLoading(true);

                const q = db.collection(`artifacts/${appId}/users/${targetUserId}/inventoryParts`).orderBy("partName");
          
      const unsubscribe = q.onSnapshot((snapshot) => { setParts(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))); setLoading(false); }, (err) => { console.error("Lỗi:", err); setError("Lỗi tải dữ liệu."); setLoading(false); });
                return () => unsubscribe();
            }, [user, db, viewingAs, userRole, currentUserId, appId, isViewingAll]);
const handleSavePart = React.useCallback(async (partData) => {
                const targetUserId = (userRole === 'admin' && !isViewingAll) ? viewingAs : currentUserId;
                if (!user || !db || !canManageInventory || !targetUserId) return;

                const dataPath = `artifacts/${appId}/users/${targetUserId}/inventoryParts`;
                const { id, ...dataToSave } = partData;
  
              try {
                    if (id) { 
                        await db.collection(dataPath).doc(id).update(dataToSave); 
                        await logAction(user, 'update', 'Linh kiện', `Cập nhật linh kiện '${dataToSave.partName}'.`, id);
  
                      addNotification('Cập nhật linh kiện thành công!', 'success');
                    } else { 
                        const newRef = await db.collection(dataPath).add(dataToSave); 
                    
    await logAction(user, 'create', 'Linh kiện', `Tạo mới linh kiện '${dataToSave.partName}'.`, newRef.id);
addNotification('Thêm linh kiện mới thành công!', 'success');
                    }
                } catch (e) { 
                    console.error("Lỗi:", e);
addNotification('Lỗi khi lưu linh kiện.', 'error');
                }
            }, [user, appId, canManageInventory, addNotification, userRole, viewingAs, currentUserId]);
const handleDeletePart = React.useCallback(async (partId) => {
                const targetUserId = (userRole === 'admin' && !isViewingAll) ? viewingAs : currentUserId;
                if (!user || !db || !partId || !canManageInventory || !targetUserId) return;
                
                const docRef = db.collection(`artifacts/${appId}/users/${targetUserId}/inventoryParts`).doc(partId);
      
          try { 
                    const doc = await docRef.get();
                    if(doc.exists) {
                        const partName = doc.data().partName;
                
        await docRef.delete(); 
                        await logAction(user, 'delete', 'Linh kiện', `Xóa linh kiện '${partName}'.`, partId);
                        addNotification('Xóa linh kiện thành công!', 'success');
                    }
        
            setConfirmDelete(null);
                } 
                catch (e) { 
                    console.error("Lỗi:", e); 
                    addNotification('Lỗi khi xóa linh kiện.', 'error');
}
            }, [user, appId, canManageInventory, addNotification, userRole, viewingAs, currentUserId]);
const openModalToAdd = () => { setEditingPart(null); setIsModalOpen(true); };
            const openModalToEdit = (part) => { setEditingPart(part); setIsModalOpen(true); };
const filteredParts = React.useMemo(() => parts.filter(p => p.partName?.toLowerCase().includes(searchTerm.toLowerCase())), [parts, searchTerm]);
return ( <div className="p-4 md:p-6 lg:p-8 bg-slate-100 min-h-full"><div className="flex flex-col md:flex-row justify-between items-center mb-6 gap-4"><h1 className="text-2xl md:text-3xl font-bold text-gray-800">Quản lý Kho Linh kiện</h1>
            {canManageInventory && (
                <div className="flex gap-2">
                    <button onClick={() => setIsPrintModalOpen(true)} className="flex items-center gap-2 px-4 py-2 bg-gray-600 text-white font-semibold rounded-lg shadow-md hover:bg-gray-700"><PrintIcon />In Tồn Kho</button>
         
           <button onClick={openModalToAdd} className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700"><PlusIcon />Thêm Linh kiện</button>
                </div>
            )}
            </div><div className="mb-4"><div className="relative"><span className="absolute inset-y-0 left-0 flex items-center pl-3 text-slate-400"><SearchIcon /></span><input type="text" placeholder="Tìm kiếm linh kiện..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className={inputStyle + " pl-10 max-w-sm"}/></div></div>{loading ?
<p className="text-center py-10">Đang tải...</p> : error ? <p className="text-center py-10 text-red-500">{error}</p> : (<div className="bg-white rounded-lg shadow overflow-x-auto"><table className="min-w-full divide-y divide-gray-200"><thead className="bg-gray-50"><tr><th className="px-6 py-3 text-left text-xs font-medium uppercase">Tên Linh kiện</th><th className="px-6 py-3 text-left text-xs font-medium uppercase">Vị trí</th><th className="px-6 py-3 text-left text-xs font-medium uppercase">Tồn kho</th><th className="px-6 py-3 text-left text-xs font-medium uppercase">Giá Nhập</th><th className="px-6 py-3 text-left text-xs font-medium uppercase">Giá Bán</th><th className="relative px-6 py-3"></th></tr></thead><tbody className="bg-white divide-y divide-gray-200">{filteredParts.length > 0 ? filteredParts.map(part => (<tr key={part.id} className={part.stockQuantity <= part.lowStockThreshold ? 'bg-yellow-50' : ''}><td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 flex items-center gap-2">{part.partName}{part.stockQuantity <= part.lowStockThreshold && <WarningIcon/>}</td><td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{part.location}</td><td className="px-6 py-4 whitespace-nowrap text-sm">{(part.stockQuantity ||
0).toLocaleString('vi-VN')}</td><td className="px-6 py-4 whitespace-nowrap text-sm">{canManageInventory ? `${(part.importPrice || 0).toLocaleString('vi-VN')} đ` : '***'}</td><td className="px-6 py-4 whitespace-nowrap text-sm">{(part.salePrice || 0).toLocaleString('vi-VN')} đ</td>
            <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-4">
                {canManageInventory && (
                    <>
                        <button 
onClick={() => openModalToEdit(part)} className="text-indigo-600 hover:text-indigo-900"><EditIcon/></button>
                        <button onClick={() => setConfirmDelete(part.id)} className="text-red-600 hover:text-red-900"><DeleteIcon/></button>
                    </>
                )}
            </td>
            </tr>)) : (<tr><td colSpan="6" className="px-6 py-4 text-center 
text-gray-500">Chưa có linh kiện nào.</td></tr>)}</tbody></table></div>)}
            {canManageInventory && <PartFormModal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} onSave={handleSavePart} part={editingPart} />}
            <PrintableInventoryModal isOpen={isPrintModalOpen} onClose={() => setIsPrintModalOpen(false)} parts={parts} />
            <ConfirmModal isOpen={!!confirmDelete} onClose={() => setConfirmDelete(null)} onConfirm={() => handleDeletePart(confirmDelete)} title="Xác nhận Xóa" message="Bạn có chắc chắn muốn xóa linh kiện này không?
Hành động này không thể hoàn tác." />
            </div> );
        };

        const ServiceFormModal = ({ isOpen, onClose, onSave, service }) => {
            const [formData, setFormData] = React.useState({ serviceName: '', laborCost: '' });
            React.useEffect(() => { setFormData(service ? { ...service, laborCost: formatNumber(service.laborCost) } : { serviceName: '', laborCost: '' }); }, [service, isOpen]);
  
          if (!isOpen) return null;
            const handleChange = (e) => {
                const { name, value } = e.target;
                if(name === 'laborCost') {
                    setFormData(prev => ({ ...prev, [name]: formatNumber(value) }));
   
             } else {
                    setFormData(prev => ({ ...prev, [name]: capitalizeWords(value) }));
                }
            };
            const handleSubmit = (e) => { 
             
   e.preventDefault(); 
                const dataToSave = {
                    ...formData,
                    laborCost: parseFormattedNumber(formData.laborCost),
                };
onSave(dataToSave); 
                onClose(); 
            };
            return ( <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4"><div className="bg-white rounded-lg shadow-2xl w-full max-w-lg"><div className="flex justify-between items-center p-4 border-b"><h2 className="text-xl font-bold text-gray-800">{service ? 'Chỉnh sửa Dịch vụ' : 'Thêm Dịch vụ mới'}</h2><button onClick={onClose} className="text-gray-500 hover:text-gray-800"><CloseIcon /></button></div><form onSubmit={handleSubmit} className="p-6 space-y-4"><div><label className="block text-sm font-medium text-gray-600">Tên Dịch vụ</label><input type="text" name="serviceName" value={formData.serviceName} onChange={handleChange} className={formInputStyle} required /></div><div><label className="block text-sm font-medium text-gray-600">Tiền công</label><input type="text" name="laborCost" value={formData.laborCost} onChange={handleChange} className={formInputStyle} placeholder="0" required /></div><div className="flex justify-end pt-4 space-x-2"><button type="button" onClick={onClose} className="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Hủy</button><button type="submit" className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Lưu</button></div></form></div></div> );
};

        const ServicesPage = ({ user, userRole, addNotification, viewingAs, currentUserId }) => {
            const [services, setServices] = React.useState([]);
const [loading, setLoading] = React.useState(true); const [error, setError] = React.useState(null); const [isModalOpen, setIsModalOpen] = React.useState(false); const [editingService, setEditingService] = React.useState(null);
const [confirmDelete, setConfirmDelete] = React.useState(null);
            const appId = React.useMemo(() => typeof __app_id !== 'undefined' ? __app_id : 'default-app-id', []);
const isViewingAll = userRole === 'admin' && viewingAs === 'all';
            
            const canManageServices = ['admin', 'manager'].includes(userRole) && !isViewingAll;
React.useEffect(() => {
                const targetUserId = (userRole === 'admin' && !isViewingAll) ? viewingAs : currentUserId;
                if (!user || !db || !targetUserId) { setLoading(false); return; } 
                setLoading(true);

                const q = db.collection(`artifacts/${appId}/users/${targetUserId}/services`).orderBy("serviceName");
          
      const unsubscribe = q.onSnapshot((snapshot) => { setServices(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))); setLoading(false); }, (err) => { console.error("Lỗi:", err); setError("Lỗi tải dữ liệu."); setLoading(false); });
                return () => unsubscribe();
            }, [user, db, viewingAs, userRole, currentUserId, appId, isViewingAll]);
const handleSaveService = React.useCallback(async (serviceData) => {
                const targetUserId = (userRole === 'admin' && !isViewingAll) ? viewingAs : currentUserId;
                if (!user || !db || !canManageServices || !targetUserId) return;

                const dataPath = `artifacts/${appId}/users/${targetUserId}/services`;
                const { id, ...dataToSave } = serviceData;
  
              try {
                    if (id) { 
                        await db.collection(dataPath).doc(id).update(dataToSave); 
                        await logAction(user, 'update', 'Dịch vụ', `Cập nhật dịch vụ '${dataToSave.serviceName}'.`, id);
  
                      addNotification('Cập nhật dịch vụ thành công!', 'success');
                    } else { 
                        const newRef = await db.collection(dataPath).add(dataToSave); 
                    
    await logAction(user, 'create', 'Dịch vụ', `Tạo mới dịch vụ '${dataToSave.serviceName}'.`, newRef.id);
                        addNotification('Thêm dịch vụ mới thành công!', 'success');
}
                } catch (e) { 
                    console.error("Lỗi:", e);
addNotification('Lỗi khi lưu dịch vụ.', 'error');
                }
            }, [user, appId, canManageServices, addNotification, userRole, viewingAs, currentUserId]);
const handleDeleteService = React.useCallback(async (serviceId) => {
                const targetUserId = (userRole === 'admin' && !isViewingAll) ? viewingAs : currentUserId;
                if (!user || !db || !serviceId || !canManageServices || !targetUserId) return;
                
                const docRef = db.collection(`artifacts/${appId}/users/${targetUserId}/services`).doc(serviceId);
      
          try { 
                    const doc = await docRef.get();
                    if(doc.exists) {
                        const serviceName = doc.data().serviceName;
                
        await docRef.delete(); 
                        await logAction(user, 'delete', 'Dịch vụ', `Xóa dịch vụ '${serviceName}'.`, serviceId);
                        addNotification('Xóa dịch vụ thành công!', 'success');
                    }
        
            setConfirmDelete(null);
                } 
                catch (e) { 
                    console.error("Lỗi:", e); 
                    addNotification('Lỗi khi xóa dịch vụ.', 'error');
}
            }, [user, appId, canManageServices, addNotification, userRole, viewingAs, currentUserId]);
const openModalToAdd = () => { setEditingService(null); setIsModalOpen(true); };
            const openModalToEdit = (service) => { setEditingService(service); setIsModalOpen(true); };
return ( <div className="p-4 md:p-6 lg:p-8 bg-slate-100 min-h-full"><div className="flex flex-col md:flex-row justify-between items-center mb-6 gap-4"><h1 className="text-2xl md:text-3xl font-bold text-gray-800">Quản lý Dịch vụ</h1>
            {canManageServices && (
                <button onClick={openModalToAdd} className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700"><PlusIcon />Thêm Dịch vụ</button>
            )}
            </div>{loading ? <p className="text-center py-10">Đang tải...</p> : error ? <p 
className="text-center py-10 text-red-500">{error}</p> : (<div className="bg-white rounded-lg shadow overflow-x-auto"><table className="min-w-full divide-y divide-gray-200"><thead className="bg-gray-50"><tr><th className="px-6 py-3 text-left text-xs font-medium uppercase">Tên Dịch vụ</th><th className="px-6 py-3 text-left text-xs font-medium uppercase">Tiền công</th><th className="relative px-6 py-3"></th></tr></thead><tbody className="bg-white divide-y divide-gray-200">{services.length > 0 ?
services.map(service => (<tr key={service.id}><td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{service.serviceName}</td><td className="px-6 py-4 whitespace-nowrap text-sm">{(service.laborCost || 0).toLocaleString('vi-VN')} đ</td>
            <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-4">
                {canManageServices && (
                    <>
                        <button onClick={() => 
openModalToEdit(service)} className="text-indigo-600 hover:text-indigo-900"><EditIcon/></button>
                        <button onClick={() => setConfirmDelete(service.id)} className="text-red-600 hover:text-red-900"><DeleteIcon/></button>
                    </>
                )}
            </td>
            </tr>)) : (<tr><td colSpan="3" className="px-6 py-4 text-center text-gray-500">Chưa có 
dịch vụ nào.</td></tr>)}</tbody></table></div>)}
            {canManageServices && <ServiceFormModal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} onSave={handleSaveService} service={editingService} />}
            <ConfirmModal isOpen={!!confirmDelete} onClose={() => setConfirmDelete(null)} onConfirm={() => handleDeleteService(confirmDelete)} title="Xác nhận Xóa" message="Bạn có chắc chắn muốn xóa dịch vụ này không?
Hành động này không thể hoàn tác." />
            </div> );
        };

        const PlaceholderComponent = ({ title }) => (<div className="p-8 flex justify-center items-center h-full bg-slate-100"><div className="text-center"><h1 className="text-4xl font-bold text-gray-800">{title}</h1><p className="mt-2 text-gray-500">Module đang trong quá trình phát triển.</p><div className="mt-6"><div className="bg-gray-200 h-40 w-full max-w-md mx-auto rounded-lg animate-pulse"></div></div></div></div>);

        const SalesBoardPage = ({ user, userRole }) => {
            return <PlaceholderComponent title="Bảng 
Xuất Kho" />;
        };

        const AdminViewSelector = ({ allUsers, viewingAs, setViewingAs, activePage, currentUserId }) => {
            const pagesToShow = ['reports', 'repairs', 'invoices', 'customers', 'inventory', 'services', 'history', 'import'];
            if (!pagesToShow.includes(activePage)) {
                return null;
            }

      
      return (
                <div className="bg-sky-100 text-sky-800 p-2 lg:ml-64 flex items-center justify-center gap-2 text-sm sticky top-0 z-10">
                    <span className="font-semibold">Chế độ xem của Admin:</span>
                    <select
                    
    value={viewingAs}
                        onChange={e => setViewingAs(e.target.value)}
                        className="bg-white border border-sky-300 rounded-md py-1 px-2 focus:outline-none focus:ring-2 focus:ring-sky-500"
                    >
                  
      <option value="all">Tất cả cửa hàng (Chỉ xem)</option>
                        <option value={currentUserId}>Cửa hàng của tôi ({auth.currentUser.email})</option>
                        {allUsers.filter(u => u.id !== currentUserId).map(u => (
                            <option 
key={u.id} value={u.id}>{u.email}</option>
                        ))}
                    </select>
                </div>
            );
};

        {/* ----- BẮT ĐẦU NÂNG CẤP YÊU CẦU 1 (RevenueChart Component) ----- */}
        const RevenueChart = ({ chartData }) => {
            const chartRef = React.useRef(null);
            const chartInstanceRef = React.useRef(null);

            React.useEffect(() => {
                if (chartRef.current && chartData) {
                    const ctx = chartRef.current.getContext('2d');
                    
                    // Hủy biểu đồ cũ nếu tồn tại
                    if (chartInstanceRef.current) {
                        chartInstanceRef.current.destroy();
                    }
                    
                    chartInstanceRef.current = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: chartData.labels,
                            datasets: [{
                                label: 'Doanh thu',
                                data: chartData.data,
                                backgroundColor: 'rgba(59, 130, 246, 0.6)',
                                borderColor: 'rgba(59, 130, 246, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function(value) {
                                            return value.toLocaleString('vi-VN') + ' đ';
                                        }
                                    }
                                }
                            },
                            plugins: {
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            let label = context.dataset.label || '';
                                            if (label) {
                                                label += ': ';
                                            }
                                            if (context.parsed.y !== null) {
                                                label += context.parsed.y.toLocaleString('vi-VN') + ' đ';
                                            }
                                            return label;
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
                
                // Cleanup
                return () => {
                    if (chartInstanceRef.current) {
                        chartInstanceRef.current.destroy();
                        chartInstanceRef.current = null;
                    }
                };
            }, [chartData]); // Re-run khi data thay đổi

            return (
                <div className="relative h-96">
                    <canvas ref={chartRef}></canvas>
                </div>
            );
        };
        {/* ----- KẾT THÚC NÂNG CẤP YÊU CẦU 1 (RevenueChart Component) ----- */}


        {/* ----- BẮT ĐẦU NÂNG CẤP YÊU CẦU 1 (ReportsPage) ----- */}
        const ReportsPage = ({ user, userRole, viewingAs, allUsers, currentUserId }) => {
            const [stats, setStats] = React.useState({ totalRevenue: 0, repairsCount: 0, newCustomers: 0 });
const [loading, setLoading] = React.useState(true);
            const [reportPeriod, setReportPeriod] = React.useState('monthly'); // daily, monthly, yearly
            const [revenueData, setRevenueData] = React.useState(null);
            
const appId = React.useMemo(() => typeof __app_id !== 'undefined' ? __app_id : 'default-app-id', []);
            const isViewingAll = userRole === 'admin' && viewingAs === 'all';

            // Hàm xử lý dữ liệu doanh thu
            const processRevenueData = (invoices, period) => {
                const revenueMap = new Map();
                const now = new Date();

                invoices.forEach(invoice => {
                    if (!invoice.createdAt || !invoice.createdAt.toDate) return; // Bỏ qua nếu dữ liệu không hợp lệ
                    
                    const invoiceDate = invoice.createdAt.toDate();
                    let key;
                    
                    if (period === 'daily') {
                        // Báo cáo 30 ngày qua
                        const thirtyDaysAgo = new Date(new Date().setDate(new Date().getDate() - 30));
                        thirtyDaysAgo.setHours(0, 0, 0, 0); // Đặt về 0h
                        
                        if (invoiceDate < thirtyDaysAgo) return;
                        key = invoiceDate.toLocaleDateString('vi-VN'); // DD/MM/YYYY
                    } else if (period === 'monthly') {
                        // Báo cáo 12 tháng qua
                        const twelveMonthsAgo = new Date(new Date().setMonth(new Date().getMonth() - 12));
                        twelveMonthsAgo.setDate(1); // Đặt về ngày 1
                        twelveMonthsAgo.setHours(0, 0, 0, 0);

                        if (invoiceDate < twelveMonthsAgo) return;
                        key = `${String(invoiceDate.getMonth() + 1).padStart(2, '0')}/${invoiceDate.getFullYear()}`; // MM/YYYY
                    } else { // yearly
                        key = invoiceDate.getFullYear().toString(); // YYYY
                    }
                    
                    const currentTotal = revenueMap.get(key) || 0;
                    revenueMap.set(key, currentTotal + (invoice.total || 0));
                });

                // Sắp xếp Map theo thứ tự thời gian (rất quan trọng)
                const sortedMap = new Map([...revenueMap.entries()].sort((a, b) => {
                    const parseKey = (key) => {
                        if (period === 'daily') {
                            const parts = key.split('/');
                            return new Date(parts[2], parts[1] - 1, parts[0]);
                        } else if (period === 'monthly') {
                            const parts = key.split('/');
                            return new Date(parts[1], parts[0] - 1);
                        } else {
                            return new Date(key, 0);
                        }
                    };
                    return parseKey(a[0]) - parseKey(b[0]);
                }));


                return {
                    labels: [...sortedMap.keys()],
                    data: [...sortedMap.values()],
                    table: [...sortedMap.entries()]
                };
            };

React.useEffect(() => {
                if (!user || !db || !viewingAs) { setLoading(false); return; }

                const fetchAllData = async () => {
                    setLoading(true);
                    try {
              let userIdsToFetch = [];
                        if (isViewingAll) {
                            userIdsToFetch = allUsers.map(u => u.id);
 } else {
                            userIdsToFetch = [viewingAs];
                        }

                        const allInvoices = [];
                        let totalRepairs = 0;
                        let totalCustomers = 0;

                        const promises = userIdsToFetch.map(async (uid) => {
              const path = `artifacts/${appId}/users/${uid}`;
                            
                            const [invoicesSnapshot, ordersSnapshot, customersSnapshot] = await Promise.all([
                                db.collection(`${path}/invoices`).get(),
          db.collection(`${path}/repairOrders`).get(),
                                db.collection(`${path}/customers`).get()
                            ]);
                            
                            invoicesSnapshot.forEach(doc => allInvoices.push(doc.data()));
                            totalRepairs += ordersSnapshot.size;
                            totalCustomers += customersSnapshot.size;
                        });

await Promise.all(promises);

                        const totalRevenue = allInvoices.reduce((sum, inv) => sum + (inv.total || 0), 0);


setStats({ totalRevenue, repairsCount: totalRepairs, newCustomers: totalCustomers });
                        
                        // Xử lý dữ liệu cho biểu đồ
                        const chartData = processRevenueData(allInvoices, reportPeriod);
                        setRevenueData(chartData);

} catch (err) {
                        console.error("Lỗi tải báo cáo:", err);
                    } finally {
                        setLoading(false);
}
                };

                fetchAllData();
            }, [user, db, viewingAs, allUsers, appId, reportPeriod, isViewingAll]); // Thêm reportPeriod làm dependency

            const PeriodButton = ({ period, label }) => (
                <button
                    onClick={() => setReportPeriod(period)}
                    className={`px-4 py-2 rounded-md font-medium ${reportPeriod === period ? 'bg-blue-600 text-white shadow' : 'bg-white text-gray-700 hover:bg-gray-100'}`}
                >
                    {label}
                </button>
            );

            if (loading && !revenueData) return <p className="p-8 text-center">Đang tải báo cáo...</p>
            
            return (
                <div className="p-4 md:p-6 lg:p-8 bg-slate-100 min-h-full">
                    <h1 className="text-2xl md:text-3xl font-bold text-gray-800 mb-6">Báo cáo & Thống kê</h1>
           
         <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <div className="bg-white p-6 rounded-lg shadow"><h4 className="text-gray-500 text-sm font-medium">Tổng Doanh thu (Toàn thời gian)</h4><p className="text-3xl font-bold text-green-600">{(stats.totalRevenue || 0).toLocaleString('vi-VN')} đ</p></div>
                        <div className="bg-white p-6 rounded-lg shadow"><h4 className="text-gray-500 text-sm font-medium">Tổng Phiếu Sửa</h4><p className="text-3xl font-bold text-blue-600">{stats.repairsCount}</p></div>
             <div className="bg-white p-6 rounded-lg shadow"><h4 className="text-gray-500 text-sm font-medium">Tổng Khách hàng</h4><p className="text-3xl font-bold text-purple-600">{stats.newCustomers}</p></div>
                    </div>
                    
                    {/* KHU VỰC BÁO CÁO MỚI */}
                    <div className="bg-white p-6 rounded-lg shadow">
                        <h2 className="text-xl font-bold text-gray-800 mb-4">Báo cáo Doanh thu Chi tiết</h2>
                        <div className="flex space-x-2 mb-4">
                            <PeriodButton period="daily" label="30 Ngày qua" />
                            <PeriodButton period="monthly" label="12 Tháng qua" />
                            <PeriodButton period="yearly" label="Theo Năm" />
                        </div>
                        
                        {loading ? <p className="text-center py-10">Đang tải dữ liệu...</p> : 
                            !revenueData || revenueData.data.length === 0 ? 
                            <p className="text-center py-10 text-gray-500">Không có dữ liệu doanh thu cho khoảng thời gian này.</p> :
                            (
                                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                    {/* Biểu đồ (responsive) */}
                                    <div className="lg:col-span-2">
                                        <RevenueChart chartData={revenueData} />
                                    </div>
                                    
                                    {/* Bảng dữ liệu (responsive) */}
                                    <div className="lg:col-span-1 max-h-96 overflow-y-auto">
                                        <h3 className="font-semibold mb-2">Số liệu chi tiết</h3>
                                        <div className="overflow-x-auto rounded-md border">
                                            <table className="min-w-full divide-y divide-gray-200">
                                                <thead className="bg-gray-50">
                                                    <tr>
                                                        <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Thời gian</th>
                                                        <th className="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Doanh thu</th>
                                                    </tr>
                                                </thead>
                                                <tbody className="bg-white divide-y divide-gray-200">
                                                    {revenueData.table.map(([key, value]) => (
                                                        <tr key={key}>
                                                            <td className="px-4 py-2 whitespace-nowrap text-sm font-medium text-gray-900">{key}</td>
                                                            <td className="px-4 py-2 whitespace-nowrap text-sm text-gray-700 text-right">{value.toLocaleString('vi-VN')} đ</td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            )
                        }
                    </div>
                </div>
            );
        }
        {/* ----- KẾT THÚC NÂNG CẤP YÊU CẦU 1 (ReportsPage) ----- */}
        
        const InvoicesPage = 
({user, userRole, viewingAs, currentUserId, allUsers}) => {
            const [invoices, setInvoices] = React.useState([]);
const [loading, setLoading] = React.useState(true);
            const [selectedInvoice, setSelectedInvoice] = React.useState(null);
const appId = React.useMemo(() => typeof __app_id !== 'undefined' ? __app_id : 'default-app-id', []);
const isViewingAll = userRole === 'admin' && viewingAs === 'all';
React.useEffect(() => {
                if (!user || !db || !viewingAs) { setLoading(false); return; }
                setLoading(true);

                 if (isViewingAll) {
                    const fetchAllInvoices = async () => {
            
            try {
                            const promises = allUsers.map(u => 
                                db.collection(`artifacts/${appId}/users/${u.id}/invoices`).get()
                      
      );
                            const snapshots = await Promise.all(promises);
                            let allData = [];
                            snapshots.forEach((snapshot, index) => 
{
                                snapshot.docs.forEach(doc => {
                                    allData.push({ 
                             
           id: doc.id, 
                                        ...doc.data(), 
                                        ownerEmail: allUsers[index].email
     
                               });
});
                            });
                            allData.sort((a,b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));
                            setInvoices(allData);
                        } catch(e) { console.error(e);
}
                        finally { setLoading(false);
}
                    };
fetchAllInvoices();
                } else {
                    const targetUserId = userRole === 'admin' ?
viewingAs : currentUserId;
                    const q = db.collection(`artifacts/${appId}/users/${targetUserId}/invoices`).orderBy("createdAt", "desc");
                    const unsubscribe = q.onSnapshot((snapshot) => {
                        setInvoices(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                        setLoading(false);
                    }, (err) => {
          
              console.error("Lỗi tải hóa đơn:", err);
                        setLoading(false);
                    });
return () => unsubscribe();
                }
            }, [user, db, viewingAs, userRole, allUsers, currentUserId, appId, isViewingAll]);
return (
                <div className="p-4 md:p-6 lg:p-8 bg-slate-100 min-h-full">
                    <h1 className="text-2xl md:text-3xl font-bold text-gray-800 mb-6">Lịch sử Hóa đơn</h1>
                    {loading ? <p>Đang tải...</p> : (
                        <div 
className="bg-white rounded-lg shadow overflow-x-auto">
                            <table className="min-w-full divide-y divide-gray-200">
                                <thead className="bg-gray-50">
                                 
   <tr>
                                        {isViewingAll && <th className="px-6 py-3 text-left text-xs font-medium uppercase">Cửa hàng</th>}
                                        <th className="px-6 py-3 text-left text-xs font-medium uppercase">Ngày tạo</th>
 
                                       <th className="px-6 py-3 text-left text-xs font-medium uppercase">Mã Hóa đơn</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium uppercase">Khách hàng</th>
      
                                  <th className="px-6 py-3 text-left text-xs font-medium uppercase">Tổng tiền</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium uppercase">Thanh toán</th>
            
                            <th className="relative px-6 py-3"></th>
                                    </tr>
                                </thead>
 
                               <tbody className="bg-white divide-y divide-gray-200">
                                    {invoices.map(invoice => (
                            
            <tr key={invoice.id}>
                                            {isViewingAll && <td className="px-6 py-4 whitespace-nowrap text-sm">{invoice.ownerEmail}</td>}
                                     
       <td className="px-6 py-4 whitespace-nowrap text-sm">{invoice.createdAt?.toDate().toLocaleDateString('vi-VN')}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm font-mono">#{invoice.id.slice(0,6).toUpperCase()}</td>
                                        
    <td className="px-6 py-4 whitespace-nowrap text-sm">{invoice.customerName}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm">{(invoice.total ||
0).toLocaleString('vi-VN')} đ</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm">{invoice.paymentMethod}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
 
                                                <button onClick={() => setSelectedInvoice(invoice)} className="text-indigo-600 hover:text-indigo-900">Xem & In</button>
                                            </td>
 
                                       </tr>
                                    ))}
                         
       </tbody>
                            </table>
                        </div>
                    )}
                    {selectedInvoice 
&& <PrintableInvoiceModal isOpen={!!selectedInvoice} onClose={() => setSelectedInvoice(null)} invoice={selectedInvoice} />}
                </div>
            )
        };
const PrintableInvoiceModal = ({ isOpen, onClose, invoice }) => {
            if (!isOpen) return null;
const printableRef = React.useRef(null);

            const handlePrint = () => {
                if(printableRef.current) {
                    printWithIframe(printableRef.current);
}
            };
return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
                    <div className="bg-white rounded-lg shadow-2xl w-full max-w-2xl max-h-[95vh] flex flex-col">
                        <div ref={printableRef} className="printable-area p-8 text-gray-800 text-sm overflow-y-auto">
                
            <div className="text-center mb-8">
                                <h1 className="text-2xl font-bold">TRUNG TÂM DỊCH VỤ VÀ PHÁT TRIỂN CÔNG NGHỆ ĐIỆN TỬ HÙNG NGỌC</h1>
                                <p className="text-sm">Đối diện Trường Mầm Non Phương Canh, 
Tổ 8 Tu Hoàng, Xuân Phương, Hà Nội</p>
                                <p className="text-sm">Điện thoại: 094.632.8386</p>
                            </div>
                            <h2 className="text-xl 
font-bold text-center mb-6">HÓA ĐƠN THANH TOÁN</h2>
                            <div className="grid grid-cols-2 gap-4 mb-4 text-sm">
                                <div><p><strong>Khách hàng:</strong> {invoice.customerName}</p><p><strong>Điện thoại:</strong> {invoice.customerPhone}</p></div>
                          
      <div className="text-right"><p><strong>Số HĐ:</strong> #{invoice.id.slice(0, 8).toUpperCase()}</p><p><strong>Ngày:</strong> {invoice.createdAt?.toDate().toLocaleDateString('vi-VN')}</p></div>
                            </div>
                            <table className="min-w-full divide-y divide-gray-300 mb-4">
                             
   <thead className="bg-gray-100"><tr><th className="px-4 py-2 text-left text-sm font-semibold">STT</th><th className="px-4 py-2 text-left text-sm font-semibold">Tên mục</th><th className="px-4 py-2 text-center text-sm font-semibold">SL</th><th className="px-4 py-2 text-right text-sm font-semibold">Đơn giá</th><th className="px-4 py-2 text-right text-sm font-semibold">Thành tiền</th></tr></thead>
                                <tbody>{(invoice.items ||
[]).map((item, index) => (<tr key={item.id} className="border-b"><td className="px-4 py-2">{index + 1}</td><td className="px-4 py-2">{item.name}</td><td className="px-4 py-2 text-center">{item.quantity}</td><td className="px-4 py-2 text-right">{(item.price || 0).toLocaleString('vi-VN')} đ</td><td className="px-4 py-2 text-right">{((item.price || 0) * (item.quantity || 1)).toLocaleString('vi-VN')} đ</td></tr>))}</tbody>
                            </table>
                            <div className="text-right text-lg font-bold mb-8">Thành tiền: {(invoice.total || 0).toLocaleString('vi-VN')} đ</div>
     
                       <div className="text-center text-sm text-gray-600">
                                <p>Cảm ơn quý khách và hẹn gặp lại!
</p>
                                <p>Hóa đơn có giá trị kiêm phiếu bảo hành sản phẩm 01 tháng</p>
                            </div>
                        </div>
    
                    <div className="p-4 border-t mt-auto flex justify-end items-center gap-4 no-print">
                             <button onClick={onClose} className="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Đóng</button>
                             <button onClick={handlePrint} className="flex items-center gap-2 px-4 py-2 
bg-blue-600 text-white rounded-md hover:bg-blue-700"><PrintIcon /> In Hóa đơn</button>
                        </div>
                    </div>
                </div>
            );
};
        
        const LoginPage = () => {
            const [isLoginView, setIsLoginView] = React.useState(true);
const [email, setEmail] = React.useState('');
            const [password, setPassword] = React.useState('');
            const [error, setError] = React.useState('');
            const [loading, setLoading] = React.useState(false);
const appId = React.useMemo(() => typeof __app_id !== 'undefined' ? __app_id : 'default-app-id', []);
const handleSubmit = async (e) => {
                e.preventDefault();
setLoading(true);
                setError('');

                try {
                    if (isLoginView) {
                        await auth.signInWithEmailAndPassword(email, password);
} else {
                        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
const user = userCredential.user;
                        const usersRef = db.collection(`artifacts/${appId}/public/data/users`);
                        await usersRef.doc(user.uid).set({
                            email: user.email,
                            role: 'receptionist',
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
    
                    });
}
                } catch (err) {
                    switch (err.code) {
                        case 'auth/user-not-found':
                            setError('Email không tồn tại.');
break;
                        case 'auth/wrong-password':
                            setError('Sai mật khẩu.');
break;
                        case 'auth/email-already-in-use':
                            setError('Email này đã được sử dụng.');
break;
                        case 'auth/weak-password':
                             setError('Mật khẩu phải có ít nhất 6 ký tự.');
break;
                        case 'auth/operation-not-allowed':
                             setError('Đăng ký bằng Email/Mật khẩu chưa được bật trong Firebase.');
break;
                        default:
                            setError('Đã xảy ra lỗi. Vui lòng thử lại.');
console.error(err);
                    }
                } finally {
                    setLoading(false);
}
            };
return (
                <div className="min-h-screen bg-gray-100 flex flex-col justify-center items-center p-4">
                    <div className="max-w-md w-full bg-white rounded-lg shadow-md p-8">
                        <div className="text-center mb-8">
                        
   <div className="flex justify-center items-center gap-3 mb-2">
                                <RepairIcon />
                                <h1 className="text-2xl font-bold text-gray-800">RepairShop Pro</h1>
                       
    </div>
                           <p className="text-gray-500">{isLoginView ? 'Đăng nhập vào tài khoản của bạn' : 'Tạo tài khoản mới'}</p>
                        </div>
                        <form onSubmit={handleSubmit} className="space-y-6">
     
                       <div>
                                <label htmlFor="email" className="text-sm font-medium text-gray-700">Email</label>
                                <input id="email" name="email" type="email" required value={email} onChange={e => setEmail(e.target.value)} 
className={inputStyle} />
                            </div>
                            <div>
                                <label htmlFor="password" className="text-sm font-medium text-gray-700">Mật khẩu</label>
      
                          <input id="password" name="password" type="password" required value={password} onChange={e => setPassword(e.target.value)} className={inputStyle} />
                            </div>
                            {error && <p className="text-red-500 text-sm">{error}</p>}
    
                        <div>
                                <button type="submit" disabled={loading} className="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:bg-blue-300">
                       
             {loading ?
'Đang xử lý...' : (isLoginView ? 'Đăng nhập' : 'Đăng ký')}
                                </button>
                            </div>
                        </form>
      
                  <div className="text-center mt-6">
                            <button onClick={() => { setIsLoginView(!isLoginView);
setError(''); }} className="text-sm text-blue-600 hover:underline">
                                {isLoginView ?
'Chưa có tài khoản? Đăng ký' : 'Đã có tài khoản?
Đăng nhập'}
                            </button>
                        </div>
                    </div>
                </div>
           
 );
        };
        
        const AuditLogPage = ({ user, userRole, viewingAs, currentUserId, allUsers }) => {
            const [logs, setLogs] = React.useState([]);
const [loading, setLoading] = React.useState(true);
            const appId = React.useMemo(() => typeof __app_id !== 'undefined' ? __app_id : 'default-app-id', []);
React.useEffect(() => {
                if (!user || !db || !viewingAs) { setLoading(false); return; }
                setLoading(true);

                const fetchLogs = async () => {
                    let logsData = [];
            
        try {
                        if (viewingAs === 'all') {
                            const promises = allUsers.map(u => 
                              
  db.collection(`artifacts/${appId}/users/${u.id}/audit_logs`).orderBy("timestamp", "desc").limit(50).get()
                            );
                            const snapshots = await Promise.all(promises);
                            snapshots.forEach(snapshot => {
       
                         snapshot.docs.forEach(doc => logsData.push({ id: doc.id, ...doc.data() }));
                            });
                        } else {
               
             const q = db.collection(`artifacts/${appId}/users/${viewingAs}/audit_logs`).orderBy("timestamp", "desc").limit(200);
const snapshot = await q.get();
                            logsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
}
                        logsData.sort((a,b) => (b.timestamp?.toMillis() || 0) - (a.timestamp?.toMillis() || 0));
setLogs(logsData);
                    } catch (err) {
                        console.error("Lỗi tải nhật ký:", err);
} finally {
                        setLoading(false);
}
                };
                
                fetchLogs();
}, [user, db, viewingAs, allUsers, appId]);

            if (!['admin', 'manager'].includes(userRole)) {
                return <div className="p-8 text-center"><h1 className="text-2xl font-bold text-red-600">Truy cập bị từ chối</h1><p className="text-gray-600 mt-2">Bạn không có quyền xem trang này.</p></div>;
}

            return (
                <div className="p-4 md:p-6 lg:p-8 bg-slate-100 min-h-full">
                    <h1 className="text-2xl md:text-3xl font-bold text-gray-800 mb-6">Nhật ký Hoạt động</h1>
                    {loading ? <p className="text-center py-10">Đang tải...</p> : (
           
             <div className="bg-white rounded-lg shadow overflow-x-auto">
                            <table className="min-w-full divide-y divide-gray-200">
                                <thead className="bg-gray-50">
                   
                 <tr>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Thời gian</th>
                                  
      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Người dùng</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hành động</th>
                                    
</tr>
                                </thead>
                                <tbody className="bg-white divide-y divide-gray-200">
                                 
   {logs.length > 0 ? logs.map(log => (
                                        <tr key={log.id}>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{log.timestamp?.toDate().toLocaleString('vi-VN') 
|| '...'}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{log.userEmail}</td>
                                            <td className="px-6 py-4 text-sm text-gray-700">{log.details}</td>
  
                                      </tr>
                                    )) : (
                        
                <tr><td colSpan="3" className="px-6 py-4 text-center text-gray-500">Chưa có hoạt động nào được ghi lại.</td></tr>
                                    )}
                                </tbody>
    
                        </table>
                        </div>
                    )}
                </div>
            );
};

        const UserManagementPage = ({ user, userRole, addNotification }) => {
            const [users, setUsers] = React.useState([]);
const [loading, setLoading] = React.useState(true);
            const roles = ['admin', 'manager', 'technician', 'receptionist'];
const appId = React.useMemo(() => typeof __app_id !== 'undefined' ? __app_id : 'default-app-id', []);
React.useEffect(() => {
                if (userRole !== 'admin') {
                    setLoading(false);
                    return;
                }
                const unsubscribe = db.collection(`artifacts/${appId}/public/data/users`)
   
                 .orderBy("createdAt", "desc")
                    .onSnapshot(snapshot => {
                        setUsers(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                        setLoading(false);
      
              }, err => {
                        console.error("Lỗi tải danh sách người dùng:", err);
                        setLoading(false);
                    });
         
       return () => unsubscribe();
            }, [userRole, appId]);
const handleRoleChange = async (userId, newRole) => {
                if (userRole !== 'admin') return;
try {
                    await db.collection(`artifacts/${appId}/public/data/users`).doc(userId).update({ role: newRole });
await logAction(user, 'role_change', 'User', `Đổi vai trò của người dùng ID ${userId.slice(0,6)} thành '${newRole}'.`, userId);
addNotification('Cập nhật vai trò thành công!', 'success');
                } catch (err) {
                    console.error("Lỗi cập nhật vai trò:", err);
addNotification('Lỗi khi cập nhật vai trò.', 'error');
                }
            };
if (userRole !== 'admin') {
                return <div className="p-8 text-center"><h1 className="text-2xl font-bold text-red-600">Truy cập bị từ chối</h1><p className="text-gray-600 mt-2">Chỉ Quản trị viên mới có quyền truy cập trang này.</p></div>;
}

            return (
                <div className="p-4 md:p-6 lg:p-8 bg-slate-100 min-h-full">
                    <h1 className="text-2xl md:text-3xl font-bold text-gray-800 mb-6">Quản lý Người dùng</h1>
                    {loading ? <p className="text-center py-10">Đang tải...</p> : (
           
             <div className="bg-white rounded-lg shadow overflow-x-auto">
                            <table className="min-w-full divide-y divide-gray-200">
                                <thead className="bg-gray-50">
                   
                 <tr>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                   
     <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vai trò</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ngày tạo</th>
                                    </tr>
 
                               </thead>
                                <tbody className="bg-white divide-y divide-gray-200">
                                  
  {users.map(u => (
                                        <tr key={u.id}>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{u.email}</td>
     
                                       <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                <select 
       
                                             value={u.role} 
                                                    onChange={(e) => 
handleRoleChange(u.id, e.target.value)}
                                                    className="rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"
                                         
           disabled={u.id === user.uid}
                                                >
                                       
             {roles.map(role => <option key={role} value={role} className="capitalize">{role}</option>)}
                                                </select>
                                  
          </td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{u.createdAt?.toDate().toLocaleDateString('vi-VN')}</td>
                                        </tr>
 
                                   ))}
                                </tbody>
                            </table>
     
                   </div>
                    )}
                </div>
            );
};
        
       {/* ----- BẮT ĐẦU NÂNG CẤP YÊU CẦU 3 (DataImportPage) ----- */}
        const DataImportPage = ({ user, userRole, addNotification, viewingAs, currentUserId }) => {
            const [file, setFile] = React.useState(null);
const [dataType, setDataType] = React.useState('customers');
            const [loading, setLoading] = React.useState(false);
            const [deleteModal, setDeleteModal] = React.useState({ isOpen: false, collection: '', title: '', confirmText: '' });
const appId = React.useMemo(() => typeof __app_id !== 'undefined' ? __app_id : 'default-app-id', []);
            
            const canImport = ['admin', 'manager'].includes(userRole);
const isViewingAll = userRole === 'admin' && viewingAs === 'all';
            const isAdmin = userRole === 'admin';
            
const handleFileChange = (e) => {
                const selectedFile = e.target.files[0];
if (selectedFile && (selectedFile.type === "text/csv" || selectedFile.name.endsWith('.csv'))) {
                    setFile(selectedFile);
} else {
                    addNotification("Vui lòng chọn một file .csv hợp lệ.", "error");
e.target.value = null;
                }
            };
            
            // --- NÂNG CẤP 3a: Thêm hàm Validate ---
            const validateRow = (row, index, headers, dataType) => {
                const lineNumber = index + 2; // +1 for header, +1 for 0-index
                
                // Kiểm tra các trường bắt buộc chung
                if (dataType === 'customers' && (!row.customerName || !row.customerPhone)) {
                    throw new Error(`Dòng ${lineNumber}: Thiếu 'customerName' hoặc 'customerPhone'.`);
                }
                if (dataType === 'inventoryParts' && !row.partName) {
                    throw new Error(`Dòng ${lineNumber}: Thiếu 'partName'.`);
                }
                if (dataType === 'services' && !row.serviceName) {
                    throw new Error(`Dòng ${lineNumber}: Thiếu 'serviceName'.`);
                }
                if (dataType === 'repairOrders' && (!row.customerName || !row.customerPhone || !row.deviceModel)) {
                    throw new Error(`Dòng ${lineNumber}: Thiếu 'customerName', 'customerPhone', hoặc 'deviceModel'.`);
                }
                
                // Kiểm tra các trường số
                const numericFields = {
                    inventoryParts: ['stockQuantity', 'importPrice', 'salePrice', 'lowStockThreshold'],
                    services: ['laborCost'],
                    repairOrders: ['estimatedCost']
                };
                
                const fieldsToValidate = numericFields[dataType] || [];
                for (const field of fieldsToValidate) {
                    if (row[field] && isNaN(parseFormattedNumber(row[field]))) {
                         throw new Error(`Dòng ${lineNumber}: Trường '${field}' có giá trị '${row[field]}' không phải là một số hợp lệ.`);
                    }
                }
                return true;
            };

            // Hàm chuyển đổi các trường dữ liệu số
const processRowData = (rowObject, dataType) => {
                const numericFields = {
                    inventoryParts: ['stockQuantity', 'importPrice', 'salePrice', 'lowStockThreshold'],
                    services: ['laborCost'],
          repairOrders: ['estimatedCost']
                };
const fieldsToProcess = numericFields[dataType] || [];
                let newRow = { ...rowObject };
fields
