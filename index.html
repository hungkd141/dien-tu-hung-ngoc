<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Phần mềm Quản lý Sửa chữa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase Libraries (Modular SDK v11) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        window.firebaseApp = { initializeApp };
    </script>
    <script type="module">
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        window.firebaseAuth = { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged };
    </script>
    <script type="module">
        import { getFirestore, collection, doc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, query, where, orderBy, getDocs, getDoc, serverTimestamp, Timestamp, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        window.firebaseFirestore = { getFirestore, collection, doc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, query, where, orderBy, getDocs, getDoc, serverTimestamp, Timestamp, writeBatch };
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        /* Print-specific styles */
        @media print {
            body > #root {
                display: none !important;
            }
            #print-container {
                display: block !important;
            }
            .no-print {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <div id="print-container" style="display: none;"></div>

    <script type="text/babel">
        // --- ICONS ---
        const PlusIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" /></svg>;
        const RepairIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>;
        const CustomerIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>;
        const InventoryIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" /></svg>;
        const ReportIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>;
        const SettingsIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>;
        const CloseIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>;
        const SearchIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clipRule="evenodd" /></svg>;
        const HistoryIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>;
        const EditIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.536l12.232-12.232z" /></svg>;
        const DeleteIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>;
        const WarningIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 text-yellow-500" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.21 3.03-1.742 3.03H4.42c-1.532 0-2.492-1.696-1.742-3.03l5.58-9.92zM10 13a1 1 0 110-2 1 1 0 010 2zm-1-8a1 1 0 00-1 1v3a1 1 0 102 0V6a1 1 0 00-1-1z" clipRule="evenodd" /></svg>;
        const ServiceIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>;
        const InvoiceIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>;
        const WarrantyIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 20.417l4.5-1.5a8.023 8.023 0 011.14-5.571 8.023 8.023 0 015.571-1.14l1.5-4.5z" /></svg>;
        const PrintIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H7a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm7-8V5a2 2 0 00-2-2H5a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-2" /></svg>;
        const DownloadIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>;
        const MenuIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h16" /></svg>;
        const InfoIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clipRule="evenodd" /></svg>;
        const SuccessIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" /></svg>;
        const ErrorIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clipRule="evenodd" /></svg>;
        const LogoutIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>;

        // --- HELPER FUNCTIONS ---
        const capitalizeWords = (str) => {
            if (!str) return '';
            return str.toLowerCase().replace(/(^\w{1})|(\s+\w{1})/g, letter => letter.toUpperCase());
        };
        const formatNumber = (value) => {
            if (value === null || value === undefined || value === '') return '';
            const numberValue = parseInt(String(value).replace(/[^0-9]/g, ''), 10);
            if (isNaN(numberValue)) return '';
            return numberValue.toLocaleString('vi-VN');
        };
        const parseFormattedNumber = (value) => {
            if (typeof value === 'number') return value;
            if (!value) return 0;
            return parseFloat(String(value).replace(/\./g, '')) || 0;
        };
        function exportToCSV(data, filename, showNotification) {
            if (data.length === 0) {
                showNotification('Không có dữ liệu để xuất.', 'info');
                return;
            }
            const headers = Object.keys(data[0]);
            const csvRows = [headers.join(',')];
            for (const row of data) {
                const values = headers.map(header => {
                    let cell = row[header] === null || row[header] === undefined ? '' : row[header];
                    if (cell instanceof Date) {
                        cell = cell.toLocaleDateString('vi-VN');
                    } else if (cell.toDate && typeof cell.toDate === 'function') { // Handle Firestore Timestamps
                        cell = cell.toDate().toLocaleDateString('vi-VN');
                    }
                    const cellString = String(cell);
                    const escaped = cellString.replace(/"/g, '""');
                    return `"${escaped}"`;
                });
                csvRows.push(values.join(','));
            }
            const blob = new Blob(["\uFEFF" + csvRows.join('\n')], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showNotification('Xuất file CSV thành công!', 'success');
        }

        // --- UI COMPONENTS ---
        const inputStyle = "mt-1 block w-full rounded-md border-slate-300 bg-white py-2 px-3 shadow-sm placeholder:text-slate-400 focus:border-sky-500 focus:outline-none focus:ring-1 focus:ring-sky-500 sm:text-sm";
        const formInputStyle = "mt-1 block w-full rounded-md border-2 border-sky-300 bg-white py-2 px-3 shadow-sm placeholder:text-slate-400 focus:border-sky-500 focus:outline-none focus:ring-1 focus:ring-sky-500 sm:text-sm";
        
        const Notification = ({ message, type, onDismiss }) => {
            if (!message) return null;
            const baseClasses = "fixed top-5 right-5 max-w-sm w-full rounded-lg shadow-lg p-4 flex items-center gap-3 z-[100]";
            const typeClasses = { success: "bg-green-100 text-green-800", error: "bg-red-100 text-red-800", info: "bg-blue-100 text-blue-800" };
            const Icon = { success: SuccessIcon, error: ErrorIcon, info: InfoIcon }[type];
            React.useEffect(() => {
                const timer = setTimeout(onDismiss, 5000);
                return () => clearTimeout(timer);
            }, [onDismiss]);
            return (<div className={`${baseClasses} ${typeClasses[type]}`}><Icon /><span className="flex-1">{message}</span><button onClick={onDismiss} className="text-xl font-bold">&times;</button></div>);
        };

        const ConfirmModal = ({ isOpen, onClose, onConfirm, title, message }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-[60] p-4">
                    <div className="bg-white rounded-lg shadow-2xl w-full max-w-sm">
                        <div className="p-6"><h3 className="text-lg font-bold text-gray-800">{title}</h3><p className="mt-2 text-sm text-gray-600">{message}</p></div>
                        <div className="flex justify-end p-4 bg-gray-50 rounded-b-lg space-x-2">
                            <button type="button" onClick={onClose} className="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Hủy</button>
                            <button type="button" onClick={onConfirm} className="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Xác nhận</button>
                        </div>
                    </div>
                </div>
            );
        };

        const NewOrderModal = ({ isOpen, onClose, onSave, orderToEdit }) => {
            const initialFormState = { 
                customerName: '', customerPhone: '', customerAddress: '', 
                deviceType: 'Điện thoại', deviceModel: '', deviceSerial: '', devicePassword: '', 
                initialCondition: '', reportedProblem: '', 
                diagnosis: '', estimatedCost: '',
                isWarranty: false, originalInvoiceId: '', otherDeviceType: '', completionTime: '' 
            };
            const [formData, setFormData] = React.useState(initialFormState);
            
            React.useEffect(() => {
                if (isOpen) {
                    if (orderToEdit) {
                        const cost = orderToEdit.estimatedCost ? formatNumber(orderToEdit.estimatedCost) : '';
                        setFormData({ ...initialFormState, ...orderToEdit, estimatedCost: cost });
                    } else {
                        const now = new Date();
                        const day = String(now.getDate()).padStart(2, '0');
                        const month = String(now.getMonth() + 1).padStart(2, '0');
                        const year = now.getFullYear();
                        const hours = String(now.getHours()).padStart(2, '0');
                        const minutes = String(now.getMinutes()).padStart(2, '0');
                        const defaultCompletionTime = `${hours}:${minutes} Ngày ${day}/${month}/${year}`;
                        setFormData({ ...initialFormState, completionTime: defaultCompletionTime });
                    }
                }
            }, [isOpen, orderToEdit]);

            if (!isOpen) return null;

            const handleChange = (e) => {
                const { name, value, type, checked } = e.target;
                let processedValue;

                if (type === 'checkbox') {
                    processedValue = checked;
                } else if (name === 'estimatedCost') {
                    processedValue = formatNumber(value);
                } else if (['customerName', 'customerAddress', 'deviceModel', 'initialCondition', 'reportedProblem', 'otherDeviceType', 'diagnosis'].includes(name)) {
                    processedValue = capitalizeWords(value);
                } else {
                    processedValue = value;
                }
                setFormData(prev => ({ ...prev, [name]: processedValue }));
            };

            const handleSubmit = (e) => { e.preventDefault(); onSave(formData); onClose(); };
            
            return ( 
                <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
                    <div className="bg-white rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                        <div className="flex justify-between items-center p-4 border-b">
                            <h2 className="text-xl font-bold text-gray-800">{orderToEdit ? 'Chỉnh sửa Phiếu Sửa chữa' : 'Tạo Phiếu Sửa Chữa Mới'}</h2>
                            <button onClick={onClose} className="text-gray-500 hover:text-gray-800"><CloseIcon /></button>
                        </div>
                        <form onSubmit={handleSubmit} className="p-6 space-y-4">
                            <fieldset className="border rounded-md p-4"><legend className="text-lg font-semibold px-2 text-gray-700">Thông Tin Khách Hàng</legend><div className="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label className="block text-sm font-medium text-gray-600">Họ và Tên</label><input type="text" name="customerName" value={formData.customerName} onChange={handleChange} className={formInputStyle} required /></div><div><label className="block text-sm font-medium text-gray-600">Số Điện Thoại</label><input type="tel" name="customerPhone" value={formData.customerPhone} onChange={handleChange} className={formInputStyle} required /></div><div className="md:col-span-2"><label className="block text-sm font-medium text-gray-600">Địa chỉ</label><input type="text" name="customerAddress" value={formData.customerAddress} onChange={handleChange} className={formInputStyle} /></div></div></fieldset>
                            <fieldset className="border rounded-md p-4"><legend className="text-lg font-semibold px-2 text-gray-700">Thông Tin Thiết Bị</legend><div className="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label className="block text-sm font-medium text-gray-600">Loại Thiết Bị</label><select name="deviceType" value={formData.deviceType} onChange={handleChange} className={formInputStyle}><option>Điện thoại</option><option>Laptop</option><option>Máy tính bảng</option><option>Đồng hồ thông minh</option><option>Khác</option></select></div>{formData.deviceType === 'Khác' && (<div><label className="block text-sm font-medium text-gray-600">Vui lòng nhập loại thiết bị</label><input type="text" name="otherDeviceType" value={formData.otherDeviceType} onChange={handleChange} className={formInputStyle} placeholder="VD: Loa Bluetooth, Tai nghe..." required /></div>)}<div><label className="block text-sm font-medium text-gray-600">Model Máy</label><input type="text" name="deviceModel" value={formData.deviceModel} onChange={handleChange} className={formInputStyle} required /></div><div><label className="block text-sm font-medium text-gray-600">IMEI / Serial</label><input type="text" name="deviceSerial" value={formData.deviceSerial} onChange={handleChange} className={formInputStyle} required /></div><div><label className="block text-sm font-medium text-gray-600">Mật khẩu màn hình</label><input type="text" name="devicePassword" value={formData.devicePassword} onChange={handleChange} className={formInputStyle} /></div></div></fieldset>
                            <fieldset className="border rounded-md p-4"><legend className="text-lg font-semibold px-2 text-gray-700">Tình Trạng & Vấn Đề</legend><div className="grid grid-cols-1 gap-4"><div><label className="block text-sm font-medium text-gray-600">Tình trạng máy khi nhận</label><textarea name="initialCondition" value={formData.initialCondition} onChange={handleChange} rows="2" className={formInputStyle} placeholder="Ví dụ: Trầy xước nhẹ ở góc, màn hình bị nứt..."></textarea></div><div><label className="block text-sm font-medium text-gray-600">Vấn đề khách báo</label><textarea name="reportedProblem" value={formData.reportedProblem} onChange={handleChange} rows="2" className={formInputStyle} placeholder="Ví dụ: Không lên nguồn, màn hình cảm ứng không nhạy..." required></textarea></div><div><label className="block text-sm font-medium text-gray-600">Chẩn đoán & Xử lý (Nội bộ)</label><textarea name="diagnosis" value={formData.diagnosis} onChange={handleChange} rows="2" className={formInputStyle} placeholder="Ghi chú của kỹ thuật viên..."></textarea></div><div className="grid grid-cols-2 gap-4"><div><label className="block text-sm font-medium text-gray-600">Giá dự kiến</label><input type="text" name="estimatedCost" value={formData.estimatedCost} onChange={handleChange} className={formInputStyle} placeholder="0" /></div><div><label className="block text-sm font-medium text-gray-600">Thời gian hẹn trả</label><input type="text" name="completionTime" value={formData.completionTime} onChange={handleChange} className={formInputStyle} placeholder="VD: 3-5 ngày, 17h ngày 25/12..." /></div></div></div></fieldset>
                            <fieldset className="border rounded-md p-4"><legend className="text-lg font-semibold px-2 text-gray-700">Bảo hành</legend><div className="space-y-2"><div className="flex items-center"><input id="isWarranty" name="isWarranty" type="checkbox" checked={formData.isWarranty} onChange={handleChange} className="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" /><label htmlFor="isWarranty" className="ml-2 block text-sm text-gray-900">Đây là phiếu bảo hành</label></div>{formData.isWarranty && (<div><label className="block text-sm font-medium text-gray-600">Mã hóa đơn/phiếu gốc</label><input type="text" name="originalInvoiceId" value={formData.originalInvoiceId} onChange={handleChange} className={formInputStyle} placeholder="Nhập mã hóa đơn gốc..." required /></div>)}</div></fieldset>
                            <div className="flex justify-end pt-4 space-x-2"><button type="button" onClick={onClose} className="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Hủy</button><button type="submit" className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Lưu</button></div>
                        </form>
                    </div>
                </div>
            );
        };

        // --- Printable Content Components ---
        const ReceiptContent = ({ order }) => {
            const getFormattedDate = (date) => {
                if (!date) return 'N/A';
                const d = date.toDate ? date.toDate() : new Date(date);
                return d.toLocaleString('vi-VN');
            };
            return (
                <div className="p-8 text-gray-800 text-sm">
                    <div className="text-center mb-8">
                        <h1 className="text-2xl font-bold">TRUNG TÂM DỊCH VỤ VÀ PHÁT TRIỂN CÔNG NGHỆ ĐIỆN TỬ HÙNG NGỌC</h1>
                        <p className="text-sm">Địa chỉ: Đối diện Trường Mầm Non Phương Canh, Tổ 8 Tu Hoàng, Xuân Phương, Hà Nội </p>
                        <p className="text-sm">Điện thoại: 094.632.8386</p>
                    </div>
                    <h2 className="text-xl font-bold text-center mb-6">{order.isWarranty ? 'PHIẾU BẢO HÀNH' : 'PHIẾU NHẬN MÁY'}</h2>
                    <div className="flex justify-between items-start mb-4">
                        <div>
                            <p><strong>Khách hàng:</strong> {order.customerName}</p>
                            <p><strong>Điện thoại:</strong> {order.customerPhone}</p>
                        </div>
                        <div className="text-right">
                            <p><strong>Mã Phiếu:</strong> #{order.id.slice(0, 8).toUpperCase()}</p>
                            <p><strong>Ngày giờ nhận:</strong> {getFormattedDate(order.createdAt)}</p>
                        </div>
                    </div>
                    {order.isWarranty && order.originalInvoiceId && (
                        <div className="mb-4">
                            <p><strong>Mã HĐ Gốc (Bảo hành):</strong> {order.originalInvoiceId}</p>
                        </div>
                    )}
                    <div className="border-t border-b py-4 my-4">
                        <h3 className="font-bold mb-2">THÔNG TIN THIẾT BỊ</h3>
                        <p><strong>Loại máy:</strong> {order.deviceType}</p>
                        <p><strong>Model:</strong> {order.deviceModel}</p>
                        <p><strong>Số Serial/IMEI:</strong> {order.deviceSerial}</p>
                    </div>
                    <div className="border-b py-4 my-4">
                        <h3 className="font-bold mb-2">TÌNH TRẠNG & YÊU CẦU</h3>
                        <p><strong>Tình trạng khi nhận:</strong> {order.initialCondition || 'Không có ghi chú'}</p>
                        <p><strong>Vấn đề khách báo:</strong> {order.reportedProblem}</p>
                    </div>
                    <div className="border-b py-4 my-4">
                        <h3 className="font-bold mb-2">CHẨN ĐOÁN & CHI PHÍ DỰ KIẾN</h3>
                        <p><strong>Chẩn đoán của KTV:</strong> {order.diagnosis || 'Sẽ cập nhật sau'}</p>
                        <p><strong>Chi phí dự kiến:</strong> {order.estimatedCost > 0 ? `${formatNumber(order.estimatedCost)} đ` : 'Sẽ báo sau'}</p>
                        <p><strong>Thời gian hẹn trả:</strong> {order.completionTime || 'Sẽ báo sau'}</p>
                    </div>
                    <div className="mt-6 text-xs text-gray-600">
                        <p className="font-bold">Điều khoản:</p>
                        <ul className="list-disc list-inside space-y-1">
                            <li>Cửa hàng không chịu trách nhiệm về dữ liệu cá nhân của khách hàng.</li>
                            <li>Quý khách vui lòng nhận lại máy trong vòng 30 ngày kể từ ngày hẹn.</li>
                            <li>Phiếu này có giá trị thay cho giấy biên nhận.</li>
                        </ul>
                    </div>
                    <div className="flex justify-between mt-16">
                        <div>
                            <p className="font-bold">Chữ ký khách hàng</p>
                            <p className="mt-12">(Ký và ghi rõ họ tên)</p>
                        </div>
                        <div>
                            <p className="font-bold">Chữ ký nhân viên</p>
                            <p className="mt-12">(Ký và ghi rõ họ tên)</p>
                        </div>
                    </div>
                </div>
            );
        };

        const InvoiceContent = ({ invoice }) => {
            if (!invoice) return null;
            return (
                <div className="p-8 text-gray-800 text-sm">
                    <div className="text-center mb-8">
                        <h1 className="text-2xl font-bold">TRUNG TÂM DỊCH VỤ VÀ PHÁT TRIỂN CÔNG NGHỆ ĐIỆN TỬ HÙNG NGỌC</h1>
                        <p className="text-sm">Đối diện Trường Mầm Non Phương Canh, Tổ 8 Tu Hoàng, Xuân Phương, Hà Nội</p>
                        <p className="text-sm">Điện thoại: 094.632.8386</p>
                    </div>
                    <h2 className="text-xl font-bold text-center mb-6">HÓA ĐƠN THANH TOÁN</h2>
                    <div className="grid grid-cols-2 gap-4 mb-4 text-sm">
                        <div><p><strong>Khách hàng:</strong> {invoice.customerName}</p><p><strong>Điện thoại:</strong> {invoice.customerPhone}</p></div>
                        <div className="text-right"><p><strong>Số HĐ:</strong> #{invoice.id.slice(0, 8).toUpperCase()}</p><p><strong>Ngày:</strong> {invoice.createdAt?.toDate().toLocaleDateString('vi-VN')}</p></div>
                    </div>
                    <table className="min-w-full divide-y divide-gray-300 mb-4">
                        <thead className="bg-gray-100"><tr><th className="px-4 py-2 text-left text-sm font-semibold">STT</th><th className="px-4 py-2 text-left text-sm font-semibold">Tên mục</th><th className="px-4 py-2 text-center text-sm font-semibold">SL</th><th className="px-4 py-2 text-right text-sm font-semibold">Đơn giá</th><th className="px-4 py-2 text-right text-sm font-semibold">Thành tiền</th></tr></thead>
                        <tbody>{invoice.items.map((item, index) => (<tr key={item.id} className="border-b"><td className="px-4 py-2">{index + 1}</td><td className="px-4 py-2">{item.name}</td><td className="px-4 py-2 text-center">{item.quantity}</td><td className="px-4 py-2 text-right">{item.price.toLocaleString('vi-VN')} đ</td><td className="px-4 py-2 text-right">{(item.price * item.quantity).toLocaleString('vi-VN')} đ</td></tr>))}</tbody>
                    </table>
                    <div className="text-right text-lg font-bold mb-8">Thành tiền: {invoice.total.toLocaleString('vi-VN')} đ</div>
                    <div className="text-center text-sm text-gray-600">
                        <p>Cảm ơn quý khách và hẹn gặp lại! </p>
                        <p>Hóa đơn có giá trị kiêm phiếu bảo hành sản phẩm 01 tháng</p>
                    </div>
                </div>
            );
        };

        const InventoryContent = ({ parts }) => (
            <div className="p-8 text-gray-800 text-sm">
                <div className="text-center mb-8">
                    <h1 className="text-2xl font-bold">TRUNG TÂM DỊCH VỤ VÀ PHÁT TRIỂN CÔNG NGHỆ ĐIỆN TỬ HÙNG NGỌC</h1>
                    <p className="text-sm">Ngày in: {new Date().toLocaleDateString('vi-VN')}</p>
                </div>
                <h2 className="text-xl font-bold text-center mb-6">BÁO CÁO TỒN KHO LINH KIỆN</h2>
                <table className="min-w-full divide-y divide-gray-300 mb-4">
                    <thead className="bg-gray-100">
                        <tr>
                            <th className="px-4 py-2 text-left text-sm font-semibold">STT</th>
                            <th className="px-4 py-2 text-left text-sm font-semibold">Tên Linh kiện</th>
                            <th className="px-4 py-2 text-left text-sm font-semibold">Vị trí</th>
                            <th className="px-4 py-2 text-right text-sm font-semibold">Số lượng Tồn</th>
                            <th className="px-4 py-2 text-right text-sm font-semibold">Giá Nhập</th>
                            <th className="px-4 py-2 text-right text-sm font-semibold">Giá Bán</th>
                        </tr>
                    </thead>
                    <tbody>
                        {parts.map((part, index) => (
                            <tr key={part.id} className="border-b">
                                <td className="px-4 py-2">{index + 1}</td>
                                <td className="px-4 py-2">{part.partName}</td>
                                <td className="px-4 py-2">{part.location || ''}</td>
                                <td className="px-4 py-2 text-right">{part.stockQuantity}</td>
                                <td className="px-4 py-2 text-right">{part.importPrice.toLocaleString('vi-VN')} đ</td>
                                <td className="px-4 py-2 text-right">{part.salePrice.toLocaleString('vi-VN')} đ</td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>
        );

        const PartPriceListContent = ({ parts }) => (
            <div className="p-8 text-gray-800 text-sm">
                <div className="text-center mb-8">
                    <h1 className="text-2xl font-bold">TRUNG TÂM DỊCH VỤ VÀ PHÁT TRIỂN CÔNG NGHỆ ĐIỆN TỬ HÙNG NGỌC</h1>
                    <p className="text-sm">Ngày in: {new Date().toLocaleDateString('vi-VN')}</p>
                </div>
                <h2 className="text-xl font-bold text-center mb-6">BẢNG GIÁ LINH KIỆN</h2>
                <table className="min-w-full divide-y divide-gray-300 mb-4">
                    <thead className="bg-gray-100">
                        <tr>
                            <th className="px-4 py-2 text-left text-sm font-semibold">STT</th>
                            <th className="px-4 py-2 text-left text-sm font-semibold">Tên Linh kiện</th>
                            <th className="px-4 py-2 text-right text-sm font-semibold">Giá Bán</th>
                        </tr>
                    </thead>
                    <tbody>
                        {parts.map((part, index) => (
                            <tr key={part.id} className="border-b">
                                <td className="px-4 py-2">{index + 1}</td>
                                <td className="px-4 py-2">{part.partName}</td>
                                <td className="px-4 py-2 text-right">{part.salePrice.toLocaleString('vi-VN')} đ</td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>
        );

        const ServicePriceListContent = ({ services }) => (
             <div className="p-8 text-gray-800 text-sm">
                <div className="text-center mb-8">
                    <h1 className="text-2xl font-bold">TRUNG TÂM DỊCH VỤ VÀ PHÁT TRIỂN CÔNG NGHỆ ĐIỆN TỬ HÙNG NGỌC</h1>
                    <p className="text-sm">Ngày in: {new Date().toLocaleDateString('vi-VN')}</p>
                </div>
                <h2 className="text-xl font-bold text-center mb-6">BẢNG GIÁ DỊCH VỤ</h2>
                <table className="min-w-full divide-y divide-gray-300 mb-4">
                    <thead className="bg-gray-100">
                        <tr>
                            <th className="px-4 py-2 text-left text-sm font-semibold">STT</th>
                            <th className="px-4 py-2 text-left text-sm font-semibold">Tên Dịch vụ</th>
                            <th className="px-4 py-2 text-right text-sm font-semibold">Tiền công</th>
                        </tr>
                    </thead>
                    <tbody>
                        {services.map((service, index) => (
                            <tr key={service.id} className="border-b">
                                <td className="px-4 py-2">{index + 1}</td>
                                <td className="px-4 py-2">{service.serviceName}</td>
                                <td className="px-4 py-2 text-right">{service.laborCost.toLocaleString('vi-VN')} đ</td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>
        );
        
        const ProductWarrantyContent = ({ invoice, order, warrantyPeriod }) => {
            if (!invoice || !order) return null;

            const getFormattedDate = (date) => {
                if (!date) return 'N/A';
                const d = date.toDate ? date.toDate() : new Date(date);
                return d.toLocaleString('vi-VN');
            };
            
            const getExpiryDate = () => {
                const creationDate = invoice.createdAt?.toDate() ? new Date(invoice.createdAt.toDate()) : new Date();
                const months = parseInt(warrantyPeriod.match(/\d+/)?.[0] || 1, 10);
                creationDate.setMonth(creationDate.getMonth() + months);
                return creationDate.toLocaleDateString('vi-VN');
            }

            return (
                <div className="p-8 text-gray-800 text-sm">
                    <div className="text-center mb-8">
                        <h1 className="text-2xl font-bold">TRUNG TÂM DỊCH VỤ VÀ PHÁT TRIỂN CÔNG NGHỆ ĐIỆN TỬ HÙNG NGỌC</h1>
                        <p className="text-sm">Địa chỉ: Đối diện Trường Mầm Non Phương Canh, Tổ 8 Tu Hoàng, Xuân Phương, Hà Nội</p>
                        <p className="text-sm">Điện thoại: 094.632.8386</p>
                    </div>
                    <h2 className="text-xl font-bold text-center mb-6">PHIẾU BẢO HÀNH SẢN PHẨM</h2>
                    
                    <div className="flex justify-between items-start mb-4 text-sm">
                        <div>
                            <p><strong>Khách hàng:</strong> {invoice.customerName}</p>
                            <p><strong>Điện thoại:</strong> {invoice.customerPhone}</p>
                        </div>
                        <div className="text-right">
                            <p><strong>Số HĐ:</strong> #{invoice.id.slice(0, 8).toUpperCase()}</p>
                            <p><strong>Ngày Sửa:</strong> {getFormattedDate(invoice.createdAt)}</p>
                        </div>
                    </div>

                    <div className="border-t border-b py-4 my-4">
                        <h3 className="font-bold mb-2">THÔNG TIN THIẾT BỊ</h3>
                        <p><strong>Loại máy:</strong> {order.deviceType}</p>
                        <p><strong>Model:</strong> {order.deviceModel}</p>
                        <p><strong>Số Serial/IMEI:</strong> {order.deviceSerial}</p>
                         <p><strong>Tình trạng ban đầu:</strong> {order.initialCondition || 'Không có ghi chú'}</p>
                    </div>

                    <div className="border-b py-4 my-4">
                        <h3 className="font-bold mb-2">NỘI DUNG SỬA CHỮA & THANH TOÁN</h3>
                        <table className="min-w-full text-sm">
                            <tbody>
                                {invoice.items.map((item, index) => (
                                    <tr key={index}>
                                        <td className="py-1">{item.name}</td>
                                        <td className="py-1 text-right">{(item.price * item.quantity).toLocaleString('vi-VN')} đ</td>
                                    </tr>
                                ))}
                            </tbody>
                            <tfoot>
                                <tr className="font-bold border-t">
                                    <td className="py-1">Tổng cộng</td>
                                    <td className="py-1 text-right">{invoice.total.toLocaleString('vi-VN')} đ</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <div className="border-b py-4 my-4">
                        <h3 className="font-bold mb-2">THÔNG TIN BẢO HÀNH</h3>
                        <p><strong>Thời gian bảo hành:</strong> {warrantyPeriod}</p>
                        <p><strong>Ngày hết hạn bảo hành:</strong> {getExpiryDate()}</p>
                    </div>

                    <div className="mt-6 text-xs text-gray-600">
                        <p className="font-bold">Điều khoản bảo hành:</p>
                        <ul className="list-disc list-inside space-y-1">
                            <li>Sản phẩm được bảo hành miễn phí trong thời gian bảo hành đối với các lỗi linh kiện, kỹ thuật do nhà sản xuất hoặc do quá trình sửa chữa của chúng tôi.</li>
                            <li>Chúng tôi không chịu trách nhiệm bảo hành đối với các trường hợp: máy bị rơi, vỡ, va đập, vào nước, thiên tai, hỏa hoạn, hoặc do người dùng tự ý can thiệp, sửa chữa.</li>
                            <li>Không bảo hành các vấn đề về phần mềm, dữ liệu, hoặc các lỗi phát sinh không liên quan đến phần đã sửa chữa.</li>
                            <li>Phiếu bảo hành chỉ có giá trị khi có đầy đủ thông tin và không bị tẩy xóa, sửa chữa.</li>
                        </ul>
                    </div>
                     <div className="flex justify-between mt-16">
                        <div>
                            <p className="font-bold">Chữ ký khách hàng</p>
                            <p className="mt-12">(Ký và ghi rõ họ tên)</p>
                        </div>
                        <div>
                            <p className="font-bold">Chữ ký nhân viên</p>
                            <p className="mt-12">(Ký và ghi rõ họ tên)</p>
                        </div>
                    </div>
                </div>
            );
        };

        const ViewAndPrintModal = ({ isOpen, onClose, children, title }) => {
            const handlePrint = () => {
                const printContainer = document.getElementById('print-container');
                const printRoot = ReactDOM.createRoot(printContainer);
                printRoot.render(children);
                setTimeout(() => {
                    window.print();
                    printRoot.unmount();
                }, 100); // Small delay to ensure content is rendered
            };

            if (!isOpen) return null;

            return ReactDOM.createPortal(
                <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4 no-print">
                    <div className="bg-white rounded-lg shadow-2xl w-full max-w-2xl max-h-[95vh] flex flex-col">
                        <div className="overflow-y-auto">
                            {children}
                        </div>
                        <div className="p-4 border-t mt-auto flex justify-end items-center gap-4">
                            <button onClick={onClose} className="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Đóng</button>
                            <button onClick={handlePrint} className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700"><PrintIcon /> {title}</button>
                        </div>
                    </div>
                </div>,
                document.body
            );
        };

        const ProductWarrantyModal = ({ isOpen, onClose, invoice, db }) => {
            const [order, setOrder] = React.useState(null);
            const [loading, setLoading] = React.useState(true);
            const [error, setError] = React.useState('');
            const [warrantyPeriod, setWarrantyPeriod] = React.useState('1 tháng');
            const appId = React.useMemo(() => typeof __app_id !== 'undefined' ? __app_id : 'default-app-id', []);
            const { doc, getDoc } = window.firebaseFirestore;
            
            React.useEffect(() => {
                if (!isOpen || !db || !invoice?.orderId) {
                    setLoading(false);
                    return;
                }
                
                const fetchOrder = async () => {
                    setLoading(true);
                    setError('');
                    try {
                        const orderRef = doc(db, `artifacts/${appId}/public/data/repairOrders`, invoice.orderId);
                        const orderSnap = await getDoc(orderRef);
                        if (orderSnap.exists()) {
                            setOrder({ id: orderSnap.id, ...orderSnap.data() });
                        } else {
                            setError("Không tìm thấy phiếu sửa chữa gốc.");
                        }
                    } catch (err) {
                        console.error("Lỗi tải phiếu sửa chữa gốc:", err);
                        setError("Lỗi khi tải dữ liệu phiếu gốc.");
                    } finally {
                        setLoading(false);
                    }
                };
                
                fetchOrder();
            }, [isOpen, db, invoice]);

            if (!isOpen) return null;

            return (
                <ViewAndPrintModal
                    isOpen={isOpen}
                    onClose={onClose}
                    title="In Phiếu Bảo Hành"
                >
                    {loading && <div className="p-8 text-center">Đang tải dữ liệu...</div>}
                    {error && <div className="p-8 text-center text-red-500">{error}</div>}
                    {!loading && !error && order && (
                        <div>
                            <div className="p-4 border-b no-print">
                                <label className="block text-sm font-medium text-gray-600">Thời gian bảo hành</label>
                                <input 
                                    type="text"
                                    value={warrantyPeriod}
                                    onChange={(e) => setWarrantyPeriod(e.target.value)}
                                    className={inputStyle}
                                />
                            </div>
                            <ProductWarrantyContent invoice={invoice} order={order} warrantyPeriod={warrantyPeriod} />
                        </div>
                    )}
                </ViewAndPrintModal>
            );
        };

        const CustomerHistoryModal = ({ isOpen, onClose, customer, db }) => {
            const [orders, setOrders] = React.useState([]);
            const [loading, setLoading] = React.useState(false);
            const appId = React.useMemo(() => typeof __app_id !== 'undefined' ? __app_id : 'default-app-id', []);
            const { collection, query, where, getDocs, orderBy } = window.firebaseFirestore;

            React.useEffect(() => {
                if (!isOpen || !customer || !db) { setOrders([]); return; }
                const getHistory = async () => { 
                    setLoading(true);
                    try { 
                        const q = query(collection(db, `artifacts/${appId}/public/data/repairOrders`), where("customerPhone", "==", customer.customerPhone), orderBy("createdAt", "desc"));
                        const querySnapshot = await getDocs(q); 
                        setOrders(querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    } catch (err) { 
                        console.error("Lỗi khi lấy lịch sử sửa chữa:", err); 
                    } finally { 
                        setLoading(false); 
                    } 
                };
                getHistory();
            }, [isOpen, customer, db, appId]);

            if (!isOpen) return null;
            return ( <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4"><div className="bg-white rounded-lg shadow-2xl w-full max-w-3xl max-h-[90vh] flex flex-col"><div className="flex justify-between items-center p-4 border-b"><h2 className="text-xl font-bold text-gray-800">Lịch sử sửa chữa: {customer.customerName}</h2><button onClick={onClose} className="text-gray-500 hover:text-gray-800"><CloseIcon /></button></div><div className="p-6 overflow-y-auto">{loading ? <p>Đang tải...</p> : ( orders.length > 0 ? ( <ul className="space-y-4">{orders.map(order => ( <li key={order.id} className="p-4 border rounded-md bg-gray-50"><p><strong>Ngày nhận:</strong> {order.createdAt?.toDate ? order.createdAt.toDate().toLocaleDateString('vi-VN') : 'N/A'}</p><p><strong>Thiết bị:</strong> {order.deviceType} - {order.deviceModel} ({order.deviceSerial})</p><p><strong>Vấn đề:</strong> {order.reportedProblem}</p><p><strong>Trạng thái:</strong> {order.status}</p></li> ))}</ul> ) : <p>Không có lịch sử.</p> )}</div></div></div> );
        };
        const PartFormModal = ({ isOpen, onClose, onSave, part }) => {
            const [formData, setFormData] = React.useState({ partName: '', location: '', stockQuantity: '', importPrice: '', salePrice: '', lowStockThreshold: '5' });
            React.useEffect(() => { 
                if(isOpen) {
                    if(part) {
                        setFormData({ 
                            ...part,
                            stockQuantity: formatNumber(part.stockQuantity),
                            importPrice: formatNumber(part.importPrice),
                            salePrice: formatNumber(part.salePrice),
                            lowStockThreshold: formatNumber(part.lowStockThreshold),
                        });
                    } else {
                        setFormData({ partName: '', location: '', stockQuantity: '', importPrice: '', salePrice: '', lowStockThreshold: '5' });
                    }
                }
            }, [part, isOpen]);
            if (!isOpen) return null;
            const handleChange = (e) => {
                const { name, value } = e.target;
                if (['stockQuantity', 'importPrice', 'salePrice', 'lowStockThreshold'].includes(name)) {
                    setFormData(prev => ({ ...prev, [name]: formatNumber(value) }));
                } else {
                    setFormData(prev => ({ ...prev, [name]: capitalizeWords(value) }));
                }
            };
            const handleSubmit = (e) => { 
                e.preventDefault(); 
                const dataToSave = {
                    ...formData,
                    stockQuantity: parseFormattedNumber(formData.stockQuantity),
                    importPrice: parseFormattedNumber(formData.importPrice),
                    salePrice: parseFormattedNumber(formData.salePrice),
                    lowStockThreshold: parseFormattedNumber(formData.lowStockThreshold),
                };
                onSave(dataToSave); 
                onClose(); 
            };
            return ( <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4"><div className="bg-white rounded-lg shadow-2xl w-full max-w-lg"><div className="flex justify-between items-center p-4 border-b"><h2 className="text-xl font-bold text-gray-800">{part ? 'Chỉnh sửa Linh kiện' : 'Thêm Linh kiện mới'}</h2><button onClick={onClose} className="text-gray-500 hover:text-gray-800"><CloseIcon /></button></div><form onSubmit={handleSubmit} className="p-6 space-y-4"><div><label className="block text-sm font-medium text-gray-600">Tên Linh kiện</label><input type="text" name="partName" value={formData.partName} onChange={handleChange} className={formInputStyle} required /></div><div><label className="block text-sm font-medium text-gray-600">Vị trí</label><input type="text" name="location" value={formData.location || ''} onChange={handleChange} className={formInputStyle} placeholder="VD: Kệ A, Ngăn 2"/></div><div className="grid grid-cols-2 gap-4"><div><label className="block text-sm font-medium text-gray-600">Số lượng tồn</label><input type="text" name="stockQuantity" value={formData.stockQuantity} onChange={handleChange} className={formInputStyle} placeholder="0" required /></div><div><label className="block text-sm font-medium text-gray-600">Ngưỡng báo hết hàng</label><input type="text" name="lowStockThreshold" value={formData.lowStockThreshold} onChange={handleChange} className={formInputStyle} placeholder="5" required /></div></div><div className="grid grid-cols-2 gap-4"><div><label className="block text-sm font-medium text-gray-600">Giá nhập</label><input type="text" name="importPrice" value={formData.importPrice} onChange={handleChange} className={formInputStyle} placeholder="0" required /></div><div><label className="block text-sm font-medium text-gray-600">Giá bán</label><input type="text" name="salePrice" value={formData.salePrice} onChange={handleChange} className={formInputStyle} placeholder="0" required /></div></div><div className="flex justify-end pt-4 space-x-2"><button type="button" onClick={onClose} className="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Hủy</button><button type="submit" className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Lưu</button></div></form></div></div> );
        };
        const ServiceFormModal = ({ isOpen, onClose, onSave, service }) => {
            const [formData, setFormData] = React.useState({ serviceName: '', laborCost: '' });
            React.useEffect(() => { if(isOpen) setFormData(service ? { ...service, laborCost: formatNumber(service.laborCost) } : { serviceName: '', laborCost: '' }); }, [service, isOpen]);
            if (!isOpen) return null;
            const handleChange = (e) => {
                const { name, value } = e.target;
                if(name === 'laborCost') {
                    setFormData(prev => ({ ...prev, [name]: formatNumber(value) }));
                } else {
                    setFormData(prev => ({ ...prev, [name]: capitalizeWords(value) }));
                }
            };
            const handleSubmit = (e) => { 
                e.preventDefault(); 
                const dataToSave = { ...formData, laborCost: parseFormattedNumber(formData.laborCost) };
                onSave(dataToSave); 
                onClose(); 
            };
            return ( <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4"><div className="bg-white rounded-lg shadow-2xl w-full max-w-lg"><div className="flex justify-between items-center p-4 border-b"><h2 className="text-xl font-bold text-gray-800">{service ? 'Chỉnh sửa Dịch vụ' : 'Thêm Dịch vụ mới'}</h2><button onClick={onClose} className="text-gray-500 hover:text-gray-800"><CloseIcon /></button></div><form onSubmit={handleSubmit} className="p-6 space-y-4"><div><label className="block text-sm font-medium text-gray-600">Tên Dịch vụ</label><input type="text" name="serviceName" value={formData.serviceName} onChange={handleChange} className={formInputStyle} required /></div><div><label className="block text-sm font-medium text-gray-600">Tiền công</label><input type="text" name="laborCost" value={formData.laborCost} onChange={handleChange} className={formInputStyle} placeholder="0" required /></div><div className="flex justify-end pt-4 space-x-2"><button type="button" onClick={onClose} className="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Hủy</button><button type="submit" className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Lưu</button></div></form></div></div> );
        };
        
        const InvoiceModal = ({ isOpen, onClose, order, db, showNotification }) => {
            const [items, setItems] = React.useState([]);
            const [services, setServices] = React.useState([]);
            const [parts, setParts] = React.useState([]);
            const [loading, setLoading] = React.useState(true);
            const appId = React.useMemo(() => typeof __app_id !== 'undefined' ? __app_id : 'default-app-id', []);
            const { collection, getDocs, query, addDoc, doc, updateDoc, serverTimestamp, getDoc, writeBatch } = window.firebaseFirestore;

            React.useEffect(() => {
                if (!isOpen || !db) return;
                const fetchPrerequisites = async () => {
                    try {
                        setLoading(true);
                        const servicesQuery = query(collection(db, `artifacts/${appId}/public/data/services`));
                        const partsQuery = query(collection(db, `artifacts/${appId}/public/data/inventoryParts`));
                        const [servicesSnapshot, partsSnapshot] = await Promise.all([getDocs(servicesQuery), getDocs(partsQuery)]);
                        setServices(servicesSnapshot.docs.map(d => ({ id: d.id, ...d.data() })));
                        setParts(partsSnapshot.docs.map(d => ({ id: d.id, ...d.data() })));
                    } catch (e) {
                        console.error("Lỗi tải dịch vụ/linh kiện:", e);
                        showNotification('Lỗi tải dữ liệu cho hóa đơn.', 'error');
                    } finally {
                        setLoading(false);
                    }
                };
                fetchPrerequisites();
                setItems([]);
            }, [isOpen, db, appId]);

            const addItem = (type, item) => {
                const newItemId = type === 'service' ? `svc_${item.id}` : `prt_${item.id}`;
                setItems(prevItems => {
                    const existingItem = prevItems.find(i => i.id === newItemId);
                    if (existingItem) {
                        if (type === 'part' && existingItem.quantity < item.stockQuantity) {
                            return prevItems.map(i => i.id === newItemId ? { ...i, quantity: i.quantity + 1 } : i);
                        }
                        return prevItems;
                    } else {
                        const newItem = type === 'service' 
                            ? { id: `svc_${item.id}`, name: item.serviceName, price: item.laborCost, type: 'service', quantity: 1 }
                            : { id: `prt_${item.id}`, name: item.partName, price: item.salePrice, type: 'part', partId: item.id, quantity: 1, maxStock: item.stockQuantity };
                        return [...prevItems, newItem];
                    }
                });
            };
            
            const removeItem = (itemId) => setItems(prev => prev.filter(item => item.id !== itemId));
            const total = React.useMemo(() => items.reduce((sum, item) => sum + item.price * (item.quantity || 1), 0), [items]);

            const handleSaveInvoice = async (paymentMethod) => {
                if (!db || !order || items.length === 0) {
                    showNotification('Vui lòng thêm ít nhất một dịch vụ hoặc linh kiện.', 'info');
                    return;
                }
                
                const batch = writeBatch(db);
                const invoiceData = {
                    orderId: order.id, customerName: order.customerName, customerPhone: order.customerPhone,
                    createdAt: serverTimestamp(), items: items, total: total, status: 'paid', paymentMethod: paymentMethod,
                };
                
                try {
                    // 1. Add new invoice
                    const invoiceRef = doc(collection(db, `artifacts/${appId}/public/data/invoices`));
                    batch.set(invoiceRef, invoiceData);

                    // 2. Update order status
                    const orderRef = doc(db, `artifacts/${appId}/public/data/repairOrders`, order.id);
                    batch.update(orderRef, { status: 'Đã trả khách' });

                    // 3. Update inventory stock
                    const partsToUpdate = items.filter(item => item.type === 'part');
                    for (const item of partsToUpdate) {
                        const partRef = doc(db, `artifacts/${appId}/public/data/inventoryParts`, item.partId);
                        const newStock = item.maxStock - item.quantity;
                        batch.update(partRef, { stockQuantity: newStock });
                    }
                    
                    await batch.commit();
                    showNotification("Tạo hóa đơn và thanh toán thành công!", 'success');
                    onClose();

                } catch (e) {
                    console.error("Lỗi lưu hóa đơn:", e);
                    showNotification("Lỗi khi lưu hóa đơn. Giao dịch đã được hủy.", 'error');
                }
            };

            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
                    <div className="bg-white rounded-lg shadow-2xl w-full max-w-4xl max-h-[95vh] flex flex-col">
                        <div className="flex justify-between items-center p-4 border-b">
                            <h2 className="text-xl font-bold text-gray-800">Tạo Hóa Đơn cho Phiếu #{order.id.slice(0, 6)}</h2>
                            <button onClick={onClose} className="text-gray-500 hover:text-gray-800"><CloseIcon /></button>
                        </div>
                        
                        <div className="flex-1 p-6 overflow-y-auto flex flex-col md:flex-row gap-6">
                            {/* Left Column: Invoice Details */}
                            <div className="flex-1 md:w-2/3 flex flex-col">
                                <h3 className="text-lg font-semibold mb-2">Chi tiết Hóa đơn</h3>
                                <div className="flex-grow bg-gray-50 rounded-lg p-4">
                                    {items.length > 0 ? (
                                        <table className="min-w-full text-sm">
                                            <thead className="border-b-2 border-gray-200">
                                                <tr>
                                                    <th className="text-left font-semibold text-gray-600 p-2">Mục</th>
                                                    <th className="text-center font-semibold text-gray-600 p-2">SL</th>
                                                    <th className="text-right font-semibold text-gray-600 p-2">Đơn giá</th>
                                                    <th className="text-right font-semibold text-gray-600 p-2">Thành tiền</th>
                                                    <th className="text-right"></th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {items.map((item) => (
                                                    <tr key={item.id} className="border-b border-gray-100">
                                                        <td className="py-2 px-2">{item.name}</td>
                                                        <td className="py-2 px-2 text-center">{item.quantity}</td>
                                                        <td className="py-2 px-2 text-right">{item.price.toLocaleString('vi-VN')} đ</td>
                                                        <td className="py-2 px-2 text-right font-medium">{(item.price * item.quantity).toLocaleString('vi-VN')} đ</td>
                                                        <td className="py-2 px-2 text-right">
                                                            <button onClick={() => removeItem(item.id)} className="text-red-500 hover:text-red-700 text-xs">Xóa</button>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    ) : (
                                        <div className="flex items-center justify-center h-full text-gray-500 min-h-[200px]">
                                            <p>Chưa có mục nào được thêm vào hóa đơn.</p>
                                        </div>
                                    )}
                                </div>
                                <div className="text-right mt-4 text-2xl font-bold text-slate-800">
                                    Tổng cộng: {total.toLocaleString('vi-VN')} đ
                                </div>
                            </div>

                            {/* Right Column: Add Items */}
                            <div className="md:w-1/3 flex flex-col gap-4">
                                <div>
                                    <h3 className="text-lg font-semibold mb-2">Thêm Dịch vụ</h3>
                                    <div className="max-h-48 md:flex-1 overflow-y-auto border rounded-md p-2 bg-white">
                                        {loading ? <p className="text-xs text-gray-500 p-1.5">Đang tải...</p> : 
                                        services.length > 0 ? services.map(s => (
                                            <button key={s.id} onClick={() => addItem('service', s)} className="block w-full text-left p-1.5 text-sm hover:bg-gray-100 rounded-md">{s.serviceName}</button>
                                        )) : <p className="text-xs text-gray-500 p-1.5">Không có dịch vụ. Vui lòng thêm ở trang Dịch vụ.</p>}
                                    </div>
                                </div>
                                <div>
                                    <h3 className="text-lg font-semibold mb-2">Thêm Linh kiện</h3>
                                    <div className="max-h-48 md:flex-1 overflow-y-auto border rounded-md p-2 bg-white">
                                        {loading ? <p className="text-xs text-gray-500 p-1.5">Đang tải...</p> :
                                        parts.length > 0 ? parts.map(p => (
                                            <button key={p.id} onClick={() => addItem('part', p)} disabled={p.stockQuantity <= 0} className="block w-full text-left p-1.5 text-sm hover:bg-gray-100 rounded-md disabled:opacity-50 disabled:cursor-not-allowed">
                                                {p.partName} <span className="text-gray-400">({p.stockQuantity})</span>
                                            </button>
                                        )) : <p className="text-xs text-gray-500 p-1.5">Không có linh kiện. Vui lòng thêm ở trang Kho.</p>}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div className="p-4 border-t mt-auto flex justify-end items-center gap-4">
                            <span className="font-semibold">Phương thức thanh toán:</span>
                            <button onClick={() => handleSaveInvoice('Tiền mặt')} className="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">Tiền mặt</button>
                            <button onClick={() => handleSaveInvoice('Chuyển khoản')} className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Chuyển khoản</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- PAGES ---
        const PlaceholderComponent = ({ title }) => (<div className="p-8 flex justify-center items-center h-full bg-slate-100"><div className="text-center"><h1 className="text-4xl font-bold text-gray-800 capitalize">{title}</h1><p className="mt-2 text-gray-500">Module đang trong quá trình phát triển.</p><div className="mt-6"><div className="bg-gray-200 h-40 w-full max-w-md mx-auto rounded-lg animate-pulse"></div></div></div></div>);
        const RepairOrdersPage = ({ db, userId, showNotification, userRole }) => {
            const [orders, setOrders] = React.useState([]);
            const [isModalOpen, setIsModalOpen] = React.useState(false);
            const [editingOrder, setEditingOrder] = React.useState(null);
            const [isInvoiceModalOpen, setIsInvoiceModalOpen] = React.useState(false);
            const [selectedOrderForInvoice, setSelectedOrderForInvoice] = React.useState(null);
            const [receiptToPrint, setReceiptToPrint] = React.useState(null);
            const [loading, setLoading] = React.useState(true);
            const [error, setError] = React.useState(null);
            const [filterStatus, setFilterStatus] = React.useState('Tất cả');
            const repairStatuses = React.useMemo(() => ["Mới nhận", "Đang kiểm tra", "Chờ báo giá", "Chờ linh kiện", "Đang sửa", "Sửa xong, chờ QC", "Sẵn sàng trả khách", "Đã trả khách"], []);
            const appId = React.useMemo(() => typeof __app_id !== 'undefined' ? __app_id : 'default-app-id', []);
            const { collection, query, onSnapshot, doc, updateDoc, addDoc, serverTimestamp, setDoc } = window.firebaseFirestore;
            const isUserAdmin = userRole === 'admin';

            React.useEffect(() => {
                if (!userId || !db) { setLoading(false); return; }
                setLoading(true);
                setError(null);
                const q = query(collection(db, `artifacts/${appId}/public/data/repairOrders`));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const fetchedOrders = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    fetchedOrders.sort((a, b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0));
                    setOrders(fetchedOrders);
                    setLoading(false);
                }, (err) => {
                    console.error("Lỗi tải phiếu sửa chữa: ", err);
                    setError("Không thể tải danh sách phiếu sửa chữa.");
                    setLoading(false);
                });
                return () => unsubscribe();
            }, [userId, db, appId]);
            
            const handleSaveOrder = React.useCallback(async (orderData) => {
                if (!userId || !db) return;
                const { id, ...dataToSave } = orderData;
                
                dataToSave.estimatedCost = parseFormattedNumber(dataToSave.estimatedCost);

                if (dataToSave.deviceType === 'Khác') { dataToSave.deviceType = dataToSave.otherDeviceType || 'Khác (không rõ)'; }
                delete dataToSave.otherDeviceType;
                try {
                    const repairOrdersCollection = collection(db, `artifacts/${appId}/public/data/repairOrders`);
                    if (id) {
                        await updateDoc(doc(repairOrdersCollection, id), dataToSave);
                        showNotification('Cập nhật phiếu thành công!', 'success');
                    } else {
                        const newDoc = await addDoc(repairOrdersCollection, { ...dataToSave, status: 'Mới nhận', createdAt: serverTimestamp(), createdBy: userId });
                        await updateDoc(newDoc, { orderId: newDoc.id });
                        setReceiptToPrint({ ...dataToSave, id: newDoc.id, createdAt: new Date() });
                        showNotification('Tạo phiếu mới thành công!', 'success');
                    }
                    const customerDocRef = doc(db, `artifacts/${appId}/public/data/customers`, dataToSave.customerPhone);
                    await setDoc(customerDocRef, { customerName: dataToSave.customerName, customerPhone: dataToSave.customerPhone, customerAddress: dataToSave.customerAddress, lastSeen: serverTimestamp() }, { merge: true });
                } catch (e) { console.error("Lỗi: ", e); showNotification("Lỗi khi lưu phiếu.", 'error'); }
            }, [userId, db, appId, showNotification]);
            
            const handleStatusChange = React.useCallback(async (orderId, newStatus) => {
                if (!userId || !db) return;
                try { 
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/repairOrders`, orderId), { status: newStatus }); 
                    showNotification('Cập nhật trạng thái thành công.', 'success');
                } catch(e) { console.error("Lỗi:", e); showNotification("Lỗi cập nhật trạng thái.", 'error'); }
            }, [userId, db, appId, showNotification]);

            const handleOpenInvoiceModal = (order) => { setSelectedOrderForInvoice(order); setIsInvoiceModalOpen(true); };
            const handleOpenEditModal = (order) => { setEditingOrder(order); setIsModalOpen(true); };
            const handleOpenCreateModal = () => { setEditingOrder(null); setIsModalOpen(true); };
            const getStatusColor = React.useCallback((status) => {
                const colors = { 'Mới nhận': 'bg-blue-100 text-blue-800', 'Đang kiểm tra': 'bg-yellow-100 text-yellow-800', 'Chờ báo giá': 'bg-orange-100 text-orange-800', 'Chờ linh kiện': 'bg-purple-100 text-purple-800', 'Đang sửa': 'bg-indigo-100 text-indigo-800', 'Sửa xong, chờ QC': 'bg-teal-100 text-teal-800', 'Sẵn sàng trả khách': 'bg-green-100 text-green-800', 'Đã trả khách': 'bg-gray-100 text-gray-800' };
                return colors[status] || 'bg-gray-100 text-gray-500';
            }, []);
            const filteredOrders = React.useMemo(() => filterStatus === 'Tất cả' ? orders : orders.filter(order => order.status === filterStatus), [orders, filterStatus]);
            
            const dataToExport = React.useMemo(() => orders.map(o => ({
                'MaPhieu': o.id, 
                'TenKhachHang': o.customerName, 
                'SoDienThoai': o.customerPhone, 
                'LoaiThietBi': o.deviceType, 
                'Model': o.deviceModel, 
                'VanDeKhachBao': o.reportedProblem,
                'ChanDoan': o.diagnosis,
                'ChiPhiDuKien': o.estimatedCost,
                'BaoHanh': o.isWarranty ? 'Có' : 'Không',
                'MaHDGoc': o.originalInvoiceId,
                'TrangThai': o.status, 
                'NgayNhan': o.createdAt
            })), [orders]);

            return ( <div className="p-4 md:p-6 lg:p-8 bg-slate-100 min-h-full"><div className="flex flex-col md:flex-row justify-between items-center mb-6 gap-4"><h1 className="text-2xl md:text-3xl font-bold text-gray-800">Quản lý Sửa chữa</h1><div className="flex gap-2"><button onClick={() => exportToCSV(dataToExport, 'danh-sach-sua-chua.csv', showNotification)} className="flex items-center gap-2 px-4 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700"><DownloadIcon />Xuất File</button><button onClick={handleOpenCreateModal} className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700"><PlusIcon />Tạo Phiếu Mới</button></div></div><div className="mb-4"><label htmlFor="statusFilter" className="block text-sm font-medium text-gray-700 mb-1">Lọc theo trạng thái:</label><select id="statusFilter" value={filterStatus} onChange={(e) => setFilterStatus(e.target.value)} className={inputStyle + ' max-w-xs'}><option>Tất cả</option>{repairStatuses.map(status => <option key={status} value={status}>{status}</option>)}</select></div>{loading ? <p className="text-center py-10">Đang tải...</p> : error ? <p className="text-center py-10 text-red-500">{error}</p> : (<div className="bg-white rounded-lg shadow overflow-x-auto"><table className="min-w-full divide-y divide-gray-200"><thead className="bg-gray-50"><tr><th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Khách Hàng</th><th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Thiết Bị</th><th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vấn Đề</th><th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Chẩn đoán / Chi phí</th><th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ngày Nhận</th><th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Trạng Thái</th><th scope="col" className="relative px-6 py-3"></th></tr></thead><tbody className="bg-white divide-y divide-gray-200">{filteredOrders.length > 0 ? filteredOrders.map(order => (<tr key={order.id} className="hover:bg-gray-50"><td className="px-6 py-4 align-top whitespace-normal"><div className="text-sm font-medium text-gray-900">{order.customerName}</div><div className="text-sm text-gray-500">{order.customerPhone}</div></td><td className="px-6 py-4 align-top whitespace-normal"><div className="text-sm text-gray-900">{order.deviceModel}</div><div className="text-sm text-gray-500">{order.deviceType}</div></td><td className="px-6 py-4 align-top max-w-xs whitespace-normal"><p className="text-sm text-gray-900">{order.reportedProblem}</p></td><td className="px-6 py-4 align-top max-w-xs whitespace-normal"><p className="text-sm text-gray-900">{order.diagnosis || ''}</p>{order.estimatedCost > 0 && <p className="text-sm text-green-600 font-medium">{formatNumber(order.estimatedCost)} đ</p>}</td><td className="px-6 py-4 align-top whitespace-nowrap text-sm text-gray-500">{order.createdAt?.toDate ? order.createdAt.toDate().toLocaleDateString('vi-VN') : 'N/A'}</td><td className="px-6 py-4 align-top whitespace-nowrap"><div className="flex items-center gap-2"><select value={order.status} onChange={(e) => handleStatusChange(order.id, e.target.value)} className={`text-xs font-semibold rounded-full px-3 py-1 border-0 focus:ring-2 focus:ring-offset-1 ${getStatusColor(order.status)}`} style={{appearance: 'none', WebkitAppearance: 'none'}}>{repairStatuses.map(status => <option key={status} value={status}>{status}</option>)}</select>{order.isWarranty && <span title="Phiếu bảo hành" className="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-pink-100 text-pink-800"><WarrantyIcon/></span>}</div></td><td className="px-6 py-4 align-top whitespace-nowrap text-right text-sm font-medium space-x-2"><button onClick={() => setReceiptToPrint(order)} className="text-gray-500 hover:text-gray-800" title="In Phiếu hẹn"><PrintIcon /></button>{isUserAdmin && <button onClick={() => handleOpenEditModal(order)} className="text-indigo-600 hover:text-indigo-900"><EditIcon /></button>}{order.status === 'Sẵn sàng trả khách' && (<button onClick={() => handleOpenInvoiceModal(order)} className="text-green-600 hover:text-green-900">Tạo Hóa đơn</button>)}</td></tr>)) : (<tr><td colSpan="7" className="px-6 py-4 text-center text-gray-500">Không có phiếu sửa chữa nào.</td></tr>)}</tbody></table></div>)}<NewOrderModal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} onSave={handleSaveOrder} orderToEdit={editingOrder} /><InvoiceModal isOpen={isInvoiceModalOpen} onClose={() => setIsInvoiceModalOpen(false)} order={selectedOrderForInvoice} db={db} showNotification={showNotification} /><ViewAndPrintModal isOpen={!!receiptToPrint} onClose={() => setReceiptToPrint(null)} title={receiptToPrint?.isWarranty ? "In Phiếu Bảo Hành" : "In Phiếu Nhận Máy"}><ReceiptContent order={receiptToPrint} /></ViewAndPrintModal></div>);
        };
        const CustomersPage = ({ db, userId, showNotification }) => {
            const [customers, setCustomers] = React.useState([]); const [loading, setLoading] = React.useState(true); const [error, setError] = React.useState(null); const [searchTerm, setSearchTerm] = React.useState(""); const [selectedCustomer, setSelectedCustomer] = React.useState(null); const [isHistoryModalOpen, setIsHistoryModalOpen] = React.useState(false);
            const appId = React.useMemo(() => typeof __app_id !== 'undefined' ? __app_id : 'default-app-id', []);
            const { collection, query, onSnapshot } = window.firebaseFirestore;

            React.useEffect(() => {
                if (!userId || !db) { setLoading(false); return; } setLoading(true);
                const q = query(collection(db, `artifacts/${appId}/public/data/customers`));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const fetchedCustomers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    fetchedCustomers.sort((a,b) => (b.lastSeen?.toDate() || 0) - (a.lastSeen?.toDate() || 0));
                    setCustomers(fetchedCustomers);
                    setLoading(false);
                }, (err) => {
                    console.error("Lỗi tải khách hàng:", err);
                    setError("Không thể tải danh sách khách hàng.");
                    setLoading(false);
                });
                return () => unsubscribe();
            }, [userId, db, appId]);
            const handleViewHistory = (customer) => { setSelectedCustomer(customer); setIsHistoryModalOpen(true); };
            const filteredCustomers = React.useMemo(() => customers.filter(c => c.customerName?.toLowerCase().includes(searchTerm.toLowerCase()) || c.customerPhone?.includes(searchTerm)), [customers, searchTerm]);
            return ( <div className="p-4 md:p-6 lg:p-8 bg-slate-100 min-h-full"><div className="flex flex-col md:flex-row justify-between items-center mb-6 gap-4"><h1 className="text-2xl md:text-3xl font-bold text-gray-800">Quản lý Khách hàng</h1><button onClick={() => exportToCSV(customers, 'danh-sach-khach-hang.csv', showNotification)} className="flex items-center gap-2 px-4 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700"><DownloadIcon />Xuất File</button></div><div className="mb-4"><div className="relative"><span className="absolute inset-y-0 left-0 flex items-center pl-3 text-slate-400"><SearchIcon /></span><input type="text" placeholder="Tìm kiếm khách hàng..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className={inputStyle + " pl-10 max-w-sm"}/></div></div>{loading ? <p className="text-center py-10">Đang tải...</p> : error ? <p className="text-center py-10 text-red-500">{error}</p> : (<div className="bg-white rounded-lg shadow overflow-x-auto"><table className="min-w-full divide-y divide-gray-200"><thead className="bg-gray-50"><tr><th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tên</th><th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">SĐT</th><th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Địa Chỉ</th><th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lần cuối ghé</th><th scope="col" className="relative px-6 py-3"><span className="sr-only">Hành động</span></th></tr></thead><tbody className="bg-white divide-y divide-gray-200">{filteredCustomers.length > 0 ? filteredCustomers.map(customer => (<tr key={customer.id} className="hover:bg-gray-50"><td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{customer.customerName}</td><td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{customer.customerPhone}</td><td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{customer.customerAddress || 'N/A'}</td><td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{customer.lastSeen?.toDate ? customer.lastSeen.toDate().toLocaleDateString('vi-VN') : 'N/A'}</td><td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium"><button onClick={() => handleViewHistory(customer)} className="text-indigo-600 hover:text-indigo-900 inline-flex items-center gap-1"><HistoryIcon /> Xem Lịch sử</button></td></tr>)) : (<tr><td colSpan="5" className="px-6 py-4 text-center text-gray-500">Không tìm thấy khách hàng.</td></tr>)}</tbody></table></div>)}<CustomerHistoryModal isOpen={isHistoryModalOpen} onClose={() => setIsHistoryModalOpen(false)} customer={selectedCustomer} db={db} /></div> );
        };
        const InventoryPage = ({ db, userId, showNotification, userRole }) => {
            const [parts, setParts] = React.useState([]); const [loading, setLoading] = React.useState(true); const [error, setError] = React.useState(null); const [searchTerm, setSearchTerm] = React.useState(""); const [isModalOpen, setIsModalOpen] = React.useState(false); const [editingPart, setEditingPart] = React.useState(null); const [isPrintModalOpen, setIsPrintModalOpen] = React.useState(false); const [isPriceListPrintModalOpen, setIsPriceListPrintModalOpen] = React.useState(false);
            const [confirmState, setConfirmState] = React.useState({ isOpen: false, item: null });
            const appId = React.useMemo(() => typeof __app_id !== 'undefined' ? __app_id : 'default-app-id', []);
            const { collection, query, onSnapshot, addDoc, updateDoc, doc, deleteDoc } = window.firebaseFirestore;
            const isUserAdmin = userRole === 'admin';

            React.useEffect(() => {
                if (!userId || !db) { setLoading(false); return; } setLoading(true);
                const q = query(collection(db, `artifacts/${appId}/public/data/inventoryParts`));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const fetchedParts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    fetchedParts.sort((a, b) => a.partName.localeCompare(b.partName));
                    setParts(fetchedParts);
                    setLoading(false);
                }, (err) => {
                    console.error("Lỗi tải kho:", err);
                    setError("Không thể tải dữ liệu kho.");
                    setLoading(false);
                });
                return () => unsubscribe();
            }, [userId, db, appId]);

            const handleSavePart = React.useCallback(async (partData) => {
                if (!userId || !db) return;
                const { id, ...dataToSave } = partData;
                try {
                    const partsCollection = collection(db, `artifacts/${appId}/public/data/inventoryParts`);
                    if (id) { 
                        await updateDoc(doc(partsCollection, id), dataToSave); 
                        showNotification('Cập nhật linh kiện thành công!', 'success');
                    } else { 
                        await addDoc(partsCollection, dataToSave); 
                        showNotification('Thêm linh kiện mới thành công!', 'success');
                    }
                } catch (e) { console.error("Lỗi:", e); showNotification("Lỗi khi lưu linh kiện.", 'error'); }
            }, [userId, db, appId, showNotification]);
            
            const handleDeletePart = (part) => setConfirmState({ isOpen: true, item: part });
            const confirmDelete = React.useCallback(async () => {
                if (!userId || !db || !confirmState.item) return;
                try { 
                    await deleteDoc(doc(db, `artifacts/${appId}/public/data/inventoryParts`, confirmState.item.id));
                    showNotification(`Đã xóa linh kiện "${confirmState.item.partName}".`, 'success');
                } catch (e) { console.error("Lỗi:", e); showNotification("Lỗi khi xóa linh kiện.", 'error'); }
                finally { setConfirmState({ isOpen: false, item: null }); }
            }, [userId, db, appId, confirmState.item, showNotification]);
            
            const openModalToAdd = () => { setEditingPart(null); setIsModalOpen(true); };
            const openModalToEdit = (part) => { setEditingPart(part); setIsModalOpen(true); };
            const filteredParts = React.useMemo(() => parts.filter(p => p.partName?.toLowerCase().includes(searchTerm.toLowerCase())), [parts, searchTerm]);

            return ( <div className="p-4 md:p-6 lg:p-8 bg-slate-100 min-h-full"><div className="flex flex-col md:flex-row justify-between items-center mb-6 gap-4"><h1 className="text-2xl md:text-3xl font-bold text-gray-800">Quản lý Kho Linh kiện</h1><div className="flex gap-2"><button onClick={() => setIsPrintModalOpen(true)} className="flex items-center gap-2 px-4 py-2 bg-gray-600 text-white font-semibold rounded-lg shadow-md hover:bg-gray-700"><PrintIcon />In Tồn Kho</button><button onClick={() => setIsPriceListPrintModalOpen(true)} className="flex items-center gap-2 px-4 py-2 bg-cyan-600 text-white font-semibold rounded-lg shadow-md hover:bg-cyan-700"><PrintIcon />In Bảng Giá</button>{isUserAdmin && <button onClick={openModalToAdd} className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700"><PlusIcon />Thêm Linh kiện</button>}</div></div><div className="mb-4"><div className="relative"><span className="absolute inset-y-0 left-0 flex items-center pl-3 text-slate-400"><SearchIcon /></span><input type="text" placeholder="Tìm kiếm linh kiện..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className={inputStyle + " pl-10 max-w-sm"}/></div></div>{loading ? <p className="text-center py-10">Đang tải...</p> : error ? <p className="text-center py-10 text-red-500">{error}</p> : (<div className="bg-white rounded-lg shadow overflow-x-auto"><table className="min-w-full divide-y divide-gray-200"><thead className="bg-gray-50"><tr><th className="px-6 py-3 text-left text-xs font-medium uppercase">Tên Linh kiện</th><th className="px-6 py-3 text-left text-xs font-medium uppercase">Vị trí</th><th className="px-6 py-3 text-left text-xs font-medium uppercase">Tồn kho</th><th className="px-6 py-3 text-left text-xs font-medium uppercase">Giá Nhập</th><th className="px-6 py-3 text-left text-xs font-medium uppercase">Giá Bán</th>{isUserAdmin && <th className="relative px-6 py-3"></th>}</tr></thead><tbody className="bg-white divide-y divide-gray-200">{filteredParts.length > 0 ? filteredParts.map(part => (<tr key={part.id} className={part.stockQuantity <= part.lowStockThreshold ? 'bg-yellow-50' : ''}><td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 flex items-center gap-2">{part.partName}{part.stockQuantity <= part.lowStockThreshold && <WarningIcon/>}</td><td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{part.location}</td><td className="px-6 py-4 whitespace-nowrap text-sm">{part.stockQuantity}</td><td className="px-6 py-4 whitespace-nowrap text-sm">{part.importPrice.toLocaleString('vi-VN')} đ</td><td className="px-6 py-4 whitespace-nowrap text-sm">{part.salePrice.toLocaleString('vi-VN')} đ</td>{isUserAdmin && <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-4"><button onClick={() => openModalToEdit(part)} className="text-indigo-600 hover:text-indigo-900"><EditIcon/></button><button onClick={() => handleDeletePart(part)} className="text-red-600 hover:text-red-900"><DeleteIcon/></button></td>}</tr>)) : (<tr><td colSpan={isUserAdmin ? 6 : 5} className="px-6 py-4 text-center text-gray-500">Chưa có linh kiện nào.</td></tr>)}</tbody></table></div>)}<PartFormModal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} onSave={handleSavePart} part={editingPart} /><ViewAndPrintModal isOpen={isPrintModalOpen} onClose={() => setIsPrintModalOpen(false)} title="In Tồn Kho"><InventoryContent parts={parts} /></ViewAndPrintModal><ViewAndPrintModal isOpen={isPriceListPrintModalOpen} onClose={() => setIsPriceListPrintModalOpen(false)} title="In Bảng Giá Linh Kiện"><PartPriceListContent parts={parts} /></ViewAndPrintModal><ConfirmModal isOpen={confirmState.isOpen} onClose={() => setConfirmState({isOpen: false, item: null})} onConfirm={confirmDelete} title="Xác nhận Xóa" message={`Bạn có chắc muốn xóa linh kiện "${confirmState.item?.partName}"?`} /></div> );
        };
        const ServicesPage = ({ db, userId, showNotification, userRole }) => {
            const [services, setServices] = React.useState([]); const [loading, setLoading] = React.useState(true); const [error, setError] = React.useState(null); const [isModalOpen, setIsModalOpen] = React.useState(false); const [editingService, setEditingService] = React.useState(null); const [isPriceListPrintModalOpen, setIsPriceListPrintModalOpen] = React.useState(false);
            const [confirmState, setConfirmState] = React.useState({ isOpen: false, item: null });
            const appId = React.useMemo(() => typeof __app_id !== 'undefined' ? __app_id : 'default-app-id', []);
            const { collection, query, onSnapshot, addDoc, updateDoc, doc, deleteDoc } = window.firebaseFirestore;
            const isUserAdmin = userRole === 'admin';

            React.useEffect(() => {
                if (!userId || !db) { setLoading(false); return; } setLoading(true);
                const q = query(collection(db, `artifacts/${appId}/public/data/services`));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const fetchedServices = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    fetchedServices.sort((a, b) => a.serviceName.localeCompare(b.serviceName));
                    setServices(fetchedServices);
                    setLoading(false);
                }, (err) => {
                    console.error("Lỗi tải dịch vụ:", err);
                    setError("Không thể tải danh sách dịch vụ.");
                    setLoading(false);
                });
                return () => unsubscribe();
            }, [userId, db, appId]);

            const handleSaveService = React.useCallback(async (serviceData) => {
                if (!userId || !db) return;
                const { id, ...dataToSave } = serviceData;
                try {
                    const servicesCollection = collection(db, `artifacts/${appId}/public/data/services`);
                    if (id) { 
                        await updateDoc(doc(servicesCollection, id), dataToSave); 
                        showNotification('Cập nhật dịch vụ thành công!', 'success');
                    } else { 
                        await addDoc(servicesCollection, dataToSave); 
                        showNotification('Thêm dịch vụ mới thành công!', 'success');
                    }
                } catch (e) { console.error("Lỗi:", e); showNotification("Lỗi khi lưu dịch vụ.", 'error'); }
            }, [userId, db, appId, showNotification]);
            
            const handleDeleteService = (service) => setConfirmState({ isOpen: true, item: service });
            const confirmDelete = React.useCallback(async () => {
                if (!userId || !db || !confirmState.item) return;
                try { 
                    await deleteDoc(doc(db, `artifacts/${appId}/public/data/services`, confirmState.item.id)); 
                    showNotification(`Đã xóa dịch vụ "${confirmState.item.serviceName}".`, 'success');
                } catch (e) { console.error("Lỗi:", e); showNotification("Lỗi khi xóa dịch vụ.", 'error'); }
                finally { setConfirmState({ isOpen: false, item: null }); }
            }, [userId, db, appId, confirmState.item, showNotification]);
            
            const openModalToAdd = () => { setEditingService(null); setIsModalOpen(true); };
            const openModalToEdit = (service) => { setEditingService(service); setIsModalOpen(true); };

            return ( <div className="p-4 md:p-6 lg:p-8 bg-slate-100 min-h-full"><div className="flex flex-col md:flex-row justify-between items-center mb-6 gap-4"><h1 className="text-2xl md:text-3xl font-bold text-gray-800">Quản lý Dịch vụ</h1><div className="flex gap-2"><button onClick={() => setIsPriceListPrintModalOpen(true)} className="flex items-center gap-2 px-4 py-2 bg-cyan-600 text-white font-semibold rounded-lg shadow-md hover:bg-cyan-700"><PrintIcon />In Bảng Giá</button>{isUserAdmin && <button onClick={openModalToAdd} className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700"><PlusIcon />Thêm Dịch vụ</button>}</div></div>{loading ? <p className="text-center py-10">Đang tải...</p> : error ? <p className="text-center py-10 text-red-500">{error}</p> : (<div className="bg-white rounded-lg shadow overflow-x-auto"><table className="min-w-full divide-y divide-gray-200"><thead className="bg-gray-50"><tr><th className="px-6 py-3 text-left text-xs font-medium uppercase">Tên Dịch vụ</th><th className="px-6 py-3 text-left text-xs font-medium uppercase">Tiền công</th>{isUserAdmin && <th className="relative px-6 py-3"></th>}</tr></thead><tbody className="bg-white divide-y divide-gray-200">{services.length > 0 ? services.map(service => (<tr key={service.id}><td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{service.serviceName}</td><td className="px-6 py-4 whitespace-nowrap text-sm">{service.laborCost.toLocaleString('vi-VN')} đ</td>{isUserAdmin && <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-4"><button onClick={() => openModalToEdit(service)} className="text-indigo-600 hover:text-indigo-900"><EditIcon/></button><button onClick={() => handleDeleteService(service)} className="text-red-600 hover:text-red-900"><DeleteIcon/></button></td>}</tr>)) : (<tr><td colSpan={isUserAdmin ? 3 : 2} className="px-6 py-4 text-center text-gray-500">Chưa có dịch vụ nào.</td></tr>)}</tbody></table></div>)}<ServiceFormModal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} onSave={handleSaveService} service={editingService} /><ViewAndPrintModal isOpen={isPriceListPrintModalOpen} onClose={() => setIsPriceListPrintModalOpen(false)} title="In Bảng Giá Dịch Vụ"><ServicePriceListContent services={services} /></ViewAndPrintModal><ConfirmModal isOpen={confirmState.isOpen} onClose={() => setConfirmState({isOpen: false, item: null})} onConfirm={confirmDelete} title="Xác nhận Xóa" message={`Bạn có chắc muốn xóa dịch vụ "${confirmState.item?.serviceName}"?`} /></div> );
        };
        const InvoicesPage = ({ db, userId }) => {
            const [invoices, setInvoices] = React.useState([]);
            const [loading, setLoading] = React.useState(true);
            const [error, setError] = React.useState(null);
            const [selectedInvoice, setSelectedInvoice] = React.useState(null);
            const [warrantyInvoice, setWarrantyInvoice] = React.useState(null);
            const appId = React.useMemo(() => typeof __app_id !== 'undefined' ? __app_id : 'default-app-id', []);
            const { collection, query, onSnapshot } = window.firebaseFirestore;

            React.useEffect(() => {
                if (!userId || !db) { setLoading(false); return; }
                setLoading(true);
                setError(null);
                const q = query(collection(db, `artifacts/${appId}/public/data/invoices`));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const fetchedInvoices = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    fetchedInvoices.sort((a,b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0));
                    setInvoices(fetchedInvoices);
                    setLoading(false);
                }, (err) => {
                    console.error("Lỗi tải hóa đơn:", err);
                    setError("Không thể tải danh sách hóa đơn.");
                    setLoading(false);
                });
                return () => unsubscribe();
            }, [userId, db, appId]);

            return ( <div className="p-4 md:p-6 lg:p-8 bg-slate-100 min-h-full"><h1 className="text-2xl md:text-3xl font-bold text-gray-800 mb-6">Lịch sử Hóa đơn</h1>{loading ? <p className="text-center py-10">Đang tải...</p> : error ? <p className="text-center py-10 text-red-500">{error}</p> : (<div className="bg-white rounded-lg shadow overflow-x-auto"><table className="min-w-full divide-y divide-gray-200"><thead className="bg-gray-50"><tr><th className="px-6 py-3 text-left text-xs font-medium uppercase">Ngày tạo</th><th className="px-6 py-3 text-left text-xs font-medium uppercase">Mã Hóa đơn</th><th className="px-6 py-3 text-left text-xs font-medium uppercase">Khách hàng</th><th className="px-6 py-3 text-left text-xs font-medium uppercase">Tổng tiền</th><th className="px-6 py-3 text-left text-xs font-medium uppercase">Thanh toán</th><th className="relative px-6 py-3"></th></tr></thead><tbody className="bg-white divide-y divide-gray-200">{invoices.map(invoice => ( <tr key={invoice.id}><td className="px-6 py-4 whitespace-nowrap text-sm">{invoice.createdAt?.toDate().toLocaleDateString('vi-VN')}</td><td className="px-6 py-4 whitespace-nowrap text-sm font-mono">#{invoice.id.slice(0,6).toUpperCase()}</td><td className="px-6 py-4 whitespace-nowrap text-sm">{invoice.customerName}</td><td className="px-6 py-4 whitespace-nowrap text-sm">{invoice.total.toLocaleString('vi-VN')} đ</td><td className="px-6 py-4 whitespace-nowrap text-sm">{invoice.paymentMethod}</td><td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-4"><button onClick={() => setSelectedInvoice(invoice)} className="text-indigo-600 hover:text-indigo-900">Xem HĐ</button><button onClick={() => setWarrantyInvoice(invoice)} className="text-green-600 hover:text-green-900">In Bảo Hành</button></td></tr> ))}</tbody></table></div>)}<ViewAndPrintModal isOpen={!!selectedInvoice} onClose={() => setSelectedInvoice(null)} title="In Hóa Đơn"><InvoiceContent invoice={selectedInvoice} /></ViewAndPrintModal><ProductWarrantyModal isOpen={!!warrantyInvoice} onClose={() => setWarrantyInvoice(null)} invoice={warrantyInvoice} db={db} /></div> );
        };
        const ReportsPage = ({ db, userId }) => {
            const [stats, setStats] = React.useState({ totalRevenue: 0, repairsCount: 0, newCustomers: 0 });
            const [revenueData, setRevenueData] = React.useState([]);
            const [topServices, setTopServices] = React.useState([]);
            const [recentInvoices, setRecentInvoices] = React.useState([]);
            const [loading, setLoading] = React.useState(true);
            const appId = React.useMemo(() => typeof __app_id !== 'undefined' ? __app_id : 'default-app-id', []);
            const { collection, query, where, getDocs } = window.firebaseFirestore;

            React.useEffect(() => {
                if (!userId || !db) { setLoading(false); return; }
                const fetchAllData = async () => {
                    setLoading(true);
                    try {
                        const today = new Date();
                        const last30Days = new Date(new Date().setDate(today.getDate() - 30));

                        const invoicesQuery = query(collection(db, `artifacts/${appId}/public/data/invoices`), where('createdAt', '>=', last30Days));
                        const repairOrdersQuery = query(collection(db, `artifacts/${appId}/public/data/repairOrders`), where('createdAt', '>=', last30Days));
                        const customersQuery = query(collection(db, `artifacts/${appId}/public/data/customers`), where('lastSeen', '>=', last30Days));
                        
                        const [invoicesSnapshot, ordersSnapshot, customersSnapshot] = await Promise.all([ 
                            getDocs(invoicesQuery), 
                            getDocs(repairOrdersQuery), 
                            getDocs(customersQuery) 
                        ]);
                        
                        const invoices = invoicesSnapshot.docs.map(d => ({...d.data(), id: d.id}));
                        const totalRevenue = invoices.reduce((sum, inv) => sum + inv.total, 0);
                        const repairsCount = ordersSnapshot.size;
                        const newCustomers = customersSnapshot.size;
                        setStats({ totalRevenue, repairsCount, newCustomers });

                        const dailyRevenue = {};
                        for(let i=0; i<30; i++) {
                            const d = new Date();
                            d.setDate(d.getDate() - i);
                            dailyRevenue[d.toLocaleDateString('vi-VN')] = 0;
                        }
                        invoices.forEach(inv => {
                            if(inv.createdAt?.toDate) {
                                const date = inv.createdAt.toDate().toLocaleDateString('vi-VN');
                                if(dailyRevenue[date] !== undefined) { dailyRevenue[date] += inv.total; }
                            }
                        });
                        const chartData = Object.entries(dailyRevenue).map(([date, revenue]) => ({date, revenue})).reverse();
                        setRevenueData(chartData);

                        const itemCounts = {};
                        invoices.forEach(inv => {
                            inv.items.forEach(item => { itemCounts[item.name] = (itemCounts[item.name] || 0) + 1; });
                        });
                        const sortedItems = Object.entries(itemCounts).sort(([,a],[,b]) => b-a).slice(0, 5);
                        setTopServices(sortedItems);

                        setRecentInvoices(invoices.sort((a,b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0)).slice(0, 5));
                    } catch (err) {
                        console.error("Error fetching report data:", err);
                    } finally {
                        setLoading(false);
                    }
                };
                fetchAllData();
            }, [userId, db, appId]);

            const maxRevenue = React.useMemo(() => Math.max(...revenueData.map(d => d.revenue), 1), [revenueData]);
            if (loading) return <p className="p-8 text-center">Đang tải báo cáo...</p>
            return ( <div className="p-4 md:p-6 lg:p-8 bg-slate-100 min-h-full"><h1 className="text-2xl md:text-3xl font-bold text-gray-800 mb-6">Báo cáo & Thống kê</h1><div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6"><div className="bg-white p-6 rounded-lg shadow"><h4 className="text-gray-500 text-sm font-medium">Doanh thu (30 ngày)</h4><p className="text-3xl font-bold text-green-600">{stats.totalRevenue.toLocaleString('vi-VN')} đ</p></div><div className="bg-white p-6 rounded-lg shadow"><h4 className="text-gray-500 text-sm font-medium">Phiếu đã sửa (30 ngày)</h4><p className="text-3xl font-bold text-blue-600">{stats.repairsCount}</p></div><div className="bg-white p-6 rounded-lg shadow"><h4 className="text-gray-500 text-sm font-medium">Khách hàng mới (30 ngày)</h4><p className="text-3xl font-bold text-purple-600">{stats.newCustomers}</p></div></div><div className="grid grid-cols-1 lg:grid-cols-3 gap-6"><div className="lg:col-span-2 bg-white p-6 rounded-lg shadow"><h4 className="font-semibold text-lg mb-4">Doanh thu 30 ngày qua</h4><div className="h-80 flex gap-1 items-end">{revenueData.map(({ date, revenue }) => ( <div key={date} className="flex-1 flex flex-col items-center group"><div className="w-full h-full bg-blue-200 rounded-t-md hover:bg-blue-400 transition-colors" style={{ height: `${(revenue / maxRevenue) * 100}%` }}></div><span className="text-xs text-gray-500 mt-1">{date.split('/')[0]}</span><div className="hidden group-hover:block absolute bg-gray-800 text-white text-xs rounded py-1 px-2 -mt-16 pointer-events-none">{revenue.toLocaleString('vi-VN')} đ</div></div> ))}</div></div><div className="bg-white p-6 rounded-lg shadow"><h4 className="font-semibold text-lg mb-4">Top Dịch vụ & Linh kiện</h4><ul className="space-y-3">{topServices.map(([name, count]) => ( <li key={name} className="flex justify-between items-center text-sm"><span className="text-gray-700">{name}</span><span className="font-bold bg-gray-200 rounded-full px-2 py-0.5">{count}</span></li> ))}</ul></div></div><div className="mt-6 bg-white p-6 rounded-lg shadow"><h4 className="font-semibold text-lg mb-4">Hóa đơn gần đây</h4><div className="overflow-x-auto"><table className="min-w-full"><thead className="text-left text-sm text-gray-500"><tr><th className="py-2">Ngày</th><th className="py-2">Khách hàng</th><th className="py-2 text-right">Tổng tiền</th></tr></thead><tbody>{recentInvoices.map(inv => (<tr key={inv.id} className="border-b"><td className="py-2 text-sm">{inv.createdAt?.toDate().toLocaleDateString('vi-VN')}</td><td className="py-2 text-sm">{inv.customerName}</td><td className="py-2 text-sm text-right font-medium">{inv.total.toLocaleString('vi-VN')} đ</td></tr>))}</tbody></table></div></div></div>);
        };
        const Sidebar = ({ activePage, setActivePage, isOpen, setOpen, handleLogout }) => {
            const navItems = React.useMemo(() => [
                { id: 'reports', label: 'Báo cáo', icon: <ReportIcon /> },
                { id: 'repairs', label: 'Sửa chữa', icon: <RepairIcon /> }, 
                { id: 'invoices', label: 'Hóa đơn', icon: <InvoiceIcon />},
                { id: 'customers', label: 'Khách hàng', icon: <CustomerIcon /> }, 
                { id: 'inventory', label: 'Kho Linh kiện', icon: <InventoryIcon /> }, 
                { id: 'services', label: 'Dịch vụ', icon: <ServiceIcon /> },
            ], []);
            return ( <> <div className={`fixed inset-0 bg-black bg-opacity-50 z-30 lg:hidden transition-opacity ${isOpen ? 'opacity-100' : 'opacity-0 pointer-events-none'}`} onClick={() => setOpen(false)}></div> <div className={`fixed top-0 left-0 h-full w-64 bg-gray-800 text-white flex flex-col shadow-lg z-40 transform transition-transform lg:translate-x-0 ${isOpen ? 'translate-x-0' : '-translate-x-full'}`}><div className="px-6 py-4 flex items-center gap-3 border-b border-gray-700"><RepairIcon /><h2 className="text-lg font-semibold">RepairShop Pro</h2></div><nav className="flex-1 px-4 py-4 space-y-2">{navItems.map(item => (<a key={item.id} href="#" onClick={(e) => { e.preventDefault(); setActivePage(item.id); setOpen(false); }} className={`flex items-center gap-3 px-4 py-2 rounded-md text-sm font-medium transition-colors ${activePage === item.id ? 'bg-gray-900 text-white' : 'text-gray-300 hover:bg-gray-700 hover:text-white'}`}>{item.icon}<span>{item.label}</span></a>))}</nav><div className="px-4 py-4 border-t border-gray-700"><a href="#" onClick={handleLogout} className="flex items-center gap-3 px-4 py-2 rounded-md text-sm font-medium text-gray-300 hover:bg-gray-700 hover:text-white"><LogoutIcon /><span>Đăng xuất</span></a></div></div></> );
        }

        const LoginScreen = ({ onLogin, error }) => {
            const [email, setEmail] = React.useState('');
            const [password, setPassword] = React.useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                onLogin(email, password);
            };

            return (
                <div className="flex items-center justify-center min-h-screen bg-slate-100">
                    <div className="w-full max-w-md p-8 space-y-6 bg-white rounded-lg shadow-md">
                        <div className="text-center">
                            <h1 className="text-2xl font-bold text-gray-800">Đăng nhập</h1>
                            <p className="text-gray-600">Vui lòng đăng nhập để tiếp tục</p>
                        </div>
                        <form onSubmit={handleSubmit} className="space-y-6">
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Email</label>
                                <input type="email" value={email} onChange={e => setEmail(e.target.value)} className={inputStyle} required />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Mật khẩu</label>
                                <input type="password" value={password} onChange={e => setPassword(e.target.value)} className={inputStyle} required />
                            </div>
                            {error && <p className="text-sm text-red-600">{error}</p>}
                            <div>
                                <button type="submit" className="w-full px-4 py-2 font-semibold text-white bg-blue-600 rounded-md hover:bg-blue-700">Đăng nhập</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        function App() {
            const [activePage, setActivePage] = React.useState('reports');
            const [firebase, setFirebase] = React.useState({ db: null, auth: null, user: null, userRole: null, authReady: false, isConfigValid: false, authError: '' });
            const [isSidebarOpen, setSidebarOpen] = React.useState(false);
            const [notification, setNotification] = React.useState({ message: '', type: '' });
            const appId = React.useMemo(() => typeof __app_id !== 'undefined' ? __app_id : 'default-app-id', []);

            React.useEffect(() => {
                const { initializeApp } = window.firebaseApp;
                const { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } = window.firebaseAuth;
                const { getFirestore, doc, getDoc } = window.firebaseFirestore;

                const firebaseConfig = {
                    apiKey: "AIzaSyDhulXkeejEKhmdFYgEeXDGmhyb5tZYrwI",
                    authDomain: "dien-tu-hung-ngoc.firebaseapp.com",
                    projectId: "dien-tu-hung-ngoc",
                    storageBucket: "dien-tu-hung-ngoc.appspot.com",
                    messagingSenderId: "803794710284",
                    appId: "1:803794710284:web:f2ecd59b4ce23e72a46329"
                };

                if (!firebaseConfig || !firebaseConfig.apiKey || firebaseConfig.apiKey.includes("...")) {
                    console.error("Firebase configuration is missing or invalid.");
                    setFirebase(fb => ({ ...fb, authReady: true, isConfigValid: false }));
                    return;
                }

                try {
                    const app = initializeApp(firebaseConfig);
                    const auth = getAuth(app);
                    const db = getFirestore(app);

                    const unsubscribe = onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            const userDocRef = doc(db, `users`, user.uid);
                            const userDocSnap = await getDoc(userDocRef);
                            const userRole = userDocSnap.exists() ? userDocSnap.data().role : 'staff';
                            setFirebase(fb => ({ ...fb, user, userRole, authReady: true, isConfigValid: true, db, auth, authError: '' }));
                        } else {
                            setFirebase(fb => ({ ...fb, user: null, userRole: null, authReady: true, isConfigValid: true, db, auth, authError: '' }));
                        }
                    });
                    
                    return () => unsubscribe();
                } catch (e) {
                    console.error("Failed to initialize Firebase:", e);
                    setFirebase(fb => ({ ...fb, authReady: true, isConfigValid: false }));
                }
            }, []);
            
            const handleLogin = async (email, password) => {
                const { signInWithEmailAndPassword } = window.firebaseAuth;
                try {
                    await signInWithEmailAndPassword(firebase.auth, email, password);
                } catch (error) {
                    console.error("Login failed:", error.code);
                    let message = "Đăng nhập thất bại. Vui lòng thử lại.";
                    if (error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential') {
                        message = "Email hoặc mật khẩu không đúng.";
                    }
                    setFirebase(fb => ({...fb, authError: message}));
                }
            };

            const handleLogout = async () => {
                const { signOut } = window.firebaseAuth;
                await signOut(firebase.auth);
            };
            
            const showNotification = React.useCallback((message, type) => {
                setNotification({ message, type });
            }, []);

            const renderPage = () => {
                if (!firebase.authReady) {
                    return (<div className="flex justify-center items-center h-screen w-screen"><p className="text-lg">Đang khởi tạo...</p></div>);
                }
                if (!firebase.isConfigValid) {
                     return ( <div className="flex justify-center items-center h-screen w-screen bg-red-100 text-red-800 p-4"><div className="text-center"><h1 className="text-2xl font-bold">Lỗi Cấu hình Firebase</h1><p className="mt-2">Không thể kết nối đến cơ sở dữ liệu. Vui lòng kiểm tra lại cấu hình Firebase của bạn.</p></div></div> );
                }
                if (!firebase.user) {
                    return <LoginScreen onLogin={handleLogin} error={firebase.authError} />;
                }

                const pageProps = { db: firebase.db, userId: firebase.user.uid, userRole: firebase.userRole, showNotification };
                switch (activePage) {
                    case 'reports': return <ReportsPage {...pageProps} />;
                    case 'repairs': return <RepairOrdersPage {...pageProps} />;
                    case 'invoices': return <InvoicesPage {...pageProps} />;
                    case 'customers': return <CustomersPage {...pageProps} />;
                    case 'inventory': return <InventoryPage {...pageProps} />;
                    case 'services': return <ServicesPage {...pageProps} />;
                    default: return <ReportsPage {...pageProps} />;
                }
            };
            
            return (
                <div className="min-h-screen bg-slate-100">
                    <Notification message={notification.message} type={notification.type} onDismiss={() => setNotification({ message: '', type: '' })} />
                    {firebase.user && <Sidebar activePage={activePage} setActivePage={setActivePage} isOpen={isSidebarOpen} setOpen={setSidebarOpen} handleLogout={handleLogout} />}
                    <main className={firebase.user ? "lg:ml-64" : ""}>
                         {firebase.user && <div className="lg:hidden p-4 bg-white border-b flex justify-between items-center sticky top-0 z-20">
                            <h2 className="font-bold text-lg">RepairShop Pro</h2>
                            <button onClick={() => setSidebarOpen(true)}><MenuIcon /></button>
                        </div>}
                        {renderPage()}
                    </main>
                </div>
            );
        }
        
        const container = document.getElementById('root');
        if (container) {
            const root = ReactDOM.createRoot(container);
            root.render(<App />);
        } else {
            console.error("Root element not found.");
        }
    </script>
</body>
</html>
